---
title: "All Muni Calculations"
author: "Alea Wilbur"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    df_print: paged
---

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, collapse = TRUE)


library(tidyverse)
library(DBI)
library(data.table)
library(ggspatial)
library(gstat)
library(here)
library(httr)
library(jsonlite)
library(ptaxsim)
library(sf)
library(stars)
library(glue)


#remotes::install_gitlab("ccao-data-science---modeling/packages/ptaxsim")

#renv::install("gitlab::ccao-data-science---modeling/packages/ptaxsim")


# Create the DB connection with the default name expected by PTAXSIM functions
ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), "./ptaxsim.db/ptaxsim-2021.0.4.db")

# has all potential property classes for pins
# downloaded from CCAO gitlab website
## I used this to merge additional information to the pins and class data later on.
class_dict <- read_csv("class_dict.csv")

# summarized exemptions by taxcode made by Michael
# taxcode_exemps <- read_csv("tax_code_exemps_6-20.csv")

options(digits=4, scipen = 999)

```

[Example from gitlab site](https://ccao-data-science---modeling.gitlab.io/packages/ptaxsim/articles/reassessment.html#chicago-ward)

Cook County Assessors Data description page and other [datasets](https://datacatalog.cookcountyil.gov/stories/s/i22y-9sd2).

# Agency Data

Pull all agency names that exist, then use agency numbers associated with MUNI types to pull only the `muni_agency_names` object.

There are 946 unique taxing agencies that existed in 2021.

```{r agency-dt}
# has EAV values, extensions by agency_num
agency_dt <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT *
  FROM agency
  WHERE year = 2021
  "
)
agency_dt
```

This table would be used for the municipality levy in later calculations.

`agency_dt` has all taxing (BUT NOT TIFS!) agencies that existed in 2021 and includes their total taxable base (cty_cook_eav), their levy, taxing rate, binary variables for if a municipality is home rule or not, as well as many other variables. Also currently doesn't have agency_names to go with the agency numbers. That will be merged in shortly.

The table has waaaay too many columns to display all at once. .Click the arrow on the right-hand side of the table to see additional columns that are hidden initially in the display.

-   *Note: Michael warned me about the duplicate muicipalities for something with Evanston and Chicago Public Schools (unsure details) but there does not appear to be any duplicated municipalities using this method? I searched Evanston and Chicago to see which agencies remained and only the correct municipality names were there.*

```{r all-muni-names}
# grabs all unique muni names. Would be needed if creating a loop for calculating all munis
# municipality names and their agency number
muni_agency_names <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE minor_type = 'MUNI'
  OR agency_num = '020060000'  

  "
)

muni_agency_names <- muni_agency_names %>% 
  mutate(first6 = str_sub(agency_num,1,6),
         first5 = str_sub(agency_num,1,5)) %>% 
  select(-minor_type)

# Remember, Cicero only exists as a township, so bring that in later.
# grabs all townships (there are 30)
# all_townships <- DBI::dbGetQuery(
#   ptaxsim_db_conn,
#   "SELECT DISTINCT agency_num, agency_name, major_type, minor_type
#   FROM agency_info
#   WHERE minor_type = 'TOWNSHIP'
#   "
# )
```

Makes a list of ALL taxing agencies, including TIFs, SSAs, etc.

First 5 and 6 digit codes variables are created to nest TIFs and other taxing agencies within the municipality. Still experimental.

There are 1,878 taxing agencies. When grouped by minor_type, there are 133 muni agencies, 639 tif agencies, 30 townships, etc.

```{r all-taxingagency-names}
# all agency names, numbers, and types
# includes TIF and non-TIF agencies
all_taxing_agencies <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  "
)

# create same first 5 and 6 digit codes 
all_taxing_agencies <- all_taxing_agencies %>%
  mutate(first6 = str_sub(agency_num,1,6),
         first5 = str_sub(agency_num,1,5))

all_taxing_agencies
table(all_taxing_agencies$minor_type)
# 133 muni agencies, 639 tif agencies, 30 townships, etc.


table(all_taxing_agencies$major_type)


# none of these are included in their geographic municipality areas automatically. have different agency number code beginnings too. 
all_taxing_agencies %>% 
  filter(major_type == "MISCELLANEOUS") %>% 
  group_by(minor_type) %>%
  summarize(count = n()) 
#all_taxing_agencies %>% filter(minor_type == "FIRE") 
```

All agencies have an agency name, but there isn't an indicator for which municipality each taxing agency is within. Merging the `muni_agency_names` to `all_taxing_agencies` hopefully adds a variable that allows for grouping and summing at the municipality level that includes SSAs, (if we want to do that). Does not work for School districts or other taxing districts which begin with completely different values (e.g. school districts begin with 4)

> When people are saying "the municipality" are they mentally picturing the services provided with property taxes like parks, libraries, schools, etc. Or just the singular taxing agency associated with each municipality that only contains a few goods/services provided by the area? Is this even a good comparison between cities? More thoughts below:

-   Are all libraries paid for library taxing agencies or do some cities just include the cost of a public library as part of their municipal levy? Same for Parks.

Add agency names since those weren't included originally in the table:

```{r all-taxingagency-names2}
all_taxing_agencies <- all_taxing_agencies %>% 
  left_join(muni_agency_names, by = c("first5", "first6")) %>% 
  rename(muni_name =  agency_name.y,
        muni_num = agency_num.y,
        agency_name = agency_name.x,
        agency_num = agency_num.x)



# combine taxing agency names and agency type to data table that has eav and extension values
agency_data <- right_join(agency_dt, all_taxing_agencies) %>% 
  # get rid of unneeded columns to make table outputs smaller
  select(-c(cty_dupage_eav:cty_livingston_eav, lim_numerator, lim_denominator)) %>% 
  arrange(first5, agency_num)



agency_data

#write_csv(agency_data, "all_agenciesJune12.csv")


```

Using the agency numbers for each municipality, I pull all tax codes that have an agency_num included in the muni_agency_names object. By narrowing the agencies down to just Municipality types, this prevents duplicate tax_codes from being pulled.

```{r municiple-taxcodes}
# muni_agency_nums<- all_taxing_agencies %>% 
#   filter(minor_type %in% c("MUNI")) %>%
#   select(agency_num)

muni_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql("
  SELECT*
  FROM tax_code
  WHERE agency_num IN ({muni_agency_names$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

```

## Levies

Cicero is an oddball: agency_num = 020060000

```{r}
muni_levies <- agency_data %>% filter(minor_type == "MUNI" | agency_num == "020060000"  
)

muni_levies
```

## TIF Dummy variable for tax codes

```{r}
# Agency number and agency name for all TIFs
TIF_agencies <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  WHERE minor_type = 'TIF'
  "
)

unique_tif_taxcodes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({TIF_agencies$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)



tif_distrib <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT *
  FROM tif_distribution
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)


tif_distrib <- tif_distrib %>% 
  mutate(#first6= str_sub(agency_num,1,6),
         first5 = str_sub(agency_num,1,5),
         #tif_increment = tax_code_eav - tax_code_frozen_eav,
         total_taxcode_revenue = tax_code_eav*tax_code_rate/100,
         district_revenue_withinTIF = tax_code_frozen_eav*tax_code_rate/100,
         # checking to see if equal to tax_code_revenue
         # same but has the negative revenue values instead of zeros.
         tif_revenue_withinTIF = total_taxcode_revenue - district_revenue_withinTIF)

tif_distrib <- tif_distrib %>% left_join(muni_tax_codes) #maybe by first 5 or 6 digits? Otherwise no matches.
tif_distrib

#  select(tax_code_num, tax_code_rate, tax_code_eav, tax_code_frozen_eav, tax_code_revenue, tif_revenue_withinTIF)

```


## Pins 

There are 1,825,816 pins in 2021.

```{r eval=FALSE}
muni_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT pin, class, tax_code_num
  FROM pin
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))

class_dict$class_code <- as.character(class_dict$class_code)

pin_data <- lookup_pin(2021, muni_pins$pin) %>%
  left_join(muni_pins, by = c("pin", "class"))

pin_data <- class_dict %>%
  select(-c(assessment_level:reporting_group, class_desc:max_size)) %>%
  right_join(pin_data, by = c("class_code" = "class"))

# write_csv(pin_data, "all_pins_2021.csv")

exemptions_by_class_per_TC <- pin_data %>%
  group_by(tax_code_num, major_class_code, major_class_type) %>%
  summarize(eav=sum(eav, na.rm=TRUE),
            exe_homeowner = sum(exe_homeowner, na.rm=TRUE),
            exe_senior = sum(exe_senior, na.rm=TRUE),
            exe_freeze = sum(exe_freeze, na.rm=TRUE),
            exe_longtime_homeowner = sum(exe_longtime_homeowner, na.rm=TRUE),
            exe_disabled = sum(exe_disabled, na.rm=TRUE),
            exe_vet_returning = sum(exe_vet_returning, na.rm=TRUE),
            exe_vet_dis = sum(exe_vet_dis_lt50 + exe_vet_dis_50_69 + exe_vet_dis_ge70, na.rm=TRUE),
            exe_abate = sum(exe_abate, na.rm=TRUE),
            pin_count = n()

)
write_csv(exemptions_by_class_per_TC, "all_exemptions_by_TC.csv")
```

## Tax Bills

The tax_bill command returns informatin for erach taxing agency that taxed a pin. EACH pin can be taxed by 15+ taxing agencies and each taxing agency has its own taxing rate. 

Each tax code has a unique combination of taxing agencies taxing properties within in. So, each tax code has a summed EAV value from each pin within it and a "composite tax rate" made from the taxing agencies and their taxable base. In the code below, its called the weighted tax rate but that isn't the best name for it... It is more like the amount of money that each taxing agency gets from each property.

`rev_perTC`(previously named weighted_tax_rate in earlier code versions) was calculated for every tax bill observation for every pin and is equal to the eav of a property X agency_tax_rate. Then all pins within tax codes were summed together to get a tax code level EAV and tax code level tax rate. _Note: There is a tax_code_rate variable included in the `muni_tax_codes` object made from the `tax_code` dt included in ptaxsim_ 

> Not sure if the agency_tax_rate calculated in the chunk below is reliable. would the agency_tax_rate be the mean of all agency tax rates for a tax code. I don't think so. The muni_tax_codes data table has all tax codes, tax code rates, agency numbers and agency rates. Compare to these numbers. Should they be the same or different?  


```{r pull-taxbills, eval =FALSE}

bills <- tax_bill(2021, muni_pins$pin, simplify = FALSE)

bills_byClass_pertaxcode <- bills %>%
  left_join(class_dict, by = c("class" = "class_code")) %>%
  mutate(revenue_collected = agency_tax_rate*eav) %>% # $ for each pin-taxing agency  combo
  group_by(major_class_code, major_class_type, tax_code) %>%
  summarize(
            final_tax_to_dist = sum(final_tax_to_dist, na.rm=TRUE),
            final_tax_to_tif = sum(final_tax_to_tif, na.rm=TRUE),
            tax_amt_exe = sum(tax_amt_exe, na.rm=TRUE),
            tax_amt_pre_exe = sum(tax_amt_pre_exe, na.rm=TRUE),
            tax_amt_post_exe = sum(tax_amt_post_exe, na.rm=TRUE),
        agency_tax_rate = mean(agency_tax_rate, na.rm=TRUE),
        rpm_tif_to_cps =sum(rpm_tif_to_cps, na.rm=TRUE),
        rpm_tif_to_rpm = sum(rpm_tif_to_rpm, na.rm=TRUE),
        rpm_tif_to_dist = sum(rpm_tif_to_dist, na.rm=TRUE),
           tif_share = mean(tif_share, na.rm=TRUE),
        rev_perTC = sum(revenue_collected, na.rm = TRUE))

write_csv(bills_byClass_pertaxcode, "taxbills_byPropClass_perTC.csv")

write_csv(bills, "all_taxbills.csv")

# bills_pertaxingagency <- bills %>%
#   group_by(agency_name, agency_num, agency_tax_rate, agency_major_type, agency_minor_type) %>%
#   summarize(
#             final_tax_to_dist = sum(final_tax_to_dist),
#             final_tax_to_tif = sum(final_tax_to_tif),
#             tax_amt_exe = sum(tax_amt_exe),
#             tax_amt_pre_exe = sum(tax_amt_pre_exe),
#             tax_amt_post_exe = sum(tax_amt_post_exe),
#         agency_tax_rate = mean(agency_tax_rate)
#             )
# 
# write_csv(bills_pertaxingagency, "alltaxbills_byTaxingAgency.csv")
```

# Tax Bills by TaxCode

Taxbills by property class has 9716 observations. (3774 tax codes X multiple property types).

```{r}
taxbills_by_Class_per_TC <- read_csv("taxbills_byPropClass_perTC.csv") %>%
  mutate(tax_code = as.character(tax_code),
         rev_perTC = round(rev_perTC)) %>%
  left_join(muni_tax_codes, by = c("tax_code" = "tax_code_num"))


taxbills_by_Class_per_TC <- left_join(taxbills_by_Class_per_TC , muni_agency_names)

# all munis + Cicero
MuniLevy <- taxbills_by_Class_per_TC %>% 
  group_by(agency_name)%>%
  summarize(MuniLevy = round(sum(final_tax_to_dist)),
            Levy_plus_TIFrev =round(sum(final_tax_to_dist + final_tax_to_tif)))

MuniLevy
```

Comparison of ptaxsim/Alea calculations and the numbers in Josh Drucker's Excel files. Pretty close but not perfect matches (which is fine, I'm not surprised by that).

Chicago: 6,536,952,735 vs. 6,490,629,279 JD
Bridgeview: 65,534,363 vs. 65,133,190 JD
Dolton: 54,957,926 vs. 56,755,459 JD
Hoffman Estates: 177,316,159	vs. 182,363,626 JD

Midlothian: 30,988,554 vs 30,877,423 JD


Oak Park: 234,665,831 vs 233,132,867 JD.




# Exemptions summarized by Tax Code


```{r}
exemptions_by_class_per_TC <- read_csv("all_exemptions_by_TC.csv") %>% 
  mutate(tax_code_num = as.character(tax_code_num))


muni_tax_codes <- full_join(muni_tax_codes, muni_agency_names)

# make tax code variables character formatted for the join
muni_tax_codes$tax_code_num <- as.character(muni_tax_codes$tax_code_num)
exemptions_by_class_per_TC$tax_code_num <- as.character(exemptions_by_class_per_TC$tax_code_num)


# make dummy variable for if a tax code is a tif tax code or not
exemptions_by_class_per_TC <- left_join(exemptions_by_class_per_TC, muni_tax_codes, by =c("tax_code_num")) %>%
  mutate(in_TIF = ifelse(tax_code_num %in% unique_tif_taxcodes$tax_code_num, 1,0) )

exemptions_by_class_per_TC


exemptions_by_class_per_TC <- left_join(exemptions_by_class_per_TC, muni_levies, by = c("agency_name", "agency_num", "year")) %>%
  mutate(in_TIF = ifelse(tax_code_num %in% unique_tif_taxcodes$tax_code_num, 1,0) )

exemps_inTIF_byClass_perMuni <- exemptions_by_class_per_TC %>% 
  mutate(taxamount = tax_code_rate/100*eav) %>%
  group_by(agency_name, agency_num, major_class_code, in_TIF,
           major_class_type, agency_rate) %>%
  summarize(taxamount_perClass = round(sum(taxamount)),
            eav_pre_exe_perClass  = sum(eav, na.rm=TRUE),
            exe_homeowner = sum(exe_homeowner, na.rm=TRUE),
            exe_senior = sum(exe_senior, na.rm=TRUE),
            exe_freeze = sum(exe_freeze, na.rm=TRUE),
            exe_longtime_homeowner = sum(exe_longtime_homeowner, na.rm=TRUE),
            exe_disabled = sum(exe_disabled, na.rm=TRUE),
            exe_vet_returning = sum(exe_vet_returning, na.rm=TRUE),
            exe_vet_dis = sum(exe_vet_dis, na.rm=TRUE),
            exe_abate = sum(exe_abate, na.rm=TRUE)
           ) %>%
  
  mutate(Exemp_in_PropClass = exe_homeowner + exe_senior+ exe_freeze +
           exe_longtime_homeowner + exe_disabled+ exe_vet_returning +exe_vet_dis + exe_abate,
          
            EAV_post_exe_PerClass = eav_pre_exe_perClass-Exemp_in_PropClass, 
     #    tax_share_pre_exemp = taxamount / eav_pre_exe_perClass,
          
         tax_share_post_exemp = taxamount_perClass/ EAV_post_exe_PerClass #curreny situation
         )

exemps_inTIF_byClass_perMuni


summtable <- exemps_inTIF_byClass_perMuni %>% 
  select(agency_name, major_class_code, in_TIF , tax_share_post_exemp, taxamount_perClass, 
         eav_pre_exe_perClass, Exemp_in_PropClass, EAV_post_exe_PerClass, agency_num, agency_rate, major_class_type)
summtable

exemptions_perMuni <- exemps_inTIF_byClass_perMuni %>%
  group_by(agency_name, agency_num, agency_rate) %>% 
  summarize(taxamount_perMuni = sum(taxamount_perClass),
            eav_pre_exe_perMuni = sum(eav_pre_exe_perClass),
            TotalExemptions=sum(Exemp_in_PropClass),
         ResidentialExemp = sum(exe_homeowner +exe_senior+exe_freeze + exe_longtime_homeowner
                                + exe_disabled+ exe_vet_returning +exe_vet_dis, na.rm=TRUE),
         CommercialExemp = sum(exe_abate, na.rm=TRUE)) %>%
  mutate(
         eav_post_exe_perMuni = eav_pre_exe_perMuni-TotalExemptions) %>% 
  arrange(agency_num)

exemptions_perMuni

EAV_tifs_and_exemps_byClass_andMuni <- summtable %>% 
  left_join(exemptions_perMuni , by = c("agency_name", "agency_num", "agency_rate"))



burden_shift_byMuni_PropClass <- EAV_tifs_and_exemps_byClass_andMuni %>% #ungroup() %>% 
  select(agency_name, major_class_type, in_TIF, agency_rate, eav_pre_exe_perClass, EAV_post_exe_PerClass, agency_num, eav_pre_exe_perMuni, eav_post_exe_perMuni) %>% 
  left_join(MuniLevy) %>%
  mutate(noexemps_agency_rate = MuniLevy / eav_pre_exe_perMuni,
         exemps_agency_rate = MuniLevy / eav_post_exe_perMuni) %>%
  group_by(agency_name, agency_num, major_class_code, major_class_type, in_TIF#, noexemps_agency_rate, exemps_agency_rate
           ) %>%
   summarize(agency_rate_no_exemps = noexemps_agency_rate,
             agency_rate_w_exemps= exemps_agency_rate,
             MuniLevy = MuniLevy, 
             eav_pre_exe_perClass = eav_pre_exe_perClass,
             EAV_post_exe_PerClass = EAV_post_exe_PerClass,
             eav_post_exe_perMuni = eav_post_exe_perMuni, 
             eav_pre_exe_perMuni = eav_pre_exe_perMuni) %>% 
  mutate(
    # if there were no exemptions
     rev_w_no_exemps = round(agency_rate_no_exemps * eav_pre_exe_perClass),
     
     # the current situation with current exemptions
     rev_w_exemps = round(agency_rate_w_exemps* EAV_post_exe_PerClass)) %>%
  ungroup() %>%
  ungroup() %>%
  mutate(
     
     # percent of levy paid by each property class if there were no exemptions
     tax_burden_noexemps = round(eav_pre_exe_perClass / MuniLevy, digits = 5),
     
     # percent of levey paid by each property class based on current exemptions
     tax_burden_current = round(EAV_post_exe_PerClass / MuniLevy, digits = 5),
     
     # difference in percent of the levy being paid by each property class
     burden_shift_from_current_exemps = tax_burden_noexemps - tax_burden_current ) 

# write.csv(EAV_and_exemps_byClass_andMuni, "EAV_and_exemps_byClass_andMuni.csv")

burden_shift_byMuni_PropClass

burden_shift_byMuni_PropClass %>% filter(agency_num %in% c("030120000", "030210000", "030800000", "030920000","030580000","030310000"))

burden_shift_byMuni_PropClass %>% filter(agency_num %in% c("030120000", "030210000", "030800000", "030920000","030580000","030310000") &
                                           major_class_code == "2"& in_TIF==0)

```




# Exemptions by Municipality

```{r}
exemps_byClass_perMuni <- exemptions_by_class_per_TC %>% 
  mutate(taxamount = tax_code_rate/100*eav) %>%
  group_by(agency_name, agency_num, major_class_code, major_class_type, agency_rate) %>%
  summarize(taxamount_perClass = round(sum(taxamount)),
            eav_pre_exe_perClass  = sum(eav, na.rm=TRUE),
            exe_homeowner = sum(exe_homeowner, na.rm=TRUE),
            exe_senior = sum(exe_senior, na.rm=TRUE),
            exe_freeze = sum(exe_freeze, na.rm=TRUE),
            exe_longtime_homeowner = sum(exe_longtime_homeowner, na.rm=TRUE),
            exe_disabled = sum(exe_disabled, na.rm=TRUE),
            exe_vet_returning = sum(exe_vet_returning, na.rm=TRUE),
            exe_vet_dis = sum(exe_vet_dis, na.rm=TRUE),
            exe_abate = sum(exe_abate, na.rm=TRUE)
           ) %>%
  
  mutate(Exemp_in_PropClass = exe_homeowner + exe_senior+ exe_freeze +
           exe_longtime_homeowner + exe_disabled+ exe_vet_returning +exe_vet_dis + exe_abate,
          
            EAV_post_exe_PerClass = eav_pre_exe_perClass-Exemp_in_PropClass, 
     #    tax_share_pre_exemp = taxamount / eav_pre_exe_perClass,
          
         tax_share_post_exemp = taxamount_perClass/ EAV_post_exe_PerClass #curreny situation
         )

exemps_byClass_perMuni


summtable <- exemps_byClass_perMuni %>% 
  select(agency_name, major_class_code, tax_share_post_exemp, taxamount_perClass, 
         eav_pre_exe_perClass, Exemp_in_PropClass, EAV_post_exe_PerClass, agency_num, agency_rate, major_class_type)
summtable

#muni_levies %>% 
#select(agency_num, cty_cook_eav, total_levy, total_ext) %>% 
#inner_join(summtable)


#summtable %>% left_join(muni_levies)

# #assessment_rates <- c(0, .1, .1, .1, .2, .25, .25, NA, NA, NA, NA, NA, NA, .1)
# class = c("0", "1","2", "3", "4" ,"5A", "5B", "6A", "6B", "6C", "7A", "7B", "8", "9")
# class_rates <- as.data.frame(assessm ent_rates,class)
# class_rates
```




```{r}
exemptions_perMuni <- exemps_byClass_perMuni %>%
  group_by(agency_name, agency_num, agency_rate) %>% 
  summarize(taxamount_perMuni = sum(taxamount_perClass),
            eav_pre_exe_perMuni = sum(eav_pre_exe_perClass),
            TotalExemptions=sum(Exemp_in_PropClass),
         ResidentialExemp = sum(exe_homeowner +exe_senior+exe_freeze + exe_longtime_homeowner
                                + exe_disabled+ exe_vet_returning +exe_vet_dis, na.rm=TRUE),
         CommercialExemp = sum(exe_abate, na.rm=TRUE)) %>%
  mutate(
         eav_post_exe_perMuni = eav_pre_exe_perMuni-TotalExemptions) %>% 
  arrange(agency_num)

exemptions_perMuni

EAV_and_exemps_byClass_andMuni <- summtable %>% 
  left_join(exemptions_perMuni , by = c("agency_name", "agency_num", "agency_rate"))



burden_shift_byMuni_PropClass <- EAV_and_exemps_byClass_andMuni %>% #ungroup() %>% 
  select(agency_name, major_class_type, agency_rate, eav_pre_exe_perClass, EAV_post_exe_PerClass, agency_num, eav_pre_exe_perMuni, eav_post_exe_perMuni) %>% 
  left_join(MuniLevy) %>%
  mutate(noexemps_agency_rate = MuniLevy / eav_pre_exe_perMuni,
         exemps_agency_rate = MuniLevy / eav_post_exe_perMuni) %>%
  group_by(agency_name, agency_num, major_class_code, major_class_type#, noexemps_agency_rate, exemps_agency_rate
           ) %>%
   summarize(agency_rate_no_exemps = noexemps_agency_rate,
             agency_rate_w_exemps= exemps_agency_rate,
             MuniLevy = MuniLevy, 
             eav_pre_exe_perClass = eav_pre_exe_perClass,
             EAV_post_exe_PerClass = EAV_post_exe_PerClass,
             eav_post_exe_perMuni = eav_post_exe_perMuni, 
             eav_pre_exe_perMuni = eav_pre_exe_perMuni) %>% 
  mutate(
    # if there were no exemptions
     rev_w_no_exemps = round(agency_rate_no_exemps * eav_pre_exe_perClass),
     
     # the current situation with current exemptions
     rev_w_exemps = round(agency_rate_w_exemps* EAV_post_exe_PerClass)) %>%
  ungroup() %>%
  ungroup() %>%
  mutate(
     
     # percent of levy paid by each property class if there were no exemptions
     tax_burden_noexemps = round(eav_pre_exe_perClass / MuniLevy, digits = 5),
     
     # percent of levey paid by each property class based on current exemptions
     tax_burden_current = round(EAV_post_exe_PerClass / MuniLevy, digits = 5),
     
     # difference in percent of the levy being paid by each property class
     burden_shift_from_current_exemps = tax_burden_noexemps - tax_burden_current ) 

# write.csv(EAV_and_exemps_byClass_andMuni, "EAV_and_exemps_byClass_andMuni.csv")

burden_shift_byMuni_PropClass
```

Six community Comparison:

```{r}
burden_shift_byMuni_PropClass %>% filter(agency_num %in% c("030120000", "030210000", "030800000", "030920000","030580000","030310000"))

burden_shift_byMuni_PropClass %>% filter(agency_num %in% c("030120000", "030210000", "030800000", "030920000","030580000","030310000") &
                                           major_class_code == "2")
```

Overall burden shift is change in percentage points.


### Add in Levy Data at Muni level:

```{r}
EAV_and_exemps_byClass_andMuni <- EAV_and_exemps_byClass_andMuni %>% 
  left_join(muni_levies, by = c("agency_num", "agency_name")) %>%
  select(-c(year, agg_ext_base_year:lim_rate, curr_new_prop, cty_total_eav, pct_burden, total_final_rate, total_prelim_rate, total_reduced_levy, total_max_levy, total_levy, reduction_type:total_non_cap_ext))

EAV_and_exemps_byClass_andMuni
write.csv(EAV_and_exemps_byClass_andMuni, "EAV_and_exemps_byClass_andMuni.csv")

```


#### Exemptions within TIFs per muni

Not sure if we want this yet but still included for now. 0 means values not in a tif, 1 means values in a tif.

```{r}
exemptions_inTIFs_perMuni <- exemptions_by_class_per_TC %>%
  group_by(agency_name, agency_num, in_TIF) %>% 
  summarize(eav_pre_exe = sum(eav),
            TotalExemptions=sum(exe_homeowner +exe_senior+exe_freeze+exe_longtime_homeowner + exe_disabled+ exe_vet_returning +exe_vet_dis + exe_abate),
         ResidentialExemp = sum(exe_homeowner +exe_senior+exe_freeze+exe_longtime_homeowner + exe_disabled+ exe_vet_returning +exe_vet_dis),
         CommercialExemp = sum(exe_abate),
         eav_post_exe = eav_pre_exe-TotalExemptions)

exemptions_inTIFs_perMuni


#All nonTIF values
exemptions_inTIFs_perMuni %>% 
  filter(in_TIF == "0") %>% 
  left_join(muni_levies) %>% 
  select(agency_name, total_ext, eav_pre_exe) %>%
  mutate(no_exemption_rate = total_ext/eav_pre_exe)


```

> To do: Create residential & commercial categories and EAV in each. Then calculate the share of exemptions/residential eav, exemptions/total_eav, and residential eav/total_eav.

# Burden Share and Shift

## Current Burden 

Share of residential = amount collected by residential/ amount collected overall.



Current burden is the % of the levy paid by each property class.

```{r}

```


Levy (aka tot_ext) does not change. So the money the municipality needs divided by the pre_exe_eav would be the new tax rate if exemptions didn't exist. 



The percent of all residential property that is exempt (due to ONLY homeowner exemptions) is below for each Municipality:

% residential exempt = sum of all homeowner exemptions in a municipality divided by the pre-exemption EAV for residential properties in that municipality. 

- In Chicago, only 6.2% of residential eav is not taxed due to homeowner exemptions. Bridgeview has 14% of is residential EAV not taxed, Dolton = 24%...., Oak Park has 8% of its residential EAV exempt due to homeowners exemptions. 


```{r}

# EAV_and_exemps_byClass_andMuni %>% 
#   mutate(class_burden = taxamount_perClass/taxamount) %>%
#   select(agency_name, class_burden)


exemptions_by_class_per_TC %>% 
  filter(major_class_code == "2") %>% 
  group_by(agency_name, agency_num) %>%
  summarize(eav_pre_exe_perClass = sum(eav, na.rm = TRUE), 
            tax_revenue = sum(agency_rate/100*eav),
            exe_homeowner = sum(exe_homeowner, na.rm = TRUE)) %>%
             mutate(homeowner_exe_perResEAV = exe_homeowner/eav_pre_exe_perClass)# %>%
#  select(agency_name, homeowner_exe_perResEAV, eav_pre_exe_perClass) 
  #select(agency_name,major_class_code, major_class_type, eav_pre_exe_perClass, Exemp_in_PropClass, EAV_post_exe_PerClass, agency_num, agency_rate) %>% 

#write.csv("EAV_and_exemps_byClass_andMuni.csv")

```

```{r}

exemptions_perMuni %>% 
  mutate(exemps_per_residentialEAV = ResidentialExemp/ eav_pre_exe_perMuni,
         exemps_per_allEAV = TotalExemptions/eav_pre_exe_perMuni) %>% 
  arrange(exemps_per_residentialEAV)

```

ageny_rate_noexemps is NOT correct below!

```{r}
exemptions_perMuni <- exemptions_perMuni %>% left_join(muni_levies)

exemptions_perMuni <- exemptions_perMuni %>%
  
  mutate(agency_rates_noExemps = TotalExemptions/eav_pre_exe_perMuni)
exemptions_perMuni
```

The levy amount and eav values from the `agency` data table represent only the Taxable Base.

> Subtract original agency rate from new agency rate for the rate increase. This is the indirect effect of the residential tax exemptions.

# Extra Stuff: Eval=FALSE for now
# Revenue

## TIF Agencies & Tax Codes

Not runing these codes for now, focusing on exemptions and burden shift.

```{r tif-datatables, eval=FALSE}

# Some TIFs will have more than 1 agency number. This happens when TIFs are
# expanded or when another TIF is created on top of an existing one. The
# multiple agency_num records still aggregate up to one "main" TIF record (in
# the agency_info and tif tables). This crosswalk is used to determine which
# TIFs aggregate to which agency_nums. See issue #39 for more information

# has tifs and year they existed.
# we want TIFS that existed in the year we are looking at
tif_crosswalk_dt <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT *
  FROM tif_crosswalk
  WHERE year = 2021
  "
)

```


```{r tif-history, eval=FALSE}

tif_history <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT *
  FROM tif
  WHERE year = 2021
  "
)

# Tax Codes that are in TIFS

# tif_tax_codes <- DBI::dbGetQuery(
#   ptaxsim_db_conn, 
#   glue_sql("
#   SELECT DISTINCT tax_code_num
#   FROM tax_code
#   WHERE agency_num IN ({TIFs$agency_num*})
#   ",
#   .con = ptaxsim_db_conn
#   )
# )

# # all tax codes for all munis. Large
# all_tax_codes <- DBI::dbGetQuery(
#   ptaxsim_db_conn, 
#   glue_sql("
#   SELECT DISTINCT * 
#   FROM tax_code
#   WHERE year = 2021
#   ",
#   .con = ptaxsim_db_conn
#   )
# )

# #85 unique tax codes and the number of times they appear:
# unique_tif_taxcodes <- tif_tax_codes %>% group_by(tax_code_num ) %>% summarize(n=n())


# tif_pins <- DBI::dbGetQuery(
#   ptaxsim_db_conn,
#   glue_sql(
#   "SELECT DISTINCT pin, class
#   FROM pin
#   WHERE tax_code_num IN ({unique_tif_taxcodes$tax_code_num*})
#   ",
#   .con = ptaxsim_db_conn
# ))
# 
# unique_tif_pins <- tif_pins %>% distinct(pin) %>% count()


```

```{r munitifs-tiftaxcodes, eval=FALSE}
# Determining the increment / TIF stuff
tif_agency_nums <- all_taxing_agencies %>% 
  filter(minor_type == "TIF") %>% select(agency_num)

unique_tif_taxcodes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({tif_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)
```

### Tax Codes in TIFs

57,000+ tax_codes with their tax_code rates exist during 2021. Also has agency_number and agency_rate

```{r eval=FALSE}
# all tax codes for all municipalities in 2021
# Over 57,000 tax codes with agency_rate and tax_code_rate. Over 57,000
tax_code_dt <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT * 
  FROM tax_code
  WHERE year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

# create dummy variable for tax_codes that in TIFs
tax_code_dt <- tax_code_dt %>% 
  mutate(in_TIF = ifelse(tax_code_num %in% unique_tif_taxcodes$tax_code_num, 1,0) )



table(tax_code_dt$in_TIF)
```

In 2021, there are 34,266 tax codes not in a TIF and 23,279 tax codes that are within TIF areas.

To get all pins that are in a TIF, run the code below. It is currently commented out so that it doesn't run because it is a BIG data table and I don't know if I need it yet.

```{r tif-pins, eval=FALSE}

# if I wanted all pins that are within a TIF, I would run this.

# unqiue_tif_pins <- DBI::dbGetQuery(
#   ptaxsim_db_conn,
#   glue_sql(
#   "SELECT DISTINCT pin, class
#   FROM pin
#   WHERE tax_code_num IN ({unique_tif_taxcodes$tax_code_num*})
#   AND year = 2021
#   ",
#   .con = ptaxsim_db_conn
# ))


```

Thought process in meeting:
Taxable eav will increase if no exemptions.


```{r tif-eav, eval=FALSE}
# TIF distributions will include all the unique tax codes that make up
# a TIF

# has eav values for each tax code
# has ALL years

# tif_distrib_allyears <- DBI::dbGetQuery(
#   ptaxsim_db_conn, 
#   glue_sql("
#   SELECT *
#   FROM tif_distribution
#   WHERE agency_num IN ({tif_agency_nums$agency_num*})
#   ",
#   .con = ptaxsim_db_conn
#   )
# )


# # another way to get all pins within a tif:
# tif_pins_vec <- DBI::dbGetQuery(
#   ptaxsim_db_conn,
#   glue::glue_sql("
#     SELECT DISTINCT pin
#     FROM pin
#     WHERE tax_code_num IN ({unique(tif_distrib$tax_code_num)*})
#     AND year = 2021
#   ",
#     .con = ptaxsim_db_conn
#   )
# ) %>%
#   pull(pin)
```

The tax_code_revenue returned in this table represents the TIF revenue collected within an agency If the tax_code's EAV decreased from its frozen value, then the tax_code_revenue is 0 instead of going negative.

`tif_distrib` has the frozen eav for tax codes that are in tifs, the total revenue for the tax code, the revenue that went to the municipality, and the revenue that went to the tif.

```{r eval=FALSE}
class_dict$class_code <- as.character(class_dict$class_code)

# tax_code values for areas in Tif summed to agency level. 
# 
all_taxing_agencies<- tif_distrib %>% group_by(agency_num) %>% 
  summarize(tax_code_revenue_inTIFs = sum(tax_code_revenue),
            sum_eav = sum(tax_code_eav),
            frozen_eav = sum(tax_code_frozen_eav)) %>% 
  mutate(in_TIF="1") %>%
  right_join(all_taxing_agencies) %>%
  mutate(tax_code_revenue_inTIFs = ifelse(is.na(tax_code_revenue_inTIFs)| tax_code_revenue_inTIFs == "NA", 0, tax_code_revenue_inTIFs),
       in_TIF= ifelse(is.na(in_TIF)| in_TIF == "NA", 0,in_TIF) 
)

```

> EAV from tax_bill() returned is value before exemptions are removed. Kind of like an unaltered EAV or "true" EAV.

> EAV from `agency` data table is after exemptions subtracts tif increments. (i.e. it is the taxable base used for the levy calculations)

```{r eval=FALSE}

tax_code_dt <- left_join(tax_code_dt, tif_distrib)

agency_data <- tax_code_dt %>% 
  group_by(agency_num, agency_rate) %>% 
  summarize(agency_eav_after_exemptions = sum(tax_code_eav),
            agency_frozen_eav = sum(tax_code_frozen_eav),
            total_taxcode_revenue = sum(total_taxcode_revenue),
            district_revenue_withinTIF = sum(district_revenue_withinTIF),
            tif_revenue_withinTIF=sum(tax_code_revenue),
            tif_increment = sum(tif_increment)) %>%
  right_join(agency_data)

#agency_data <- tax_code_dt %>% select(agency_num,agency_rate) %>% distinct() %>%
#  right_join(agency_data)
```

```{r eval=FALSE}
area_pins2 <- as.character(muni_pins$pin)

#207,565 taxbills/observations for Cicero for 2021
area_data <- tax_bill(2021, area_pins2, simplify = FALSE)

# get class info with pin exemption data
class_dict$class_code <- as.character(class_dict$class_code)

area_data <- left_join(area_data, class_dict, by=c("class" = "class_code")) %>% 
  mutate(in_tif = ifelse(final_tax_to_tif > 0, 1, 0),
         DecreasedTaxBillAmount = tax_amt_pre_exe-tax_amt_post_exe, 
         # lost revenue from exemptions decreasing EAV taxed
         )

area_data
#setkey(area_data, year, tax_code, agency_num)

# 145 unique year-taxcode-agencynum combinatins. 
# send this through other functions
#unique_values<-area_data %>% group_by(year, tax_code, agency_num) %>% summarize()

#unique_values

## values are after exemptions have been subtracted! 
taxing_agencies <- area_data %>% 
  group_by(agency_name, agency_num, agency_tax_rate) %>% 
  summarize(eav = sum(eav),
        #    final_tax = sum(final_tax), 
        # final tax only exists if simplify = TRUE in that tax_bill() command.
            final_tax_to_dist = sum(final_tax_to_dist),   #revenue to district
            final_tax_to_tif = sum(final_tax_to_tif),     # revenue to TIF
            tax_amt_exe = sum(tax_amt_exe),     # reduction in tax bill due to exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe), #tax bill before exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe), # tax bills after exemptions are subtracted from EAVs
        agency_tax_rate = mean(agency_tax_rate),
        agency_total_ext = mean(agency_total_ext)
            ) %>%
  arrange(agency_num) %>%
  mutate(weighted_tax_rate = agency_tax_rate*eav) %>% 
  ungroup() %>%
  mutate(composite_tax_rate = sum(weighted_tax_rate)/max(eav) )

taxing_agencies

# saves composite tax rate as its own object because I might plug it in with the TIF stuff later.
composite_tax_rate <- first(taxing_agencies$composite_tax_rate)


## Exact match (besides column names) with JD's values for Taxing Agencies. 
taxing_agencies %>%
    mutate(`Tax Rate` = round(agency_tax_rate, digits = 6),
           EAVbeforeExemptions = scales::comma(eav)) %>%
select(agency_name, agency_name, EAVbeforeExemptions, `Tax Rate`, weighted_tax_rate, composite_tax_rate)
```

### Taxcodes: Combining TIF and nonTIF data

```{r eval=FALSE}
# class_eav <- area_data %>% 
#   group_by(           
#     major_class_code) %>% 
#   summarize(
#             final_tax_to_dist = sum(final_tax_to_dist),
#             final_tax_to_tif = sum(final_tax_to_tif),
#             tax_amt_exe = sum(tax_amt_exe),
#             tax_amt_pre_exe = sum(tax_amt_pre_exe),
#             tax_amt_post_exe = sum(tax_amt_post_exe),
#             ) %>%
# 
#  # arrange(agency_num) %>%
#  # mutate(weighted_tax_rate = agency_tax_rate*eav) %>% 
#  # ungroup() %>%
#       mutate(total_revenue = final_tax_to_dist+final_tax_to_tif,
#              dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist))



tax_code_dt <-tax_code_dt %>%
  mutate(first_2digits = str_sub(agency_num,1,2),
                            last_2digits = str_sub(agency_num,8,9))

tax_code_dt
# all_tax_codes %>% group_by(agency_name, minor_type) %>%
#   summarize(tax_code_eav = sum(tax_code_eav, na.rm=TRUE),
#             district_revenue_withinTIF = sum(district_revenue_withinTIF,na.rm = TRUE),
#             tif_revenue_withinTIF = sum(tif_revenue_withinTIF, na.rm=TRUE),
#             total_taxcode_revenue = sum(total_taxcode_revenue, na.rm = TRUE),
#             
#             tax_code_frozen_eav = sum(tax_code_frozen_eav, na.rm = TRUE))
# nicer_table <- all_tax_codes %>%
# 
#   mutate(#EAV = scales::dollar(eav),
#                             "Total Tax Revenue(District+TIF)" = scales::dollar(max(total_taxcode_revenue)),
#                             "District Revenue" = scales::dollar(max(district_revenue_withinTIF)),
#                             "TIF Revenue" = scales::dollar(max(tif_revenue_withinTIF)),
#                             
#                          #   "Lost Revenue from Exempt." = #scales::dollar(tax_amt_exe), # same as tax_amt_pre_exe-tax_amt_post_exe
#                             #"District Tax Share" = scales::percent(dist_tax_share),
#                          #   "EAV in TIF (Increment)" = final_tax_to_tif/composite_tax_rate,
#                             # TIF EAV matches JD almost perfectly, Commercial 5A does not match. 
#                           #  "EAV outside TIF" = final_tax_to_dist/composite_tax_rate
#                             ) 

#%>% #mutate(`EAV in and out of TIFs` = `EAV in TIF (Increment)`+`EAV outside TIF`, EAVbeforeExemptions = `EAV in and out of TIFs`+Exemptions)
```

```{r eval=FALSE}

nicer_table <- class_eav %>% left_join(exemptions_by_class)%>%
  mutate(#EAV = scales::dollar(eav),
    Exemptions=TOTAL,
                            "Total Tax Revenue(District+TIF)" = scales::dollar(tax_amt_post_exe),
                            "District Revenue" = scales::dollar(final_tax_to_dist),
                            "TIF Revenue" = scales::dollar(final_tax_to_tif),
                            "Lost Revenue from Exempt." = scales::dollar(tax_amt_exe), # same as tax_amt_pre_exe-tax_amt_post_exe
                            "District Tax Share" = scales::percent(dist_tax_share),
                            "EAV in TIF (Increment)" = final_tax_to_tif/composite_tax_rate,
                            # TIF EAV matches JD almost perfectly, Commercial 5A does not match. 
                            "EAV outside TIF" = final_tax_to_dist/composite_tax_rate
                            ) %>% 
  mutate(`EAV in and out of TIFs` = `EAV in TIF (Increment)`+`EAV outside TIF`,
             EAVbeforeExemptions = `EAV in and out of TIFs`+Exemptions) %>%
  select(-c(tax_amt_post_exe,total_revenue, dist_tax_share, final_tax_to_dist:tax_amt_pre_exe,exe_homeowner:TOTAL)) 

nicer_table

#class_exemptions <- full_join(exemptions_by_class,  class_eav, by = "major_class_code") %>%
#  select(major_class_code, major_class_type, eav, final_tax_to_dist, tax_share)
#class_exemptions
```

> What is this ratio supposed to be? Exemptions / ????? Total EAV, EAV the district taxes, or what

```{r eval=FALSE}
total_exemptions/sum(nicer_table$TaxableBase)
```

```{r eval=FALSE}
area_data %>% 
  summarize(
    final_tax_to_dist = sum(final_tax_to_dist),
    final_tax_to_tif = sum(final_tax_to_tif),
    tax_amt_exe = sum(tax_amt_exe),
    tax_amt_pre_exe = sum(tax_amt_pre_exe),
    tax_amt_post_exe = sum(tax_amt_post_exe),
  ) %>%
  mutate(total_revenue = final_tax_to_dist+final_tax_to_tif,
         tax_share = total_revenue / sum(total_revenue),
         dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist)) %>%
  mutate(
    "Total Tax Revenue(District+TIF)" = scales::dollar(tax_amt_post_exe),
    "District Revenue" = scales::dollar(final_tax_to_dist),
    "TIF Revenue" = scales::dollar(final_tax_to_tif),
    "Lost Revenue from Exempt." = scales::dollar(tax_amt_exe), # same as tax_amt_pre_exe-tax_amt_post_exe
    "District Tax Share" = scales::percent(dist_tax_share),
    "EAV in TIF" = final_tax_to_tif/composite_tax_rate,
    # TIF EAV matches JD almost perfectly, Commercial 5A does not match. 
    "EAV outside TIF" = final_tax_to_dist/composite_tax_rate,
    TotalEAVafterExemptions = `EAV outside TIF`+total_exemptions$TotalExemptions) %>% 
  mutate(EAVbeforeExemptions = `EAV in TIF`+ `EAV outside TIF` + total_exemptions$TotalExemptions) %>%
  select(-c(tax_amt_post_exe:tax_share, dist_tax_share, final_tax_to_dist:tax_amt_pre_exe))
```

TIF information comes from Cook County Clerk's Office.

`tif_share` = the tax_code_distribution_pct / 100 and comes from tif_distribution table. Comes from lookup_tif() command. Calculated behind the scenes. Documentation for their process is in Gitlab R/lookup.R file

Lets find TIF taxing agencies and combine them with the other taxing agencies for the geographic area:

```{r eval=FALSE}

unique_tax_codes <- tax_code_dt %>% distinct(tax_code_num) %>% pull()

all_agency_data <- lookup_agency(2021, unique_tax_codes) %>%
  mutate(first_2digits = str_sub(agency_num, 1,2),
         last_2digits = str_sub(agency_num, 8,9)) %>%
  filter(first_2digits != "01" )



muni_eav <- all_agency_data %>% 
 # filter(last_2digits == "00" & agency_total_ext>0) %>%
  filter(agency_num %in% muni_agency_names$agency_num) %>%
  group_by(agency_num, agency_name, agency_major_type, agency_minor_type) %>% 
  summarize(agency_total_eav = mean(agency_total_eav, na.rm = TRUE),
            agency_total_ext = mean(agency_total_ext,na.rm=TRUE)) %>% 
  left_join(tax_code_dt) %>%
  mutate(agency_rate = mean(agency_rate, na.rm=TRUE))


# 
# muni_eav %>%
#   group_by(agency_name)%>%
#   summarize(EAV = first(agency_total_eav),
#     total_levy = first(agency_total_ext),
#     tax_code_eav = sum(tax_code_eav),
#     tax_code_frozen_eav = sum(tax_code_frozen_eav),
#     tax_code_revenue=sum(tax_code_revenue)
#   ) 
#   
# all_taxing_agencies <- full_join(taxing_agencies, tif_taxing_agencies, 
#                              #    by = c("year", "tax_code", "agency_name", "agency_num")
#                                  ) %>% mutate(in_tif = ifelse(is.na(tif_share), 0, 1))
```

```{r eval=FALSE}

all_taxing_agencies %>%
  group_by(agency_num, agency_name, in_TIF) %>% 
  summarize(agency_total_eav = mean(agency_total_eav),
            tif_share = mean(tif_share),
            agency_total_ext=mean(agency_total_ext)
          #  ,summed_eav = sum(eav)
            )

all_taxing_agencies %>%
  group_by(agency_num,agency_name, in_tif) %>% 
  summarize(eav = first(agency_total_eav)) %>% 
  pivot_wider(names_from="in_tif", values_from = "eav")
```

Need EAV of each Tax Code. Then we know the TIF eav from TIF tax_codes and other agency EAVs from Tax codes associated with other agencies. all_taxing_agencies has agency_total_eav but that includes all pin values everywhere that are included in that tax_code (So across all of cook county for Cook County's total eav)

```{r eval=FALSE}
pins_in_tifs <- left_join(taxcodes_intifs, area_data#, by = c("agency_name"="tif_agency_name")
                          ) %>% 
  mutate(pin_in_tif = ifelse(final_tax_to_tif > 0, 1, 0))

area_data <- left_join(area_data, pins_in_tifs)

pins_in_tifs %>% group_by(tif_agency_name) %>% 
  summarize(eav = sum(eav),
        #    final_tax = sum(final_tax), # final tax only exists if simplify = TRUE in that tax_bill() command.
            final_tax_to_dist = sum(final_tax_to_dist),
            final_tax_to_tif = sum(final_tax_to_tif),
            tax_amt_exe = sum(tax_amt_exe),
            tax_amt_pre_exe = sum(tax_amt_pre_exe),
            tax_amt_post_exe = sum(tax_amt_post_exe),
        agency_tax_rate = mean(agency_tax_rate)
            ) %>%
#  arrange(agency_num) %>%
  mutate(weighted_tax_rate = agency_tax_rate*eav) %>% 
  ungroup() %>%
  mutate(composite_tax_rate = sum(weighted_tax_rate)/max(eav) )
```

agency_total_eav The total amount of EAV within the taxing district, otherwise known as the "base". This is the denominator when calculating tax rates

agency_total_ext The total extension requested by the taxing district, otherwise known as the "levy". This is the amount the district needs in tax revenue and is the numerator when calculating tax rates

"Changing tax_code_vec"relocates" a PIN by changing the things that are taxing it. This can be useful for counterfactual analysis. For example, if you own property within a school district and want to know what your tax bill would be just outside the district, but otherwise within the same municipality, then you can find the tax code that represents that situation and plug it into tax_bill()"

```{r eval=FALSE}
#agency <- lookup_agency(2021, tax_code)
#agency 

#oak_pins2 <- fromJSON(rawToChar(oak_pins$content))$pin

#oak_pins2 %>% group_by(pin) %>% distinct()

tifs <- lookup_tif(2021, tax_codes)
tifs

joined <- left_join(area_data, tifs, by = c("year", "tax_code", "agency_num", "agency_name"))



joined  %>%
  group_by(major_class_type, major_class_code) %>%
  summarize(EAV = sum(eav),
    Exemptions =  sum(tax_amt_exe),
    tax_amt_pre_exe = sum(tax_amt_pre_exe),
            tax_amt_post_exe = sum(tax_amt_post_exe),
            tif_amount = sum(final_tax_to_tif),
            tax_to_district = sum(final_tax_to_dist)) %>%
  arrange(major_class_code)
 # mutate(Tax_Amount=sum(district_amount),
 #        TIF_Amount = sum(tif_amount))


#area_data <- full_join(area_data, pin_data)
area_data%>% 
  filter(final_tax_to_tif>0) %>%
  group_by(major_class_code)%>%
  summarise(tax_to_tif = sum(final_tax_to_tif),)
```
