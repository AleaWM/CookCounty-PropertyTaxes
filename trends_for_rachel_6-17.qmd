---
title: "Incentive Classification Use Over Time (2011-2021)"
subtitle: "PIN-level Trends in Value & Frequency of Use"
author: "Michael Van Hulle"
date: "June 17, 2024"
format: 
  html:
    embed-resources: true
    theme: lumen
    code-fold: true
    code-line-numbers: true
    code-overflow: wrap
    toc: true
    toc-location: left
knitr: 
  opts_chunk:
    warning: true
    message: false
---

```{r setup}
#| output: FALSE

# Load libraries

library(tidyverse)
library(glue)
library(DT)
library(flextable)

# Set table formatting defaults--change theme to something less ugly.

set_flextable_defaults(theme_fun = theme_vanilla, 
                       padding = 2,
                       line_spacing = 1,
                       big.mark = ",",
                       )

options(DT.options = list())

```


```{r load_data}
#| output: FALSE

# Read in muni class level data 2006-2021: 87610 obs of 41 variables
df <- read_csv("./Output/ptaxsim_muni_class_summaries_2006-2021.csv") |>
  rename(n_pins = pins_in_muni) |>
  as.data.frame()

# Import relevant variables from extended class dictionary
class_dict <- read_csv("./Necessary_Files/class_dict_expanded.csv") |>
  select(class = class_code, land_use = Alea_cat, incent_prop, ar = assess_ratio) |>
  as.data.frame()

# Join summaries w/ class dictionary
df_temp <- left_join(df, class_dict, by = "class")

# Make new and select relevant county-wide PIN variables
muni_data <- df_temp |>
  # Filter to years 2010-2021: 65802 obs.
  # Using 2010 instead of 2011 to calculate 2011 changes (if we later want those)
  filter(between(year, 2011, 2021)) |>
  # Filter to industrial and commercial properties: 26969 obs.
  filter(land_use %in% c("Industrial", "Commercial")) |>
  # Want to remove the NFPs: 24882 obs.
  filter(!between(class, 400, 499)) |>
  # Calculate "FMV"
  mutate(fmv = av/ar) |>
  # Calculate AV values if no incentives (could have calculated with AR)
  mutate(no_incent_av = fmv*.25) |>
  # Reframe to relevant variables
  group_by(year, clean_name, incent_prop, land_use) |>
  reframe(n_pins = sum(n_pins), av = sum(av), fmv = sum(fmv)) 

###RETURN TO THIS SECTION TO CREATE MUNI LAGS###
  
  # Calculate lags RETURN TO THIS
  # group_by(clean_name, incent_prop, land_use) |>
  # mutate(lag_n_pins = lag(n_pins),
  #        lag_av = lag(av),
  #        lag_fmv = lag(fmv)) |>
  # ungroup() |>
  # # Remove 2010 from df
  # filter(year != 2010) |>
  # # Select relevant variables
  # select(year, clean_name, land_use, incent_prop, n_pins, lag_n_pins, av, lag_av, 
  #        fmv, lag_fmv) |>
  # # Calculate YoY deltas
  # mutate(yoy_pin_delta = (n_pins - lag_n_pins) / lag_n_pins,
  #        yoy_av_delta = (av - lag_av) / lag_av,
  #        yoy_fmv_delta = (fmv - lag_fmv) / lag_fmv) |>
  # ungroup() |>
  # # Select Useful Variables
  # select(year, clean_name, incent_prop, land_use, n_pins, yoy_pin_delta, 
  #        av, yoy_av_delta, fmv, yoy_fmv_delta)

county_trends <- df_temp |> #see df_temp created above
  # Filter to years 2010-2021: 65802 obs.
  # Using 2010 instead of 2011 to calculate 2011 changes
  filter(between(year, 2010, 2021)) |>
  # Filter to industrial and commercial properties: 26969 obs.
  filter(land_use %in% c("Industrial", "Commercial")) |>
  # Want to remove the NFPs: 24882 obs.
  filter(!between(class, 400, 499)) |>
  # Calculate "FMV"
  mutate(fmv = av/ar) |>
  # Calculate AV values if no incentives (could have calculated with AR)
  mutate(no_incent_av = fmv*.25) |>
   # Reframe to relevant variables
  group_by(year, incent_prop, land_use) |>
  summarize(n_pins = sum(n_pins), av = sum(av), fmv = sum(fmv),
            .groups = 'drop') |>
  # Calculate lags
  ungroup() |>
  arrange(year) |>
  group_by(incent_prop, land_use) |>
  mutate(lag_n_pins = lag(n_pins),
         lag_av = lag(av),
         lag_fmv = lag(fmv)) |>
  ungroup() |>
  # Remove 2010 from df
  filter(year != 2010) |>
  # Select relevant variables
  select(year, land_use, incent_prop, n_pins, lag_n_pins, av, lag_av, 
         fmv, lag_fmv) |>
  # Calculate YoY deltas
  group_by(year, land_use, incent_prop) |>
  mutate(yoy_pin_delta = (n_pins - lag_n_pins) / lag_n_pins,
         yoy_av_delta = (av - lag_av) / lag_av,
         yoy_fmv_delta = (fmv - lag_fmv) / lag_fmv) |>
  ungroup() |>
  # Select Useful Variables
  select(year, incent_prop, land_use, n_pins, yoy_pin_delta, 
         av, yoy_av_delta, fmv, yoy_fmv_delta)

```

# Tables

```{r value_tables}

sum_table_1 <- muni_data |>
  filter(year == 2021) |>
  filter(incent_prop == "Incentive") |>
  group_by(clean_name) |>
  mutate(pins = sum(n_pins),
         fmv = sum(fmv)) |>
  reframe(clean_name, pins, fmv) |>
  arrange(desc(pins)) |>
  distinct() |>
  head(11)

sum_table_2 <- muni_data |>
  filter(year == 2021) |>
  filter(incent_prop == "Incentive") |>
  group_by(clean_name) |>
  mutate(pins = sum(n_pins),
         fmv = sum(fmv)) |>
  reframe(clean_name, pins, fmv) |>
  arrange(desc(fmv)) |>
  distinct() |>
  head(11)

sums_table <- bind_cols(sum_table_1, sum_table_2)

write_csv(sums_table, "sums_table.csv")

```

```{r perc_tables}

# What if I log it?

perc_table_1 <- muni_data |>
  filter(year == 2021) |>
  group_by(clean_name) |>
  mutate(muni_pins = sum(n_pins),
         muni_fmv = sum(fmv)) |>
  ungroup() |>
  group_by(clean_name, incent_prop) |>
  mutate(incent_pin_count = ifelse(incent_prop == "Incentive", n_pins,
         0)) |>
  mutate(non_incent_pin_count = ifelse(incent_prop == "Non-Incentive", n_pins,
         0)) |>
  mutate(incent_fmv = ifelse(incent_prop == "Incentive", fmv,
         0)) |>
  mutate(non_incent_fmv = ifelse(incent_prop == "Non-Incentive", fmv,
         0)) |>
  ungroup() |>
  group_by(clean_name) |>
  mutate(incent_pin_muni_perc = incent_pin_count/muni_pins) |>
  mutate(incent_fmv_muni_perc = incent_fmv/muni_fmv) |>
  reframe(clean_name, incent_pin_muni_perc, incent_fmv_muni_perc) |>
  arrange(desc(incent_pin_muni_perc)) |>
  distinct() |>
  head(10)

perc_table_2 <- muni_data |>
  filter(year == 2021) |>
  group_by(clean_name) |>
  mutate(muni_pins = sum(n_pins),
         muni_fmv = sum(fmv)) |>
  ungroup() |>
  group_by(clean_name, incent_prop) |>
  mutate(incent_pin_count = ifelse(incent_prop == "Incentive", n_pins,
         0)) |>
  mutate(non_incent_pin_count = ifelse(incent_prop == "Non-Incentive", n_pins,
         0)) |>
  mutate(incent_fmv = ifelse(incent_prop == "Incentive", fmv,
         0)) |>
  mutate(non_incent_fmv = ifelse(incent_prop == "Non-Incentive", fmv,
         0)) |>
  ungroup() |>
  group_by(clean_name) |>
  mutate(incent_pin_muni_perc = incent_pin_count/muni_pins) |>
  mutate(incent_fmv_muni_perc = incent_fmv/muni_fmv) |>
  reframe(clean_name, incent_pin_muni_perc, incent_fmv_muni_perc) |>
  arrange(desc(incent_fmv_muni_perc)) |>
  distinct() |>
  head(10)

perc_table <- bind_cols(perc_table_1, perc_table_2)

write_csv(perc_table, "perc_table.csv")

```

# Graphs

```{r annual_delta_n}
#| label: cook-n-delta
#| fig-cap: "Annual Change in Industrial and Commercial PIN Counts"
#| fig-cap-loc: "top"

county_trends |>
  filter(land_use == "")
  ggplot(aes(x = year, y = yoy_pin_delta, color = incent_prop, by = incent_prop)) + 
  geom_step() +
  theme_void()
  
###USE PLM FIRST###
