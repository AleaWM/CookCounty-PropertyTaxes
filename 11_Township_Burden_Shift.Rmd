---
title: "Mapping Property Tax Burden Shift due to Exemptions"
subtitle: "Cook County Townships"
author: "Alea Wilbur"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    df_print: paged
    code_folding: hide
    code_download: true
---

# Getting Data

```{r setup, include=TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)


library(tidyverse)
library(DBI)
library(data.table)
library(ggspatial)
library(gstat)
library(here)
library(httr)
library(jsonlite)
library(ptaxsim)
library(sf)
library(stars)
library(glue)

# Create the DB connection with the default name expected by PTAXSIM functions
ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), "./ptaxsim.db/ptaxsim-2021.0.4.db")


options(digits=4, scipen = 999)

library(sf)
library(jsonlite)
library(httr)

# link to the API output as a JSON file
muni_shp <- read_sf("https://gis.cookcountyil.gov/traditional/rest/services/politicalBoundary/MapServer/2/query?outFields=*&where=1%3D1&f=geojson")

# nicknames <- readxl::read_excel("muni_shortnames.xlsx")


# elem_schools_shp <- read_sf("https://gis.cookcountyil.gov/traditional/rest/services/clerkTaxDistricts/MapServer/2/query?outFields=*&where=1%3D1&f=geojson") %>%
#   mutate(agency_num = str_pad(AGENCY, width = "9" ,side = "left", pad = "0"))


township_shp <- read_sf("https://gis.cookcountyil.gov/traditional/rest/services/politicalBoundary/MapServer/3/query?outFields=*&where=1%3D1&f=geojson")
```

**Data Prep**


```{r eval = FALSE, include=FALSE}
ward_link <- "https://gis.cookcountyil.gov/hosting/rest/services/Hosted/Parcel2021_enhancedAll/FeatureServer/0/query?where=chicagoward%20%3D%20'49'&outFields=*&outSR=4326&f=json"


base_url <- "https://datacatalog.cookcountyil.gov/resource/tx2p-k2g9.json"

# Grab all PINs in Rogers Park in 2020
township_pins <- GET(
  base_url,
  query = list(
    tax_year = 2020,
    ward_num = 49,
   # property_city = "ROGERS PARK",
    `$select` = paste0(c("pin", "class","tax_code", "lat","lon"),
   collapse = ","),
    `$limit` = 500000L
  )
)
```

Pull all agency names that exist, then use agency numbers associated with SCHOOL types to pull only the `school_agency_names` object.

There are 946 unique taxing agencies that existed in 2021.

```{r agency-dt}
# has EAV values, extensions by agency_num
agency_dt <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT *
  FROM agency
  WHERE year = 2021
  "
)

muni_agency_names <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE minor_type = 'MUNI'
  OR agency_num = '020060000'  

  "
)

muni_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql("
  SELECT*
  FROM tax_code
  WHERE agency_num IN ({muni_agency_names$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)  
  

strings <- c( "TOWN OF ")

pattern <- str_c(strings, collapse =  " | ")

# grabs all unique muni names. Would be needed if creating a loop for calculating all munis
# municipality names and their agency number
township_agency_names <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE minor_type = 'TOWNSHIP'
  "
) %>% 
  mutate(short_name = gsub(pattern, "", agency_name),
         short_name = gsub("TOWN ", "", short_name))


township_agency_nums <- township_agency_names %>% 
  filter(minor_type == "TOWNSHIP") %>%
  select(agency_num) 


#Makes a list of ALL taxing agencies, including TIFs, SSAs, etc.

# all agency names, numbers, and types
# includes TIF and non-TIF agencies
all_taxing_agencies <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  "
) 


muni_agency_nums<- all_taxing_agencies %>% 
  filter(minor_type %in% c("MUNI") | 
           agency_num == "020060000") %>%
   select(agency_num)

school_agency_nums<- all_taxing_agencies %>% 
  filter(minor_type %in% c("ELEMENTARY")) %>%
   select(agency_num)



# muni_tax_codes <- DBI::dbGetQuery(
#   ptaxsim_db_conn,
#   glue_sql("
#   SELECT*
#   FROM tax_code
#   WHERE agency_num IN ({muni_agency_names$agency_num*})
#   AND year = 2021
#   ",
#   .con = ptaxsim_db_conn
#   )
# )# %>% select(-agency_rate)



township_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql("
  SELECT*
  FROM tax_code
  WHERE agency_num IN ({township_agency_names$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)# %>% select(-agency_rate)



# Agency number and agency name for all TIFs
TIF_agencies <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  WHERE minor_type = 'TIF'
  "
)

unique_tif_taxcodes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({TIF_agencies$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)



## Read in summarized tax code level data for exemptions and taxbills.
taxbills_by_Class_per_TC <- read_csv("./Output/2_Summed_Bills_by_Taxcode_and_Class.csv")  %>% 
  mutate(tax_code = as.character(tax_code)) 


exemptions_by_class_per_TC <- read_csv("./Output/3_Exemptions_Details_output-ClassTaxcodeExemps.csv") %>%
    mutate(tax_code_num = as.character(tax_code_num))

tif_distrib <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT *
  FROM tif_distribution
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
) %>% mutate(tax_code_num = as.character(tax_code_num))



all_taxing_agencies <- all_taxing_agencies %>% 
   left_join(township_agency_names) # %>% 
  # rename(muni_name =  agency_name.y,
  #       muni_num = agency_num.y,
  #       agency_name = agency_name.x,
  #       agency_num = agency_num.x)


# combine taxing agency names and agency type to data table that has eav and extension values
agency_data <- right_join(agency_dt, all_taxing_agencies) %>% 
  # get rid of unneeded columns to make table outputs smaller
  select(-c(cty_dupage_eav:cty_livingston_eav, lim_numerator, lim_denominator)) %>% # drop some of the unused variables
  arrange(agency_num)
```


# Proportion of Residential Land in Townships {.tabset .tabset-pills}

using the pin data from ptaxsim, I calculate the eav of all properties, exempt EAV, the current taxbase, and taxbase if there were not exemptions

-   exempt EAV (summed from all exemption types)

-   current taxbase (using the `tif_distrib` table and percent of taxcode rev that goes to the tif). If a taxcode is a TIF taxcode, then do (EAV-exempt EAV) \* (1-%rev that goes to TIF). If the tax code is not a TIF tax code, then use the EAV-exempt EAV.

-   tax base without exemptions: If a taxcode is a TIF taxcode, then do EAV \* (1-%rev that goes to TIF). If the tax code is not a TIF tax code, then use the eav


```{r}

# chi_hoods <- read_sf("https://data.cityofchicago.org/resource/igwz-8jzy.json")

class_dict <- read_csv("./Necessary_Files/class_dict_expanded.csv")

# use exemptions in tax codes to summarize EAV. 
# More accurate that calculating it from revenue collected.tax rate in tax bill data
exemptions_by_class_per_TC <- read_csv("./Output/3_Exemptions_Details_output-ClassTaxcodeExemps.csv") %>% 
  filter(class_code != "0") %>%
  left_join(class_dict) %>%
  mutate(tax_code_num = as.character(tax_code_num)) %>%
  left_join(township_tax_codes) %>%
  full_join(township_agency_names) %>%
  #.left_join(nicknames, by = c("agency_name" = "agency_name")) %>%

  # merge with TIF distrib table to calculate the percent of the EAV that goes to the TIF vs the district
  left_join(tif_distrib, by=c("tax_code_num", "year", "tax_code_rate")) %>%
  mutate(exempt_EAV = (exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
         exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate) ,
         in_TIF = ifelse(tax_code_num %in% unique_tif_taxcodes$tax_code_num, 1, 0),
         tax_base_current = ifelse(in_TIF==1, (eav-exempt_EAV)*(1-tax_code_distribution_pct/100), eav-exempt_EAV),
         tax_base_noexemps = ifelse(in_TIF==1, (eav)*(1-tax_code_distribution_pct/100), eav),
         ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Commercial"),
         PropType = case_when(
           major_class_code %in% c("3","9") ~ "Residential (C3&C9)",
           major_class_code == "2" ~ "Residential (C1)",
           TRUE~ "Commercial-Industrial"))
         
```

__Exemptions within each Townships:__


Percent Residential is the Residential EAV outside of TIFs / Township EAV outside of TIFs.


```{r}

### Shows the amount in rental vs owner occupied residential properties ### 

# grouped_exemptions <- exemptions_by_class_per_TC %>% 
#   filter(!is.na(agency_name)) %>%
#   # group_by(agency_name, major_class_code, major_class_type, ResidentialProps, PropType) %>%
#   group_by(PropType, agency_name, agency_num.x, Alea_cat)%>%
#   summarize(eav = sum(eav),
#             exempt_EAV = sum(exempt_EAV, exe_abate, na.rm=TRUE),
#             tax_base_current = sum(tax_base_current, na.rm=TRUE),
#             tax_base_noexemps = sum(tax_base_noexemps, na.rm=TRUE)) %>% ungroup() %>% 
#   select(agency_name, eav, exempt_EAV, everything()) %>% arrange(agency_name)
# 
# grouped_exemptions 



grouped_exemptions <- exemptions_by_class_per_TC %>% 
  group_by(PropType, agency_name, short_name)%>%
  summarize(eav = sum(eav),
            exempt_EAV = sum(exempt_EAV, exe_abate, na.rm=TRUE),
            tax_base_current = sum(tax_base_current, na.rm=TRUE),
            tax_base_noexemps = sum(tax_base_noexemps, na.rm=TRUE)) %>% ungroup() %>% 
  select(agency_name, eav, exempt_EAV, everything()) %>% arrange(agency_name)

grouped_exemptions 
# calculate totals with ONLY EAV outside of TIFs
TS_district_eav <- grouped_exemptions %>%  
  group_by(agency_name, short_name) %>% 
  summarize(TS_EAV_includesTIF = sum(eav), # all EAV in the municipality that exists
            TS_tax_base_current=sum(tax_base_current), # taxable EAV based on current exemptions
            TS_tax_base_noexemps = sum(tax_base_noexemps)) %>%  # taxable EAV pre-exemptions
  ungroup() 

perc_residential <- full_join(grouped_exemptions, TS_district_eav) %>% 
  filter(PropType == "Residential (C1)") %>% 
  
  mutate(percent_residential = eav / TS_EAV_includesTIF)# %>% select()


perc_residential

```



## Residential (Class 2)


The median amount of EAV from residential parcels is `r scales::percent(median(perc_residential$percent_residential))`.

```{r}
# class 2
perc_residential %>% 
  #group_by(ResidentialProps)%>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
 # left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  full_join(township_shp, b = c( "short_name" = "NAME") ) %>%
  ggplot(aes(fill = percent_residential)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  labs(title = "Residential EAV /  Total EAV in Township", caption = "The median township has 67.3% of its EAV from Class 2 Residential Properties") +
  theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+# +#+
  scale_fill_steps2(
    high = "darkblue", low = "black",  #  guide = "legend",
    midpoint = median(perc_residential$percent_residential),
    show.limits=TRUE,
    na.value = NA,
    name = "% Residential",
    labels = scales::percent)
```




# Taxable Base and Land Use

Tax base in the tables above are the total EAV outside of TIF areas.

```{r}
TC_bills_current <- read_csv("./Output/2_Summed_Bills_by_Taxcode_and_Class.csv") %>% 
  filter(class != "0") %>% 
  mutate(tax_code = as.character(tax_code),
         class = as.character(class))

class_dict$class_code <- as.character(class_dict$class_code)
 

taxcodes_current <- TC_bills_current %>% 
  filter(tax_code %in% township_tax_codes$tax_code_num) %>% 
  left_join(township_tax_codes, by = c("tax_code" = "tax_code_num")) %>%
  left_join(muni_tax_codes) %>%   
  left_join(township_agency_names
            ) %>% #  by = c("tax_code" = "tax_code_num")) %>%
  left_join(muni_agency_names)  

Current_Taxrates <- taxcodes_current %>% 

  #left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
#  filter(!agency_num %in% cross_county_lines) %>%
  group_by(agency_name, short_name, agency_num) %>%
  summarize(TownshipLevy = sum(final_tax_to_dist, na.rm = TRUE), # amount billed by tax districts with current exemptions in place
            nonTIF_EAV_post_exemps = sum(final_tax_to_dist/(tax_code_rate/100), na.rm = TRUE),
            TIF_increment_EAV = sum(final_tax_to_tif/(tax_code_rate/100), na.rm=TRUE),  
            Exempt_EAV = sum(tax_amt_exe/(tax_code_rate/100), na.rm=TRUE), 
            Total_EAV = sum((tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100), na.rm = TRUE)) %>%

  mutate(tax_rate_current = TownshipLevy/nonTIF_EAV_post_exemps,
         nonTIF_EAV_pre_exemps = nonTIF_EAV_post_exemps + Exempt_EAV,
         taxrate_new = TownshipLevy/nonTIF_EAV_pre_exemps,
         taxrate_change = tax_rate_current-taxrate_new) %>% 
  select(short_name, taxrate_change, tax_rate_current, taxrate_new, everything()) %>% 
  arrange(desc(tax_rate_current))

# land_use <- taxcodes_current %>% 
#   left_join(muni_agency_names) %>% 
#   left_join(Current_Taxrates) %>%
#   left_join(class_dict, by = c("class" = "class_code")) %>%
# 
#   mutate(class_1dig = str_sub(class, 1, 1),
#     ResidentialProps = ifelse(class_1dig %in% c("2", "3", "9"), "Residential", "Non-Residential")) %>%
#   #        PropType = case_when(
#   #          major_class_code %in% c("3","9") ~ "Multi-Family",
#   #          major_class_code == "2" ~ "Single-Family",
#   #          TRUE ~ "Commercial-Industrial")) %>%
#   group_by(clean_name, Alea_cat, agency_num, tax_rate_current, taxrate_new, taxrate_change, agency_name) %>% 
#   
#   # All of the values calculated below are AFTER exemptions have been removed
#   summarize(taxrev_from_proptype = sum(final_tax_to_dist, na.rm = TRUE),
#             nonTIF_EAV = sum(final_tax_to_dist/(tax_code_rate/100), na.rm = TRUE),
#             TIF_increment_EAV = sum(final_tax_to_tif/(tax_code_rate/100), na.rm=TRUE),
#             Exempt_EAV = sum(tax_amt_exe/(tax_code_rate/100), na.rm=TRUE),
#             Total_EAV = sum((tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100), na.rm = TRUE) ) %>% ungroup()

Current_Taxrates

write_csv(Current_Taxrates, "./Output/11_Township_Composite_Taxrates.csv")
```

Current composite tax rates for each township are above. Table also includes the new tax rate if there were no exemptions, the levy (aka amount collected by the district from final_tax_to_dist variable), EAV outside of TIFs, amount of exempt EAV, and additional variables.


```{r}
# 
# grouped_exemptions <- exemptions_by_class_per_TC %>% 
#    # group_by(agency_name, major_class_code, major_class_type, ResidentialProps, PropType) %>%
#   group_by(clean_name, Alea_cat, agency_name) %>%
#   summarize(eav = sum(eav),
#            exempt_EAV = sum(exempt_EAV, exe_abate, na.rm=TRUE),
#          tax_base_current = sum(tax_base_current, na.rm=TRUE),
#          tax_base_noexemps = sum(tax_base_noexemps, na.rm=TRUE)) %>% ungroup()
#   

# calculate totals with ONLY EAV outside of TIFs
township_dist_eav <- grouped_exemptions %>%  
  group_by(agency_name, short_name) %>% 
  summarize(TS_EAV_includesTIF = sum(eav), # all EAV in the municipality that exists
            TS_tax_base_current=sum(tax_base_current), # taxable EAV based on current exemptions
            TS_tax_base_noexemps = sum(tax_base_noexemps)) %>%  # taxable EAV pre-exemptions
  ungroup() 

pct_property_types <- left_join(grouped_exemptions, township_dist_eav) %>%
 # filter(ResidentialProps == "Alea_cat") %>% 
  mutate(pct_PropType = eav / TS_EAV_includesTIF)# %>% select()

pct_property_types


burden_table <- pct_property_types %>% 
  left_join(Current_Taxrates) %>%
  mutate(rev_collected_current = tax_base_current * tax_rate_current,
         rev_collected_new = tax_base_noexemps*taxrate_new,
         burden_current = rev_collected_current/TownshipLevy,
         burden_noexemps = rev_collected_new/TownshipLevy, 
         burden_change = burden_noexemps- burden_current,
         burden_noexemps = ifelse(burden_noexemps >1, 1, burden_noexemps)) %>%
  mutate(burden_current = ifelse(is.na(burden_current), 0, burden_current),
         burden_noexemps = ifelse(is.na(burden_noexemps), 0, burden_noexemps)) %>%
  mutate(burden_noexemps = ifelse(burden_noexemps>1, 1, burden_noexemps),
         burden_current = ifelse(burden_current>1, 1, burden_current)) %>%
  mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) )


burden_shift <- burden_table # only to not change code below in graphs. 
```

```{r}
Current_Taxrates %>% 
   # mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  full_join(township_shp, by = c("short_name" = "NAME")) %>%
  ggplot(aes(fill = tax_rate_current)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  labs(title = "Composite Tax Rate  for Townships", 
       caption = "The median township taxrate outside of Chicago has a composite tax rate around 11.1%") +
    theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+# +#+
    scale_fill_steps2(
    high = "darkblue", low = "black",  #  guide = "legend",
      midpoint = median(Current_Taxrates$tax_rate_current),
  #                      n.breaks = 6,
  show.limits=TRUE,
  na.value = NA,
                        name = "Composite Tax Rate",
  labels = scales::percent)
```

```{r}
taxcodes_current %>% 
  summarise(
    bill_reduced = sum(tax_amt_exe))
```

For Townships (excluding Chicago) in 2021, there was $1.03 billion in "forgone" revenue due to current exempt EAV. Exempt EAV * tax rate at the tax code level is used for calculation.  


# Class 8 Incentives


## Townships with Class 8 Properties

My first calculation: Filtered for all properties that had 800 level properties.

Probably not correct....


```{r}

exemptions_by_class_per_TC <- read_csv("./Output/3_Exemptions_Details_output-ClassTaxcodeExemps.csv") %>% 
  mutate(class_code = as.character(class_code)) %>%
  filter(class_code >=800 & class_code <900) %>%
  left_join(class_dict) %>%
  mutate(tax_code_num = as.character(tax_code_num)) %>%
  left_join(township_tax_codes) %>%
  full_join(township_agency_names) %>%
  #.left_join(nicknames, by = c("agency_name" = "agency_name")) %>%

  # merge with TIF distrib table to calculate the percent of the EAV that goes to the TIF vs the district
  left_join(tif_distrib, by=c("tax_code_num", "year", "tax_code_rate")) %>%
  mutate(exempt_EAV = (exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
         exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate) ,
         in_TIF = ifelse(tax_code_num %in% unique_tif_taxcodes$tax_code_num, 1, 0),
         tax_base_current = ifelse(in_TIF==1, (eav-exempt_EAV)*(1-tax_code_distribution_pct/100), eav-exempt_EAV),
         tax_base_noexemps = ifelse(in_TIF==1, (eav)*(1-tax_code_distribution_pct/100), eav),
         ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Commercial"),
         PropType = case_when(
           major_class_code %in% c("3","9") ~ "Residential (C3&C9)",
           major_class_code == "2" ~ "Residential (C1)",
           TRUE~ "Commercial-Industrial"))

exemptions_by_class_per_TC



class8Townships = read_csv("./Output/3_Exemptions_Details_output-ClassTaxcodeExemps.csv") %>% 
  mutate(class_code = as.character(class_code)) %>%
  filter(class_code >=800 & class_code <900) %>%
  left_join(class_dict) %>%
  mutate(tax_code_num = as.character(tax_code_num)) %>%
  left_join(township_tax_codes) %>%
  left_join(township_agency_names)%>% 
  distinct(agency_name) 

C8_exemptions <- read_csv("./Output/3_Exemptions_Details_output-ClassTaxcodeExemps.csv") %>% 
  mutate(class_code = as.character(class_code)) %>%
  filter(class_code !=0) %>%
  left_join(class_dict) %>%
  mutate(tax_code_num = as.character(tax_code_num)) %>%
  left_join(township_tax_codes) %>%
  left_join(township_agency_names)%>% 
  left_join(tif_distrib, by=c("tax_code_num", "year", "tax_code_rate")) %>%
  
  filter(agency_name %in% class8Townships$agency_name) %>% 
  mutate(exempt_EAV = (exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
         exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate) ,
         in_TIF = ifelse(tax_code_num %in% unique_tif_taxcodes$tax_code_num, 1, 0),
         tax_base_current = ifelse(in_TIF==1, (eav-exempt_EAV)*(1-tax_code_distribution_pct/100), eav-exempt_EAV),
         tax_base_noexemps = ifelse(in_TIF==1, (eav)*(1-tax_code_distribution_pct/100), eav),
         ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Commercial"),
         PropType = case_when(
           major_class_code %in% c("3","9") ~ "Residential (C3&C9)",
           major_class_code == "2" ~ "Residential (C1)",
           TRUE~ "Commercial-Industrial"))

C8_exemptions
```

```{r}
TC_bills_current <- read_csv("./Output/2_Summed_Bills_by_Taxcode_and_Class.csv") %>% 
  filter(class != "0") %>% 
  mutate(tax_code = as.character(tax_code),
         class = as.character(class))

class_dict$class_code <- as.character(class_dict$class_code)
 

taxcodes_current <- TC_bills_current %>% 
  left_join(township_tax_codes, by = c("tax_code" = "tax_code_num")) %>%
  left_join(muni_tax_codes) %>%   
  left_join(township_agency_names) %>% #  by = c("tax_code" = "tax_code_num")) %>%
  left_join(muni_agency_names)  %>%  
  filter(agency_name %in% class8Townships$agency_name) 


Current_Taxrates <- taxcodes_current %>% 

  #left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
#  filter(!agency_num %in% cross_county_lines) %>%
  group_by(agency_name, short_name, agency_num) %>%
  summarize(TownshipLevy = sum(final_tax_to_dist, na.rm = TRUE), # amount billed by tax districts with current exemptions in place
            nonTIF_EAV_post_exemps = sum(final_tax_to_dist/(tax_code_rate/100), na.rm = TRUE),
            TIF_increment_EAV = sum(final_tax_to_tif/(tax_code_rate/100), na.rm=TRUE),  
            Exempt_EAV = sum(tax_amt_exe/(tax_code_rate/100), na.rm=TRUE), 
            Total_EAV = sum((tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100), na.rm = TRUE)) %>%

  mutate(tax_rate_current = TownshipLevy/nonTIF_EAV_post_exemps,
         nonTIF_EAV_pre_exemps = nonTIF_EAV_post_exemps + Exempt_EAV,
         taxrate_new = TownshipLevy/nonTIF_EAV_pre_exemps,
         taxrate_change = tax_rate_current-taxrate_new) %>% 
  select(short_name, taxrate_change, tax_rate_current, taxrate_new, everything()) %>% 
  arrange(desc(tax_rate_current))





Current_Taxrates

Current_Taxrates %>% 
  mutate(#rev_forgone = Exempt_EAV*taxrate_new,
         # taxrate if there were no exemptions applied to taxable EAV. 
         # external funding source covers "forgone revenue" to prevent the indirect effect of higher tax rates on all property classes
         rev_collected_new = nonTIF_EAV_post_exemps*taxrate_new,
         rev_collected_current = nonTIF_EAV_post_exemps*tax_rate_current,
         LevyGap = rev_collected_current-rev_collected_new) %>% 
  select(short_name, LevyGap, rev_collected_new, rev_collected_current, TownshipLevy, everything())



Current_Taxrates %>% 
  mutate(#rev_forgone = Exempt_EAV*taxrate_new,
         # taxrate if there were no exemptions applied to taxable EAV. 
         # external funding source covers "forgone revenue" to prevent the indirect effect of higher tax rates on all property classes
         rev_collected_new = nonTIF_EAV_post_exemps*taxrate_new,
         rev_collected_current = nonTIF_EAV_post_exemps*tax_rate_current,
         LevyGap = rev_collected_current-rev_collected_new) %>% 
  select(short_name, LevyGap, rev_collected_new, rev_collected_current, TownshipLevy, everything()) %>% 
  ungroup() %>% 
  summarize(C8_TS_Cost = sum(LevyGap, na.rm = TRUE))



taxcodes_current %>% 

  #left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
#  filter(!agency_num %in% cross_county_lines) %>%
 # group_by(agency_name, short_name, agency_num) %>%
  mutate(TownshipLevy = final_tax_to_dist, # amount billed by tax districts with current exemptions in place
            nonTIF_EAV_post_exemps = final_tax_to_dist/(tax_code_rate/100),
            TIF_increment_EAV = final_tax_to_tif/(tax_code_rate/100),  
            Exempt_EAV = tax_amt_exe/(tax_code_rate/100), 
            Total_EAV = (tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100)) %>%

  mutate(tax_rate_current = TownshipLevy/nonTIF_EAV_post_exemps,
         nonTIF_EAV_pre_exemps = nonTIF_EAV_post_exemps + Exempt_EAV,
         taxrate_new = TownshipLevy/nonTIF_EAV_pre_exemps,
         taxrate_change = tax_rate_current-taxrate_new,
         rev_collected = nonTIF_EAV_post_exemps * taxrate_new, # if exemptions were granted but tax rate did not go up to meet levy gap
         gap = round(TownshipLevy-rev_collected) # external funds needed to avoid raising tax rates
         ) %>% 
  select(short_name, tax_code, gap, TownshipLevy, rev_collected, everything()) %>% 
  arrange(desc(tax_rate_current))



taxcodes_current %>% 

  #left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
#  filter(!agency_num %in% cross_county_lines) %>%
 # group_by(agency_name, short_name, agency_num) %>%
  mutate(TownshipLevy = final_tax_to_dist, # amount billed by tax districts with current exemptions in place
            nonTIF_EAV_post_exemps = final_tax_to_dist/(tax_code_rate/100),
            TIF_increment_EAV = final_tax_to_tif/(tax_code_rate/100),  
            Exempt_EAV = tax_amt_exe/(tax_code_rate/100), 
            Total_EAV = (tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100)) %>%

  mutate(tax_rate_current = TownshipLevy/nonTIF_EAV_post_exemps,
         nonTIF_EAV_pre_exemps = nonTIF_EAV_post_exemps + Exempt_EAV,
         taxrate_new = TownshipLevy/nonTIF_EAV_pre_exemps,
         taxrate_change = tax_rate_current-taxrate_new,
         rev_collected = nonTIF_EAV_post_exemps * taxrate_new, # if exemptions were granted but tax rate did not go up to meet levy gap
         gap = round(TownshipLevy-rev_collected) # external funds needed to avoid raising tax rates
         ) %>% 
  select(short_name, tax_code, gap, TownshipLevy, rev_collected, everything()) %>% 
  arrange(desc(tax_rate_current)) %>%
  summarize(total_gap = sum(gap, na.rm = TRUE))
```

For townships that had  Class 8 incentive property classes within their tax codes, $440 million in external revenue is needed to prevent the unintended effects of exemptions (i.e. \$440 million necessary to prevent the increase in tax rates necessary to collect enough revenue for taxing districts' levies). This shift in tax burden occurs due to the increased tax rate necessary to meet the taxing districts' levies after the taxable EAV is decreased.  

The "cost" of exemptions in Townships that receive class 8 incentives is \$440 million. This value was calculated using the current taxable EAV in the townships (non-TIF increment, post exemption taxable EAV) and multiplied by the hypothetical tax rate if there were no exemptions. Instead of raising the tax rate to collect the rest of the necessary revenue to meet the levies requested, external revenue is transferred to the taxing districts. This prevents the need to raise tax rates on all property classes and prevents the unintended effects of providing exemptions that have been occurring within Cook County. 


```{r}
Current_Taxrates %>% 
  mutate(rev_forgone = Exempt_EAV*taxrate_new,
         # taxrate if there were no exemptions applied to taxable EAV. 
         # external funding source covers "forgone revenue" to prevent the indirect effect of higher tax rates on all property classes
         rev_collected = nonTIF_EAV_post_exemps*taxrate_new) %>% 
  select(short_name, rev_forgone, rev_collected, TownshipLevy, everything()) %>%
  # mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  full_join(township_shp, by = c("short_name" = "NAME")) %>%
  ggplot(aes(fill = rev_forgone)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  labs(title = "External Funds Needed to Prevent Exemption Externalities",
       subtitle = "Gap between Levy and Revenue Collected",
       
       caption = "Amount of revenue collected is the taxable EAV after exemptions * hypothetical 
       \"no exemption\" tax rate.Additional money must come from somewhere in order 
       to meet the  taxing districts' levies if tax rates are not raised."
  ) +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+# +#+
    scale_fill_steps2(
    high = "darkblue", low = "black",  #  guide = "legend",
    #  midpoint = median(Current_Taxrates$tax_rate_current),
  #                      n.breaks = 6,
  show.limits=TRUE,
  na.value = NA,
                        name = "Additional Revenue Needed",
  labels = scales::dollar)
```



## Class 8 Incentive Townships (5 Townships)


Include only Bloom, Bremen, Calumet, Rich, Thornton. 


```{r}

C8_ships <- c("TOWN BLOOM", "TOWN BREMEN", "TOWN CALUMET", "TOWN RICH", "TOWN THORNTON")


exemptions_by_class_per_TC <- read_csv("./Output/3_Exemptions_Details_output-ClassTaxcodeExemps.csv") %>% 
  mutate(class_code = as.character(class_code)) %>%
  filter(class_code >=800 & class_code <900) %>%
  left_join(class_dict) %>%
  mutate(tax_code_num = as.character(tax_code_num)) %>%
  left_join(township_tax_codes) %>%
  full_join(township_agency_names) %>%
  filter(agency_name %in%  C8_ships) %>%

  #.left_join(nicknames, by = c("agency_name" = "agency_name")) %>%

  # merge with TIF distrib table to calculate the percent of the EAV that goes to the TIF vs the district
  left_join(tif_distrib, by=c("tax_code_num", "year", "tax_code_rate")) %>%
  mutate(exempt_EAV = (exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
         exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate) ,
         in_TIF = ifelse(tax_code_num %in% unique_tif_taxcodes$tax_code_num, 1, 0),
         tax_base_current = ifelse(in_TIF==1, (eav-exempt_EAV)*(1-tax_code_distribution_pct/100), eav-exempt_EAV),
         tax_base_noexemps = ifelse(in_TIF==1, (eav)*(1-tax_code_distribution_pct/100), eav),
         ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Commercial"),
         PropType = case_when(
           major_class_code %in% c("3","9") ~ "Residential (C3&C9)",
           major_class_code == "2" ~ "Residential (C1)",
           TRUE~ "Commercial-Industrial"))

exemptions_by_class_per_TC

class8Townships = read_csv("./Output/3_Exemptions_Details_output-ClassTaxcodeExemps.csv") %>% 
  mutate(class_code = as.character(class_code)) %>%
  filter(class_code >=800 & class_code <900) %>%
  left_join(class_dict) %>%
  mutate(tax_code_num = as.character(tax_code_num)) %>%
  left_join(township_tax_codes) %>%
  left_join(township_agency_names)%>% 
    filter(agency_name %in%  C8_ships) %>%

  distinct(agency_name)


C8_exemptions <- read_csv("./Output/3_Exemptions_Details_output-ClassTaxcodeExemps.csv") %>% 
  mutate(class_code = as.character(class_code)) %>%
  filter(class_code !=0) %>%
  left_join(class_dict) %>%
  mutate(tax_code_num = as.character(tax_code_num)) %>%
  left_join(township_tax_codes) %>%
  left_join(township_agency_names)%>% 
  left_join(tif_distrib, by=c("tax_code_num", "year", "tax_code_rate")) %>%
    filter(agency_name %in%  C8_ships) %>%

  
 # filter(agency_name %in% class8Townships$agency_name) %>% 
  mutate(exempt_EAV = (exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
         exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate) ,
         in_TIF = ifelse(tax_code_num %in% unique_tif_taxcodes$tax_code_num, 1, 0),
         tax_base_current = ifelse(in_TIF==1, (eav-exempt_EAV)*(1-tax_code_distribution_pct/100), eav-exempt_EAV),
         tax_base_noexemps = ifelse(in_TIF==1, (eav)*(1-tax_code_distribution_pct/100), eav),
         ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Commercial"),
         PropType = case_when(
           major_class_code %in% c("3","9") ~ "Residential (C3&C9)",
           major_class_code == "2" ~ "Residential (C1)",
           TRUE~ "Commercial-Industrial"))

C8_exemptions
```
```{r}
TC_bills_current <- read_csv("./Output/2_Summed_Bills_by_Taxcode_and_Class.csv") %>% 
  filter(class != "0") %>% 
  mutate(tax_code = as.character(tax_code),
         class = as.character(class))

class_dict$class_code <- as.character(class_dict$class_code)
 

taxcodes_current <- TC_bills_current %>% 
  left_join(township_tax_codes, by = c("tax_code" = "tax_code_num")) %>%
  left_join(muni_tax_codes) %>%   
  left_join(township_agency_names) %>% #  by = c("tax_code" = "tax_code_num")) %>%
  left_join(muni_agency_names)  %>%  
    filter(agency_name %in%  C8_ships)# %>%

 # filter(agency_name %in% class8Townships$agency_name) 


Current_Taxrates <- taxcodes_current %>% 

  #left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
#  filter(!agency_num %in% cross_county_lines) %>%
  group_by(agency_name, short_name, agency_num) %>%
  summarize(TownshipLevy = sum(final_tax_to_dist, na.rm = TRUE), # amount billed by tax districts with current exemptions in place
            nonTIF_EAV_post_exemps = sum(final_tax_to_dist/(tax_code_rate/100), na.rm = TRUE),
            TIF_increment_EAV = sum(final_tax_to_tif/(tax_code_rate/100), na.rm=TRUE),  
            Exempt_EAV = sum(tax_amt_exe/(tax_code_rate/100), na.rm=TRUE), 
            Total_EAV = sum((tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100), na.rm = TRUE)) %>%

  mutate(tax_rate_current = TownshipLevy/nonTIF_EAV_post_exemps,
         nonTIF_EAV_pre_exemps = nonTIF_EAV_post_exemps + Exempt_EAV,
         taxrate_new = TownshipLevy/nonTIF_EAV_pre_exemps,
         taxrate_change = tax_rate_current-taxrate_new) %>% 
  select(short_name, taxrate_change, tax_rate_current, taxrate_new, everything()) %>% 
  arrange(desc(tax_rate_current))





Current_Taxrates

Current_Taxrates %>% 
  mutate(#rev_forgone = Exempt_EAV*taxrate_new,
         # taxrate if there were no exemptions applied to taxable EAV. 
         # external funding source covers "forgone revenue" to prevent the indirect effect of higher tax rates on all property classes
         rev_collected_new = nonTIF_EAV_post_exemps*taxrate_new,
         rev_collected_current = nonTIF_EAV_post_exemps*tax_rate_current,
         LevyGap = rev_collected_current-rev_collected_new) %>% 
  select(short_name, LevyGap, rev_collected_new, rev_collected_current, TownshipLevy, everything())



Current_Taxrates %>% 
  mutate(#rev_forgone = Exempt_EAV*taxrate_new,
         # taxrate if there were no exemptions applied to taxable EAV. 
         # external funding source covers "forgone revenue" to prevent the indirect effect of higher tax rates on all property classes
         rev_collected_new = nonTIF_EAV_post_exemps*taxrate_new,
         rev_collected_current = nonTIF_EAV_post_exemps*tax_rate_current,
         LevyGap = rev_collected_current-rev_collected_new) %>% 
  select(short_name, LevyGap, rev_collected_new, rev_collected_current, TownshipLevy, everything()) %>% 
  ungroup() %>% 
  summarize(C8_TS_Cost = sum(LevyGap, na.rm = TRUE))



taxcodes_current %>% 

  #left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
#  filter(!agency_num %in% cross_county_lines) %>%
 # group_by(agency_name, short_name, agency_num) %>%
  mutate(TownshipLevy = final_tax_to_dist, # amount billed by tax districts with current exemptions in place
            nonTIF_EAV_post_exemps = final_tax_to_dist/(tax_code_rate/100),
            TIF_increment_EAV = final_tax_to_tif/(tax_code_rate/100),  
            Exempt_EAV = tax_amt_exe/(tax_code_rate/100), 
            Total_EAV = (tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100)) %>%

  mutate(tax_rate_current = TownshipLevy/nonTIF_EAV_post_exemps,
         nonTIF_EAV_pre_exemps = nonTIF_EAV_post_exemps + Exempt_EAV,
         taxrate_new = TownshipLevy/nonTIF_EAV_pre_exemps,
         taxrate_change = tax_rate_current-taxrate_new,
         rev_collected = nonTIF_EAV_post_exemps * taxrate_new, # if exemptions were granted but tax rate did not go up to meet levy gap
         gap = round(TownshipLevy-rev_collected) # external funds needed to avoid raising tax rates
         ) %>% 
  select(short_name, tax_code, gap, TownshipLevy, rev_collected, everything()) %>% 
  arrange(desc(tax_rate_current))



taxcodes_current %>% 

  #left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
#  filter(!agency_num %in% cross_county_lines) %>%
 # group_by(agency_name, short_name, agency_num) %>%
  mutate(TownshipLevy = final_tax_to_dist, # amount billed by tax districts with current exemptions in place
            nonTIF_EAV_post_exemps = final_tax_to_dist/(tax_code_rate/100),
            TIF_increment_EAV = final_tax_to_tif/(tax_code_rate/100),  
            Exempt_EAV = tax_amt_exe/(tax_code_rate/100), 
            Total_EAV = (tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100)) %>%

  mutate(tax_rate_current = TownshipLevy/nonTIF_EAV_post_exemps,
         nonTIF_EAV_pre_exemps = nonTIF_EAV_post_exemps + Exempt_EAV,
         taxrate_new = TownshipLevy/nonTIF_EAV_pre_exemps,
         taxrate_change = tax_rate_current-taxrate_new,
         rev_collected = nonTIF_EAV_post_exemps * taxrate_new, # if exemptions were granted but tax rate did not go up to meet levy gap
         gap = round(TownshipLevy-rev_collected) # external funds needed to avoid raising tax rates
         ) %>% 
  select(short_name, tax_code, gap, TownshipLevy, rev_collected, everything()) %>% 
  arrange(desc(tax_rate_current)) %>%
  summarize(total_gap = sum(gap, na.rm = TRUE))
```

For the 5 townships listed as receiving Class 8 Incentives, $195 million in external revenue is needed to prevent the unintended effects of exemptions (i.e. \$195 million necessary to prevent the increase in tax rates necessary to collect enough revenue for taxing districts' levies). This shift in tax burden occurs due to the increased tax rate necessary to meet the taxing districts' levies after the taxable EAV is decreased.  

The "cost" of exemptions in Townships that receive class 8 incentives is \$195 million. This value was calculated using the current taxable EAV in the townships (non-TIF increment, post exemption taxable EAV) and multiplied by the hypothetical tax rate if there were no exemptions. Instead of raising the tax rate to collect the rest of the necessary revenue to meet the levies requested, external revenue is transferred to the taxing districts. This prevents the need to raise tax rates on all property classes and prevents the unintended effects of providing exemptions that have been occurring within Cook County. 


```{r}
Current_Taxrates %>% 
  mutate(rev_forgone = Exempt_EAV*taxrate_new,
         # taxrate if there were no exemptions applied to taxable EAV. 
         # external funding source covers "forgone revenue" to prevent the indirect effect of higher tax rates on all property classes
         rev_collected = nonTIF_EAV_post_exemps*taxrate_new) %>% 
  select(short_name, rev_forgone, rev_collected, TownshipLevy, everything()) %>%
  # mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  full_join(township_shp, by = c("short_name" = "NAME")) %>%
  ggplot(aes(fill = rev_forgone)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  labs(title = "External Funds Needed to Prevent Exemption Externalities",
       subtitle = "Gap between Levy and Revenue Collected",
       caption = "Amount of revenue collected is the taxable EAV after exemptions * hypothetical 
       \"no exemption\" tax rate.Additional money must come from somewhere in order 
       to meet the  taxing districts' levies if tax rates are not raised."
  ) +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+# +#+
    scale_fill_steps2(
    high = "darkblue", low = "black",  #  guide = "legend",
    #  midpoint = median(Current_Taxrates$tax_rate_current),
  #                      n.breaks = 6,
  show.limits=TRUE,
  na.value = NA,
                        name = "Additional Revenue Needed",
  labels = scales::dollar)
```

