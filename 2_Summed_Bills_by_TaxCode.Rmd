---
title: "Calculate all Pin Bills for 2021"
author: "Alea Wilbur"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    df_print: paged
    code_download: true
---

# Get Pin and Tax Bill Data

Run file `1_Get_All_Pin_Bills.Rmd` to replicate pulling the 2021 bills.

```{r setup}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)


library(tidyverse)
library(DBI)
library(data.table)
library(ggspatial)
library(gstat)
library(here)
library(httr)
library(jsonlite)
library(ptaxsim)
library(sf)
library(stars)
library(glue)

# Create the DB connection with the default name expected by PTAXSIM functions
ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), "./ptaxsim.db/ptaxsim-2021.0.4.db")


options(digits=4, scipen = 999)

library(sf)
library(jsonlite)
library(httr)

# link to the API output as a JSON file
#muni_shp <- read_sf("https://gis.cookcountyil.gov/traditional/rest/services/politicalBoundary/MapServer/2/query?outFields=*&where=1%3D1&f=geojson")

#muni_shp <- read_json("muni_shp.json")
nicknames <- readxl::read_excel("muni_shortnames.xlsx")

class_dict <- read_csv("class_dict.csv")



```


```{r agency-dt}
# has EAV values, extensions by agency_num
agency_dt <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT *
  FROM agency
  WHERE year = 2021
  "
)

# grabs all unique muni names & numbs
# don't forget Cicero
muni_agency_names <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE minor_type = 'MUNI'
  OR agency_num = '020060000'  

  "
)

muni_agency_names <- muni_agency_names %>% 
    mutate(first6 = str_sub(agency_num,1,6),
         first5 = str_sub(agency_num,1,5)) %>% 
  select(-minor_type)



#Makes a list of ALL taxing agencies, including TIFs, SSAs, etc.

# all agency names, numbers, and types
# includes TIF and non-TIF agencies
all_taxing_agencies <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  "
) %>% mutate(first6 = str_sub(agency_num,1,6),
         first5 = str_sub(agency_num,1,5))


muni_agency_nums<- all_taxing_agencies %>% 
  filter(minor_type %in% c("MUNI") | 
           agency_num == "020060000") %>%
   select(agency_num)


# list of all taxcodes in municipalities. 
# This does NOT include unincorporated tax codes!!
muni_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql("
  SELECT*
  FROM tax_code
  WHERE agency_num IN ({muni_agency_names$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)# %>% select(-agency_rate)

# Agency number and agency name for all TIFs
TIF_agencies <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  WHERE minor_type = 'TIF'
  "
)

unique_tif_taxcodes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({TIF_agencies$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)


tif_distrib <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT *
  FROM tif_distribution
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
) %>% mutate(tax_code_num = as.character(tax_code_num))



all_taxing_agencies <- all_taxing_agencies %>% 
  left_join(muni_agency_names, by = c("first5", "first6")) %>% 
  rename(muni_name =  agency_name.y,
        muni_num = agency_num.y,
        agency_name = agency_name.x,
        agency_num = agency_num.x)


# combine taxing agency names and agency type to data table that has eav and extension values
agency_data <- right_join(agency_dt, all_taxing_agencies) %>% 
  # get rid of unneeded columns to make table outputs smaller
  select(-c(cty_dupage_eav:cty_livingston_eav)) %>% # drop some of the unused variables
  arrange(agency_num)
```

## Summing Tax Code level Values

using the pin data from ptaxsim, I calculate the eav of all properties, exempt EAV, the current tax base, and tax base if there were not exemptions

-   exempt EAV (summed from all exemption types)

-   current taxbase (using the `tif_distrib` table and percent of taxcode rev that goes to the tif). If a taxcode is a TIF taxcode, then do (EAV-exempt EAV) \* (1-%rev that goes to TIF). If the tax code is not a TIF tax code, then use the EAV-exempt EAV.

-   tax base without exemptions: If a taxcode is a TIF taxcode, then do EAV \* (1-%rev that goes to TIF). If the tax code is not a TIF tax code, then use the eav




```{r}
taxbills_current <- read_csv("Get_All_Pins-AllPinTaxbills_2021_Actual.csv")
# 22,453,875 tax bills in 2021 in municipalities. 
# DOES NOT INCLUDE unincorporated tax bills based on how we pulled the data in Step 1.

sapply(taxbills_current, function(x) sum(is.na(x)))


# 1,825,816 billed properties with 14-digit PINs  
pin14_bills_current <- taxbills_current %>%
  group_by(tax_code, class, pin) %>%
  
  mutate(total_bill = final_tax_to_dist + final_tax_to_tif) %>% # from each taxing agency
  
  summarize(total_billed = sum(total_bill, na.rm = TRUE), # total on someone's property tax bill
   av = first(av),
   eav = first(eav),
   pin_count_in_parcel = n(),
            final_tax_to_dist = sum(final_tax_to_dist, na.rm = TRUE),
            final_tax_to_tif = sum(final_tax_to_tif, na.rm = TRUE),
            tax_amt_exe = sum(tax_amt_exe, na.rm = TRUE), # revenue lost due to exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe, na.rm = TRUE), # total rev before all exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe, na.rm = TRUE), # total rev after all exemptions
        rpm_tif_to_cps = sum(rpm_tif_to_cps, na.rm = TRUE), # not used
        rpm_tif_to_rpm = sum(rpm_tif_to_rpm, na.rm=TRUE), # not used
         rpm_tif_to_dist = sum(rpm_tif_to_dist, na.rm=TRUE), # not used
          tif_share = mean(tif_share, na.rm=TRUE), # not used
       )  %>% 
  mutate(propclass_2dig = str_sub(class, 1, 2))

head(pin14_bills_current)

sapply(pin14_bills_current, function(x) sum(is.na(x)))


write_csv(pin14_bills_current, "2_Summed_Bills_output-14digitPinSums")
```

```{r}
table(taxbills_current$class)
```


```{r}
# 1,386,803 10-digit pins. Equivalent to the parcel or building footprint 
# values grouped like this are needed to map the parcels 

pin10_bills_current <- pin14_bills_current %>%
  mutate(pin10 = str_sub(pin, 1, 10)) %>%
  group_by(tax_code, class, pin10) %>%
  mutate(total_bill = final_tax_to_dist + final_tax_to_tif) %>%
  
  summarize(total_billed = sum(total_bill, na.rm = TRUE),
   av = sum(av), # changed from first() to sum() on 7/28/2023. Probably results in different output.......
   eav = sum(eav), # these would be parcel sums. All eav in the building or parcel for multi-unit buildings
   pin_count_in_parcel = n(),
            final_tax_to_dist = sum(final_tax_to_dist, na.rm = TRUE),
            final_tax_to_tif = sum(final_tax_to_tif, na.rm = TRUE),
            tax_amt_exe = sum(tax_amt_exe, na.rm = TRUE), # revenue lost due to exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe, na.rm = TRUE), # total rev before all exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe, na.rm = TRUE), # total rev after all exemptions
        rpm_tif_to_cps = sum(rpm_tif_to_cps, na.rm = TRUE), # not used
        rpm_tif_to_rpm = sum(rpm_tif_to_rpm, na.rm=TRUE), # not used
         rpm_tif_to_dist = sum(rpm_tif_to_dist, na.rm=TRUE), # not used
          tif_share = mean(tif_share, na.rm=TRUE), 
       )  %>% mutate(propclass_2dig = str_sub(class, 1, 2)) 


head(pin10_bills_current)

pin10_bills_current <- pin10_bills_current %>%  
  mutate(tax_code = as.character(tax_code)) %>%
  full_join(muni_tax_codes, 
                      by = c("tax_code" = "tax_code_num")) %>%
  left_join(muni_agency_names) %>%
  left_join(nicknames) %>%

  mutate(parcel_bill_total = final_tax_to_tif + final_tax_to_dist)

write_csv(pin10_bills_current, "2_Summed_Bills_output-10digitParcelSums")

head(pin10_bills_current)
tail(pin10_bills_current)


# numbe of missing values in each variable:
sapply(pin10_bills_current, function(x) sum(is.na(x)))

```


Now group again and sum values for tax code and each property class!

There are 28,381 property class - tax code group combinations. 

```{r}
taxcodes_by_class_current <- pin10_bills_current %>% 
  ungroup() %>%
  group_by(tax_code, class)  %>%
  
  summarize(
   av = sum(av), # changed from first() to sum() on 7/28/2023. Probably results in different output.......
   eav = sum(eav),
   pins_in_class = sum(pin_count_in_parcel),
   parcel_count_in_class = n(),
            final_tax_to_dist = sum(final_tax_to_dist, na.rm = TRUE),
            final_tax_to_tif = sum(final_tax_to_tif, na.rm = TRUE),
            tax_amt_exe = sum(tax_amt_exe, na.rm = TRUE), # revenue lost due to exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe, na.rm = TRUE), # total rev before all exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe, na.rm = TRUE), # total rev after all exemptions
        rpm_tif_to_cps = sum(rpm_tif_to_cps, na.rm = TRUE), # not used
        rpm_tif_to_rpm = sum(rpm_tif_to_rpm, na.rm=TRUE), # not used
         rpm_tif_to_dist = sum(rpm_tif_to_dist, na.rm=TRUE), # not used
          tif_share = mean(tif_share, na.rm=TRUE), # not used
       ) %>%
  
  mutate(total_bill = final_tax_to_dist + final_tax_to_tif)

head(taxcodes_by_class_current)

taxcodes_by_class_current %>% write_csv("2_Summed_Bills_by_Taxcode_and_Class.csv")
```

If using only the major property classes, then there are 10,586 observations when grouped by tax code--major class combinations.
If I want to do rentals vs owner occupied, I do not want to use the major property classes. 

> I will need to use my own variable for grouping residential vs non residential properties and then residential into owner occupied and rental properties. 

```{r}
taxcodes_by_majorclass_current <- taxcodes_by_class_current %>% 
  ungroup() %>%
  left_join(class_dict, by = c("class" = "class_code")) %>%
  group_by(tax_code, major_class_code, major_class_type)  %>%
  
  summarize(
   av = sum(av), 
   eav = sum(eav),
   pins_in_majorclass = sum(pins_in_class),
   parcel_count_in_majorclass = sum(parcel_count_in_class),
            final_tax_to_dist = sum(final_tax_to_dist, na.rm = TRUE),
            final_tax_to_tif = sum(final_tax_to_tif, na.rm = TRUE),
            tax_amt_exe = sum(tax_amt_exe, na.rm = TRUE), # revenue lost due to exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe, na.rm = TRUE), # total rev before all exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe, na.rm = TRUE), # total rev after all exemptions
        rpm_tif_to_cps = sum(rpm_tif_to_cps, na.rm = TRUE), # not used
        rpm_tif_to_rpm = sum(rpm_tif_to_rpm, na.rm=TRUE), # not used
         rpm_tif_to_dist = sum(rpm_tif_to_dist, na.rm=TRUE), # not used
          tif_share = mean(tif_share, na.rm=TRUE),
       ) %>%
  
  mutate(total_bill = final_tax_to_dist + final_tax_to_tif)
head(taxcodes_by_majorclass_current)

taxcodes_by_majorclass_current %>% write_csv("2_Summed_Bills_by_Taxcode_and_MajorClass.csv")
```


```{r}
owner_occupied <- c("299", "202","203", "204", "205",
                    "206", "207", "208","209",
                    "210","234", "278", "295")

rental <- c("399", "300", "301", "313", "314",  
            "315", "318", "391", "396", "397",
            "901", "913", "914", "915", "918", 
            "959", "991", "996", "997", "211", "212", "225")
```


# For File 3_CurrentExemptions


```{r eval=FALSE}
muni_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT pin, class, tax_code_num
  FROM pin
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))

# There are 1,864,594 pins taxed by Cook County in 2021.
cook_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT pin, class, tax_code_num
  FROM pin
  WHERE tax_code_num IN ({cook_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))
```

```{r all-cook-pins, eval=FALSE}


# finds all pins within a municipality
pin_data <- lookup_pin(2021, cook_pins$pin) %>%
  left_join(cook_pins, by = c("pin", "class"))


# change variable type to character so the join works.
class_dict$class_code <- as.character(class_dict$class_code)



# use the property class to make the major property types
# joins the class_dict file to the pin_data classes
pin_data <- class_dict %>%
  select(-c(assessment_level:reporting_group, class_desc:max_size)) %>%
  right_join(pin_data, by = c("class_code" = "class"))

write_csv(pin_data, "all_cook_pins_2021.csv")




## summarize pin level data to the tax code level
exemptions_inCook_perTC <- pin_data %>%
  group_by(tax_code_num, major_class_code, major_class_type) %>%
  summarize(eav=sum(eav, na.rm=TRUE),
            exe_homeowner = sum(exe_homeowner, na.rm=TRUE),
            exe_senior = sum(exe_senior, na.rm=TRUE),
            exe_freeze = sum(exe_freeze, na.rm=TRUE),
            exe_longtime_homeowner = sum(exe_longtime_homeowner, na.rm=TRUE),
            exe_disabled = sum(exe_disabled, na.rm=TRUE),
            exe_vet_returning = sum(exe_vet_returning, na.rm=TRUE),
            exe_vet_dis = sum(exe_vet_dis_lt50 + exe_vet_dis_50_69 + exe_vet_dis_ge70, na.rm=TRUE),
            exe_abate = sum(exe_abate, na.rm=TRUE),
            pin_count = n() # number of pins within each tax code and property combo

)

# grouped by taxcode and property classes.
# has amount of each type of exemption in each tax code
write_csv(exemptions_inCook_perTC, "all_exemptions_inCook_byTaxcode.csv")
```


```{r}
# finds all pins within a municipality
pin_data <- lookup_pin(2021, muni_pins$pin) %>%
  left_join(muni_pins, by = c("pin", "class"))


# use the property class to make the major property types
# joins the class_dict file to the pin_data classes
pin_data <- class_dict %>%
  select(-c(assessment_level:reporting_group, class_desc:max_size)) %>%
  right_join(pin_data, by = c("class_code" = "class"))

write_csv(pin_data, "all_muni_pins_2021.csv")

exemptions_inMunis_perTC <- pin_data %>%
  group_by(tax_code_num, major_class_code, major_class_type) %>%
  summarize(eav=sum(eav),
            exe_homeowner = sum(exe_homeowner, na.rm=TRUE),
            exe_senior = sum(exe_senior, na.rm=TRUE),
            exe_freeze = sum(exe_freeze, na.rm=TRUE),
            exe_longtime_homeowner = sum(exe_longtime_homeowner, na.rm=TRUE),
            exe_disabled = sum(exe_disabled, na.rm=TRUE),
            exe_vet_returning = sum(exe_vet_returning, na.rm=TRUE),
            exe_vet_dis = sum(exe_vet_dis_lt50 + exe_vet_dis_50_69 + exe_vet_dis_ge70, na.rm=TRUE),
            exe_abate = sum(exe_abate, na.rm=TRUE),
            pin_count = n() # number of pins within each tax code and property combo

)
write_csv(exemptions_inMunis_perTC, "all_exemptions_inMunis_byTaxcode.csv")
```

```{r}

# use exemptions in tax codes to summarize EAV. 
# More accurate that calculating it from revenue collected.tax rate in tax bill data

exemptions_by_class_per_TC <- read_csv("all_exemptions_by_TC.csv") %>% 
  mutate(tax_code_num = as.character(tax_code_num)) %>%
  left_join(muni_tax_codes) %>%
  full_join(muni_agency_names) %>%
  left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
  # merge with TIF distrib table to calculate the percent of the EAV that goes to the TIF vs the district
  left_join(tif_distrib, by=c("tax_code_num", "year", "tax_code_rate")) %>%
  mutate(#exempt_EAV = (exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
        # exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate) ,
         in_TIF = ifelse(tax_code_num %in% unique_tif_taxcodes$tax_code_num, 1, 0),
       # tax_base_current = ifelse(in_TIF==1, (eav-exempt_EAV)*(1-tax_code_distribution_pct/100), eav-exempt_EAV),
      #  tax_base_noexemps = ifelse(in_TIF==1, (eav)*(1-tax_code_distribution_pct/100), eav),
         ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Non-Residential"),
         
         PropType = ifelse(class %in% c("299", "202","203", "204", "205", "206", "207", "208","209", "210","234", "278", "295"), 
                            "Owner Occupied", ""),
      
        PropType = ifelse(class %in% c("399", "300", "301", "313", "314","315", "318", "391", "396", "397", "901", "913", " 914", "915", "918", "959", "991", "996", "997", "211", "212", "225"), 
                           "Rental", PropType),
      
        PropType = ifelse(major_class_code %in% c("2","3","9") & PropType == "",  "Other Residential", PropType),
        Proptype = ifelse(PropType == "", "Non-Residential", Proptype))
```

__Exemptions within each municipality:__


Percent Residential is the Residential EAV outside of TIFs / Municipality EAV outside of TIFs.


```{r}
grouped_exemptions <- exemptions_by_class_per_TC %>% 
   # group_by(agency_name, major_class_code, major_class_type, ResidentialProps, PropType) %>%
  group_by(clean_name, ResidentialProps, agency_name, agency_num.x) %>%
  summarize(eav = sum(eav),
           exempt_EAV = sum(exempt_EAV, exe_abate, na.rm=TRUE),
         tax_base_current = sum(tax_base_current, na.rm=TRUE),
         tax_base_noexemps = sum(tax_base_noexemps, na.rm=TRUE)) %>% ungroup() %>% select(clean_name, eav, exempt_EAV, everything())
  
grouped_exemptions 

# calculate totals with ONLY EAV outside of TIFs
muni_eav <- grouped_exemptions %>%  
  group_by(clean_name, agency_name, agency_num.x) %>% 
  summarize(muni_EAV_includesTIF = sum(eav), # all EAV in the municipality that exists
            muni_tax_base_current=sum(tax_base_current), # taxable EAV based on current exemptions
            muni_tax_base_noexemps = sum(tax_base_noexemps)) %>%  # taxable EAV pre-exemptions
  ungroup() 

perc_residential <- full_join(grouped_exemptions, muni_eav) %>% 
  filter(ResidentialProps == "Residential") %>% 
  mutate(percent_residential = eav / muni_EAV_includesTIF)# %>% select()


# in this stage, Bensenville, East Dundee, and Homer Glen were dropped. This is fine because I was going to drop them later anyways. They don't have residential EAV within Cook County.

perc_residential

```



## Residential (Only Class 2 - Single-family)

```{r include = FALSE}
cook_eav <- exemptions_by_class_per_TC %>% filter(major_class_code == 2) %>% summarize(eav = sum(eav,na.rm=TRUE))
```

In Cook County there is `r scales::dollar(cook_eav$eav)` in Single-Family Property EAV.

```{r fig.cap="The median municipality has 66.84% of its EAV from Residential Class 2 Properties for Single-Family homes. Total EAV includes frozen EAV & TIF increments, and all exempt EAV."}


# Class 2 only
class2_perc <- exemptions_by_class_per_TC %>% 
    filter(major_class_code == 2) %>%
  group_by(clean_name, major_class_code, agency_name, agency_num.x) %>%
  summarize(eav = sum(eav),
           exempt_EAV = sum(exempt_EAV, exe_abate, na.rm=TRUE),
         tax_base_current = sum(tax_base_current, na.rm=TRUE),
         tax_base_noexemps = sum(tax_base_noexemps, na.rm=TRUE)) %>% 
  left_join(muni_eav) %>%
  mutate(perc_class2_totalEAV = eav / muni_EAV_includesTIF) %>%    
  mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) )

class2_perc %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = perc_class2_totalEAV)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  labs(title = "Class 2 Property EAV /  Total EAV in Municipality", 
  caption = "") +
  theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+# +#+
  scale_fill_steps2(
    high = "darkblue", low = "black",
    midpoint = median(class2_perc$perc_class2_totalEAV),
  #  breaks = breaks_sd,  # tried to do breaks based on standard deviation but map does that in an easier way by setting the midpoint. 
    nice.breaks = FALSE,
    show.limits=TRUE,
    name = "% Residential",
    labels = scales::percent)
```


__Percent of Class 2 EAV that is tax exempt: Exempt EAV / Residential EAV__

```{r fig.cap= "Median value for single-family EAV is 20.76%.", fig.show="hold", out.width = "50%"}

exemptions_to_class2EAV_ratios <- class2_perc %>% 
  mutate(exemptEAV_pctof_resEAV = exempt_EAV/eav,
         nontif_ratio = exempt_EAV / tax_base_noexemps) %>% 
  select(agency_name, clean_name, exemptEAV_pctof_resEAV, nontif_ratio) %>% 
  arrange(nontif_ratio)

exemptions_to_class2EAV_ratios %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
 left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = exemptEAV_pctof_resEAV)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Exemptions / Residential EAV (in and out of TIFs)") +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "darkblue", low = "black", 
                      # limits = c(0,.8),
                       n.breaks = 7, show.limits=TRUE,
                    nice.breaks = FALSE,
                    midpoint = median(exemptions_to_class2EAV_ratios$exemptEAV_pctof_resEAV),
                        name = "% Residential EAV \nthat is exempt", label = scales::percent)


exemptions_to_class2EAV_ratios %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = nontif_ratio)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Non-TIF EAV only: Homestead Exemptions / Residential EAV", caption = "Village of Phoenix skews graph. Dropped in map below") +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "darkblue", low = "black",
     #colors = c("white", "darkblue"), 
                      # limits = c(0),
                    midpoint = median(exemptions_to_class2EAV_ratios$nontif_ratio),
                       n.breaks = 7, 
     show.limits=TRUE,
                        name = "% Residential EAV \nthat is exempt", label = scales::percent) + 
  labs( caption = "Median value is 20.85% ")
```


```{r fig.cap="Drops Village of Phoenix because it skews map colors (78% of their residential EAV is tax exempt). Median municipality can not get tax revenue from 1/5th of their residential EAV due to exemptions. 20.85% of Single-family home EAV is not taxed and transferred to other tax payers."}
  
exemptions_to_class2EAV_ratios %>%  filter(nontif_ratio<.6) %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = nontif_ratio)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Percent of Residential EAV that is Tax Exempt", 
  subtitle = "% of Non-TIF Residential EAV only: \nHomestead Exemptions / Residential EAV", 
  caption = "") +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "darkblue", low = "black",
   #  colors = c("white", "darkblue"), 
                       limits = c(0,.4),
   midpoint = median(exemptions_to_class2EAV_ratios$nontif_ratio),
                       n.breaks = 7, show.limits=TRUE,
                        name = "% Residential EAV \nthat is tax exempt", label = scales::percent)
```


## Residential (Class 2, 3, & 9)


The median amount of EAV from residentical parcels is `r scales::percent(median(perc_residential$percent_residential))`.

```{r}
variable <- perc_residential$percent_residential

breaks_sd = c(
  (median(variable)-2.5*sd(variable)),
  (median(variable)-1.5*sd(variable)),
  median(variable)-.5*sd(variable),
  median(variable),
  median(variable)+.5*sd(variable),
  median(variable)+1.5*sd(variable),
  median(variable)+2.5*sd(variable))



# class 2, 3, 9 combined
perc_residential %>% 
  group_by(ResidentialProps)%>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = percent_residential)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  labs(title = "Residential EAV /  Total EAV", caption = "The median municipality has 70.4% of its EAV from Residential Class 2, 3, & 9 Properties") +
    theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+# +#+
    scale_fill_steps2(
    high = "darkblue", low = "black",  #  guide = "legend",
      midpoint = median(perc_residential$percent_residential),
                      breaks = breaks_sd,
  #                      n.breaks = 6,
  show.limits=TRUE,
                        name = "% Residential",
  labels = scales::percent)
```

```{r}

exemptions_to_resEAV_ratios <- grouped_exemptions %>% 
  filter(ResidentialProps == "Residential") %>% 
  mutate(exemptEAV_pctof_resEAV = exempt_EAV/eav,
         nontif_ratio = exempt_EAV / tax_base_noexemps) %>% 
  select(agency_name, clean_name, exemptEAV_pctof_resEAV, nontif_ratio) %>% 
  arrange(nontif_ratio)

exemptions_to_resEAV_ratios %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
 left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = exemptEAV_pctof_resEAV)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Exemptions / Residential EAV (in and out of TIFs)") +
    theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "maroon", low = "black", 
                      # limits = c(0,.8),
                       n.breaks = 7, show.limits=TRUE,
                    nice.breaks = FALSE,
                    midpoint = median(exemptions_to_resEAV_ratios$exemptEAV_pctof_resEAV),
                        name = "% Residential EAV \nthat is exempt", label = scales::percent) + labs(caption = "Median value is 19.5%. 
                                                                                                     Nearly 20% of Residential EAV is tax exempt in the median municipality. ")

exemptions_to_resEAV_ratios %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = nontif_ratio)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Non-TIF EAV only: Homestead Exemptions / Residential EAV", caption = "Village of Phoenix skews graph. Dropped in map below") +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "maroon", low = "black",
     #colors = c("white", "darkblue"), 
                       limits = c(0,.8),
                    midpoint = median(exemptions_to_resEAV_ratios$nontif_ratio),
                       n.breaks = 7, show.limits=TRUE,
                        name = "% Residential EAV \nthat is exempt", label = scales::percent) + labs( caption = "Median value is 19.77% ")

exemptions_to_resEAV_ratios %>% 
  filter(nontif_ratio<.5) %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = nontif_ratio)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Percent of Residential EAV that is Tax Exempt", 
  subtitle = "% of Non-TIF Residential EAV only: \nHomestead Exemptions / Residential EAV", 
  caption = "Residential includes Class 2, 3, and 9.
  Drops Village of Phoenix because it skews map colors (78% of their residential EAV is tax exempt). 
  Median municipality can not get tax revenue from 19.77% of their residential EAV due to exemptions.") +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "maroon", low = "black",
   #  colors = c("white", "darkblue"), 
                      # limits = c(0,.4),
   midpoint = median(exemptions_to_resEAV_ratios$nontif_ratio),
                     #  n.breaks = 7, 
   show.limits=TRUE,
                        name = "% Residential EAV \nthat is exempt", label = scales::percent)
```

```{r}
exemptions_to_resEAV_ratios %>% arrange(desc(nontif_ratio))
```


# Taxable Base and Muni Land Use

Tax base in the tables above are the total EAV outside of TIF areas.

```{r}
TC_bills_current <- read_csv("TC_bills_current.csv") %>% 
  mutate(tax_code = as.character(tax_code))

class_dict$class_code <- as.character(class_dict$class_code)
 

taxcodes_current <- full_join(TC_bills_current, muni_tax_codes, 
                      by = c("tax_code" = "tax_code_num")) 

Current_Taxrates <- taxcodes_current %>% 
  left_join(muni_agency_names) %>%
  left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
  filter(!agency_num %in% cross_county_lines) %>%
  group_by(clean_name, agency_name) %>% 
  summarize(MuniLevy = sum(final_tax_to_dist, na.rm = TRUE), # amount billed by munis with current exemptions in place
            nonTIF_EAV_post_exemps = sum(final_tax_to_dist/(tax_code_rate/100), na.rm = TRUE),
            TIF_increment_EAV = sum(final_tax_to_tif/(tax_code_rate/100), na.rm=TRUE),  
            Exempt_EAV = sum(tax_amt_exe/(tax_code_rate/100), na.rm=TRUE), 
            Total_EAV = sum((tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100), na.rm = TRUE)) %>%

  mutate(tax_rate_current = MuniLevy/nonTIF_EAV_post_exemps,
         nonTIF_EAV_pre_exemps = nonTIF_EAV_post_exemps + Exempt_EAV,
         taxrate_new = MuniLevy/nonTIF_EAV_pre_exemps,
         taxrate_change = tax_rate_current-taxrate_new) %>% 
  select(clean_name, taxrate_change, tax_rate_current, taxrate_new, everything()) %>% 
  arrange(desc(tax_rate_current))

land_use <- taxcodes_current %>% 
  left_join(muni_agency_names) %>% 
  left_join(Current_Taxrates) %>%
  mutate(ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Commercial"),
         PropType = case_when(
           major_class_code %in% c("3","9") ~ "Multi-Family",
           major_class_code == "2" ~ "Single-Family",
           TRUE ~ "Commercial-Industrial")) %>%
  group_by(clean_name,  ResidentialProps, agency_num, tax_rate_current, taxrate_new, taxrate_change, agency_name,) %>% 
  
  # All of the values calculated below are AFTER exemptions have been removed
  summarize(taxrev_from_proptype = sum(final_tax_to_dist, na.rm = TRUE),
            nonTIF_EAV = sum(final_tax_to_dist/(tax_code_rate/100), na.rm = TRUE),
            TIF_increment_EAV = sum(final_tax_to_tif/(tax_code_rate/100), na.rm=TRUE),
            Exempt_EAV = sum(tax_amt_exe/(tax_code_rate/100), na.rm=TRUE),
            Total_EAV = sum((tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100), na.rm = TRUE) ) %>% ungroup()

Current_Taxrates
```

Current composite tax rates for each municipality are above. Table also includes the new tax rate if there were no exemptions, the levy (aka amount collected by the municipality from final_tax_to_dist variable), EAV outside of TIFs, amount of exempt EAV, and additional variables.

Below: Take EAV values within each property type, join it with muni level EAV values, and calculate ...

```{r}

grouped_exemptions <- exemptions_by_class_per_TC %>% 
   # group_by(agency_name, major_class_code, major_class_type, ResidentialProps, PropType) %>%
  group_by(clean_name, major_class_type, ResidentialProps, PropType, major_class_code, agency_name) %>%
  summarize(eav = sum(eav),
           exempt_EAV = sum(exempt_EAV, exe_abate, na.rm=TRUE),
         tax_base_current = sum(tax_base_current, na.rm=TRUE),
         tax_base_noexemps = sum(tax_base_noexemps, na.rm=TRUE)) %>% ungroup()
  

# calculate totals with ONLY EAV outside of TIFs
muni_eav <- grouped_exemptions %>%  
  group_by(clean_name, agency_name) %>% 
  summarize(muni_EAV_includesTIF = sum(eav), # all EAV in the municipality that exists
            muni_tax_base_current=sum(tax_base_current), # taxable EAV based on current exemptions
            muni_tax_base_noexemps = sum(tax_base_noexemps)) %>%  # taxable EAV pre-exemptions
  ungroup() 

pct_property_types <- left_join(grouped_exemptions, muni_eav) %>% 
  #filter(ResidentialProps == "Residential") %>% 
  mutate(pct_PropType = eav / muni_EAV_includesTIF)# %>% select()

pct_property_types


burden_table <- pct_property_types %>% 
  left_join(Current_Taxrates, by = c("agency_name", "clean_name")) %>%
  mutate(rev_collected_current = tax_base_current * tax_rate_current,
         rev_collected_new = tax_base_noexemps*taxrate_new,
         burden_current = rev_collected_current/MuniLevy,
         burden_noexemps = rev_collected_new/MuniLevy, 
         burden_change = burden_noexemps- burden_current,
         burden_noexemps = ifelse(burden_noexemps >1, 1, burden_noexemps)) %>%
  mutate(burden_current = ifelse(is.na(burden_current), 0, burden_current),
         burden_noexemps = ifelse(is.na(burden_noexemps), 0, burden_noexemps)) %>%
  mutate(burden_noexemps = ifelse(burden_noexemps>1, 1, burden_noexemps),
         burden_current = ifelse(burden_current>1, 1, burden_current)) %>%
  filter(!is.na(major_class_code))%>%
  mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) )


burden_shift <- burden_table 
```

Compare to 6 municipalities calculated by JD:

Only class 2 property types in output below. Looks good! Yay.

```{r}
burden_table %>%  filter(agency_name %in% c("CITY OF CHICAGO", "VILLAGE OF BRIDGEVIEW", "VILLAGE OF DOLTON", "VILLAGE OF HOFFMAN ESTATES","VILLAGE OF MIDLOTHIAN","VILLAGE OF OAK PARK", "CITY OF CICERO") & major_class_code == 2) %>% select(-c(ResidentialProps, major_class_type, PropType)) %>%
  select(clean_name, muni_EAV_includesTIF, MuniLevy, exempt_EAV,burden_current, burden_noexemps)
```
