---
title: "Replication of Drucker's Excemption Scenarios"
author: "Alea Wilbur"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    df_print: paged
    code_folding: hide
---


```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, collapse = TRUE)


library(tidyverse) # normal package I need for almost everything
#install.packages("remotes")
#remotes::install_gitlab("ccao-data-science---modeling/packages/ptaxsim")
# OR 
#renv::install("gitlab::ccao-data-science---modeling/packages/ptaxsim")

library(DBI)
library(data.table)
library(ggspatial)
library(gstat)
library(here)
library(httr)
library(jsonlite)
library(ptaxsim)
library(sf)
library(stars)
library(glue)


#remotes::install_gitlab("ccao-data-science---modeling/packages/ptaxsim")

#renv::install("gitlab::ccao-data-science---modeling/packages/ptaxsim")


# Create the DB connection with the default name expected by PTAXSIM functions
ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), "./ptaxsim.db/ptaxsim-2021.0.4.db")

# has all potential property classes for pins
# downloaded from CCAO gitlab website
## I used this to merge additional information to the pins and class data later on.
class_dict <- read_csv("class_dict.csv")
```


I want Taxing Agencies, EAV, Tax Rate using ptaxsim and then calculate Weighted Tax Rate, and  Composite Tax Rate for Cicero, Forest Park, and Oak Park. Year = 2021. 



Ptaxsim includes all pins for parcels as well as the tax data associated with each pin. It recently gained a command that lets you access the geometry shapes for mapping (before you had to API pull it). The Parcel Universe database also includes the geospatial polygons for all parcels plus a ton of other variables. Each parcel has its own pin number. 

- Ptaxsim tax bill values and parcel_universe can be joined by the pins.

[Example from gitlab site](https://ccao-data-science---modeling.gitlab.io/packages/ptaxsim/articles/reassessment.html#chicago-ward)

Cook County Assessors Data description page and other [datasets](https://datacatalog.cookcountyil.gov/stories/s/i22y-9sd2).


Get PINS for region during a specific year.

Dataset variables were found [here](https://datacatalog.cookcountyil.gov/Property-Taxation/Assessor-Parcel-Universe/tx2p-k2g9). 



```{r}
base_url <- "https://datacatalog.cookcountyil.gov/resource/tx2p-k2g9.json" # this is now an archived dataset

# New dataset released. Slightly different names. 
# Still need to look into differences more 
new_base_url <- "https://datacatalog.cookcountyil.gov/resource/nj4t-kc8j.json"



# 
# area_pins <- GET(
#   base_url,
#   query = list(
#     year = 2021,
#     property_city = "CICERO",
#     `$select` = paste0(c("pin"),
#    collapse = ","),   
#    #`$select` =  "pin",     # if we want ONLY the pin
#     `$limit` = 500000L
#   )
# )
# 
# # change data type to character
# # 17,288 pins for Cicero
# area_pins2 <- fromJSON(rawToChar(area_pins$content))$pin
# #area_taxcodes <- fromJSON(rawToChar(area_pins$content))$tax_code
```

# New way of getting data for each municipality


```{r all-muni-names, eval=FALSE}
# grabs all unique muni names. Would be needed if creating a loop for calculating all munis
all_munis <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE minor_type = 'MUNI'
  "
)

# Remember, Cicero only exists as a township, so bring that in later.
all_townships <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  WHERE minor_type = 'TOWNSHIP'
  "
)


muni_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({all_munis$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

muni_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT pin, class
  FROM pin
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))


# Pins and Tax Codes that are in TIFS

TIFs <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  WHERE minor_type = 'TIF'
  "
)


tif_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({TIFs$agency_num*})
  ",
  .con = ptaxsim_db_conn
  )
)

# all tax codes for all munis. Large
all_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT * 
  FROM tax_code
  WHERE year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

#85 unique tax codes and the number of times they appear:
unique_tif_taxcodes <- tif_tax_codes %>% group_by(tax_code_num ) %>% summarize(n=n())


# 68,479 pins for Cicero over all years (pin-class-year combinations)
# 6938 unique pin-class combinations. Some pins change classes over time
# 4978 unique pins
tif_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT pin, class
  FROM pin
  WHERE tax_code_num IN ({unique_tif_taxcodes$tax_code_num*})
  ",
  .con = ptaxsim_db_conn
))

# 4978 distinct pins that are in TIFs.
unique_tif_pins <- tif_pins %>% distinct(pin) %>% count()
```

Odd balls:

Cicero, agency_num = 020060000  

```{r onemuni-atatime}
# grabs all agency names with Cicero somewhere in the text
agency_names <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE agency_name LIKE '%Dolton%'"
)

agency_names

muni_agency_nums<- agency_names %>% 
  filter(minor_type %in% c("MUNI")) %>%
  select(agency_num)

muni_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({muni_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

muni_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT pin, class
  FROM pin
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))
```

## TIF values

```{r munitifs-tiftaxcodes}

# Determining the increment / TIF stuff
# 30 taxing agencies overlap with TIFs
tif_agency_nums <- agency_names %>% 
  filter(minor_type == "TIF") %>% select(agency_num)

#85 for cicero
unique_tif_taxcodes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({tif_agency_nums$agency_num*})
  ",
  .con = ptaxsim_db_conn
  )
)

# all tax codes for all municipalities. 
# Over 57,000 tax codes with agency_rate and tax_code_rate. Over 57,000
all_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT * 
  FROM tax_code
  WHERE year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)


# 68,479 pins for Cicero over all years (pin-class-year combinations)
# 6038 unique pin-class combinations. Some pins change classes over time
# 4978 unique pins
unqiue_tif_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT pin, class
  FROM pin
  WHERE tax_code_num IN ({unique_tif_taxcodes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))


```


```{r map-attempt, eval=FALSE, collapse=TRUE}
# PIN geometries only exist for 10-digit PINs, so we'll need to truncate our
# existing  PINs
muni_pin10s <- unique(substr(muni_pins$pin, 1, 10))

# The geometry is stored in the database as simple text, so we need to convert
# it to the correct type using sf
wh_pins_geo <- lookup_pin10_geometry(year = 2020, pin10 = muni_pin10s)
wh_pins_geo <- wh_pins_geo %>%
  st_as_sf(wkt = "geometry", crs = 4326)

# We'll also attach the first class code from each PIN14 to each PIN10 geometry
# and group them into broad buckets. This is just to help our visualization
wh_pins_geo <- wh_pins_geo %>%
  left_join(
    tif_pins %>%
      mutate(pin10 = substr(pin, 1, 10)) %>%
      group_by(pin10) %>%
      summarize(class = first(class)),
    by = "pin10"
  ) %>%
  mutate(
    major_class = substr(class, 1, 1),
    major_class_fct = recode_factor(
      major_class,
      "2" = "2 - Residential",
      "3" = "3 & 5 - Commercial",
      "5" = "3 & 5 - Commercial",
      "0" = "Other", "1" = "Other", "6" = "Other", "7" = "Other"
    )
  )

bound_muni <- st_read(paste0(
  "https://opendata.arcgis.com/api/v3/datasets/",
  "534226c6b1034985aca1e14a2eb234af_2/downloads/",
  "data?format=geojson&spatialRefId=4326&where=1%3D1"
), quiet = TRUE) %>%
  filter(MUNICIPALITY == "Cicero")

bound_tif <- st_read(paste0(
  "https://opendata.arcgis.com/api/v3/datasets/",
  "8aeb00520c544aafb9a22510465c679d_18/downloads/",
  "data?format=geojson&spatialRefId=4326&where=1%3D1"
), quiet = TRUE) %>%
  # Pulled from the table of agency numbers above
  filter(AGENCY == tif_agency_nums$agency_num)

wh_pins_map <- ggplot() +
  annotation_map_tile(type = "cartolight", zoomin = -1) +
  geom_sf(
    data = wh_pins_geo,
    aes(fill = major_class_fct),
    alpha = 0.5,
    linewidth = 0.1
  ) +
  geom_sf(data = bound_muni, fill = "transparent", linewidth = 1) +
  geom_sf(
    data = bound_tif,
    fill = "purple2",
    color = "purple4",
    alpha = 0.3,
    linewidth = 0.9
  ) +
  annotation_scale(location = "br") +
  scale_fill_brewer(name = "", palette = "Set1") +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  theme_void() +
  theme(
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12),
    legend.key.size = unit(24, "points"),
    legend.position = "bottom"
  )
wh_pins_map

```

## TIF Data by Tax Codes

```{r tif-eav}
# TIF distributions will include all the unique tax codes that make up
# a TIF

# has eav values for each tax code
# has ALL years

tif_distrib_allyears <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT *
  FROM tif_distribution
  WHERE agency_num IN ({tif_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)


tif_distrib <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT *
  FROM tif_distribution
  WHERE agency_num IN ({tif_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)
options(digits=4, scipen = 999)

tif_distrib <- tif_distrib %>% 
  mutate(tif_increment = tax_code_eav - tax_code_frozen_eav,
         total_taxcode_revenue = tax_code_eav/tax_code_rate,
         revenue_todistrict_withinTIF = tax_code_frozen_eav/tax_code_rate,
         tif_revenue_withinTIF = tif_increment/tax_code_rate)
tif_distrib

# another way to get all pins within a tif:
tif_pins_vec <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue::glue_sql("
    SELECT DISTINCT pin
    FROM pin
    WHERE tax_code_num IN ({unique(tif_distrib$tax_code_num)*})
    AND year = 2021
  ",
    .con = ptaxsim_db_conn
  )
) %>%
  pull(pin)

# has EAV values for each pin in the TIF
# 73,256 obs for all years: pin-tax_code-year combinations.


class_dict$class_code <- as.character(class_dict$class_code)
```

## TIF Exemptions by Property Class

> Not right 

```{r tif-exemptions}
tif_pins_dt <- lookup_pin(2021, pin = tif_pins_vec) %>% 
  mutate(tax_code = lookup_tax_code(year, pin)) %>%   
  left_join(class_dict, by = c("class"="class_code"))

tif_exemptions <- tif_pins_dt %>% 
  group_by(major_class_code, major_class_type) %>%
    summarize(#eav = sum(eav),
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_longtime_homeowner = sum(exe_longtime_homeowner),
  exe_disabled = sum(exe_disabled),
  exe_vet_returning = sum(exe_vet_returning),
  exe_vet_dis = sum(exe_vet_dis_lt50+exe_vet_dis_50_69+exe_vet_dis_ge70),
  exe_abate = sum(exe_abate))

tif_exemptions

tif_exemptions_simplified <- tif_pins_dt %>% 
  group_by(major_class_code, major_class_type) %>%
    summarize(#eav = sum(eav),
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_allothers = sum(exe_longtime_homeowner:exe_abate))

tif_exemptions_simplified

total_tif_exemptions_byclass <- tif_pins_dt %>% 
  group_by(major_class_code, major_class_type) %>%
  summarize(total_exemptions_inTIFPINs = sum(c_across(exe_homeowner:exe_abate)))

total_tif_exemptions_byclass



total_tif_exemptions <- tif_pins_dt %>% 
  summarize(total_exemptions_inTIFPINs = sum(c_across(exe_homeowner:exe_abate)))

total_tif_exemptions
```

## TIF Revenue

```{r tif-increment}
eav_by_class_inTIFS <- tif_pins_dt %>%
  filter(year == 2021) %>%
  group_by(major_class_code, major_class_type) %>% 
  summarize(eav = sum(eav))

eav_by_class_inTIFS

tif_pins_summ <- tif_pins_dt %>%
  group_by(year) %>%
  #Summed TIF EAV amounts 
  summarize(total_eav = sum(eav)) %>%
  left_join(tif_distrib, by = "year")

tif_pins_summ %>%# group_by(year) %>% 
  summarize(tax_code_sum = sum(tax_code_eav))

```

```{r collapse=TRUE}
tif_inc_plot <- 
  tif_pins_summ %>% 
  group_by(year, total_eav)%>% 
  summarize(frozen_eav = sum(tax_code_frozen_eav)) %>%
  ggplot() +
  
    geom_area(
    aes(x = year, y = total_eav),
    fill = "red",
    alpha = 0.5
  ) +
      geom_area(
    aes(x = year, y = frozen_eav),
    fill = "gray40"
  ) +
  scale_y_continuous(
    labels = scales::label_dollar(scale = 1e-6, suffix = "M"),
    expand = c(0, 0)
  ) +
  scale_x_continuous(n.breaks = 9, expand = c(0, 0.4)) +
  labs(x = "Year", y = "Total EAV of PINs in _____", caption = "Red is amount of EAV taxed where the revenue went to the TIF") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text = element_text(size = 11),
    axis.ticks.x = element_line(color = "grey70"),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )
tif_inc_plot
```

```{r eval=FALSE, include=FALSE}
# Create polygon to highlight the increment taxed by the TIF
# This was for Wheeling specifically! Commenting it out for now 
# filled in the tif amount a different color in the graph

# plot_pin_fill <- tibble(
#   x = c(2014, 2015, 2016, 2017, 2018, 2019, 2020, 2020, 2021),
#   y = c(
#     tif_pins_summ$total_eav[tif_pins_summ$year >= 2014],
#     tif_pins_summ$total_eav[tif_pins_summ$year == 2014]
#   )
# )

#plot_pin_fill <- i

tif_inc_plot <- tif_pins_sum %>% 
  group_by(year,total_eav)%>% 
  summarize(frozen_eav = sum(tax_code_frozen_eav)) %>%
  ggplot(tif_pins_summ) +
  # geom_area(
  #   aes(x = year, y = total_eav),
  #   fill = "grey50",
  #   alpha = 0.5
  # ) +
  
    geom_area(
    aes(x = year, y = tax_code_eav),
    fill = "grey40",
    alpha = 0.5
  ) +
  

    geom_area(
    aes(x = year, y = tax_code_frozen_eav),
    fill = "purple",
    alpha = 0.5
  ) +
  
  
    geom_area(
    aes(x = year, y = amt_to_tif+tax_code_eav+tax+code+frozen+eav),
    fill = "red",
    alpha = 0.5
  ) +
 # geom_polygon(
 #   data = plot_pin_fill,
 #   aes(x = x, y = y),
 #   fill = "purple2",
 #   alpha = 0.5
#  ) +
 # geom_vline(xintercept = 2014, linetype = "dashed", alpha = 0.7) +
  # annotate(
  #   "text",
  #   x = 2013.7,
  #   y = 7.5e7,
  #   label = "Wheeling Town Center II\nTIF created",
  #   hjust = 1,
  #   size = 3.5,
  #   alpha = 0.5
  # ) +
  annotate(
    "text",
    x = 2017.9,
    y = 5.5e7,
    label = "Increment to TIF",
    hjust = 1,
    size = 5,
    color = "red",
    alpha = 0.5,
    fontface = "bold"
  ) +
  scale_y_continuous(
    labels = scales::label_dollar(scale = 1e-6, suffix = "M"),
    expand = c(0, 0)
  ) +
  scale_x_continuous(n.breaks = 9, expand = c(0, 0.4)) +
  labs(x = "Year", y = "Total EAV of PINs in _____") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text = element_text(size = 11),
    axis.ticks.x = element_line(color = "grey70"),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )
tif_inc_plot
```

Tax revenue by district:

```{r}
#graph of tax revenue for taxing agencies over the years
tif_bills <- tax_bill(2006:2020, tif_pins_vec)

tif_bills_summ <- tif_bills %>%
  mutate(
    agency_minor_type = recode(
      agency_minor_type,
      "GEN ASST" = "MUNI",
      "PARK" = "MUNI",
      "INFRA" = "MUNI",
      "LIBRARY" = "MUNI",
      "MOSQUITO" = "MISC",
      "WATER" = "MISC"
    ),
    agency_minor_type = factor(
      agency_minor_type,
      levels = c(
        "TIF", "COOK", "MUNI", "TOWNSHIP", "MISC",
        "COMM COLL", "ELEMENTARY", "SECONDARY"
      )
    )
  ) %>%
  group_by(year, agency_minor_type) %>%
  summarize(total_rev = sum(final_tax))


# make a graph! Copied mostly from TIF vingette examples 
tif_dist_plot <- ggplot(data = tif_bills_summ) +
  geom_area(
    aes(x = year, y = total_rev, fill = agency_minor_type),
    alpha = 0.8
  ) +
  scale_y_continuous(
    labels = scales::label_dollar(scale = 1e-6, suffix = "M"),
    expand = c(0, 0)
  ) +
  scale_x_continuous(n.breaks = 9, expand = c(0, 0.4)) +
  scale_fill_manual(
    name = "",
    values = c("#7d26cd", RColorBrewer::brewer.pal(7, "Set2"))
  ) +
  labs(x = "Year", y = "Total Tax Revenue from TIF PINs", caption = "Multiple TIFs are aggregated together in this graph") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text = element_text(size = 11),
    axis.ticks.x = element_line(color = "grey70"),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12)
  )
tif_dist_plot
```





# Replication Numbers


Composite tax rates is the aggregate of taxing agency rates. 

Taxing agencies revenues = tax rate * frozen EAV

Frozen EAV = Tax Revenue / tax rate

TIF revenue = composite tax rate X total EAV - frozen EAV
TIF revenue = TIF's tax rate * incremental EAV


> EAV returned is value before exemptions are removed

```{r}
area_pins2 <- as.character(muni_pins$pin)

#207,565 taxbills/observations for Cicero for 2021
area_data <- tax_bill(2021, area_pins2, simplify = FALSE)

# get class info with pin exemption data
class_dict$class_code <- as.character(class_dict$class_code)

area_data <- left_join(area_data, class_dict, by=c("class" = "class_code")) %>% 
  mutate(in_tif = ifelse(final_tax_to_tif > 0, 1, 0),
         DecreasedTaxBillAmount = tax_amt_pre_exe-tax_amt_post_exe, 
         # lost revenue from exemptions decreasing EAV taxed
         )

area_data
#setkey(area_data, year, tax_code, agency_num)

# 145 unique year-taxcode-agencynum combinatins. 
# send this through other functions
#unique_values<-area_data %>% group_by(year, tax_code, agency_num) %>% summarize()

#unique_values

## values are after exemptions have been subtracted! 
taxing_agencies <- area_data %>% 
  group_by(agency_name, agency_num, agency_tax_rate) %>% 
  summarize(eav = sum(eav),
        #    final_tax = sum(final_tax), 
        # final tax only exists if simplify = TRUE in that tax_bill() command.
            final_tax_to_dist = sum(final_tax_to_dist),   #revenue to district
            final_tax_to_tif = sum(final_tax_to_tif),     # revenue to TIF
            tax_amt_exe = sum(tax_amt_exe),     # reduction in tax bill due to exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe), #tax bill before exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe), # tax bills after exemptions are subtracted from EAVs
        agency_tax_rate = mean(agency_tax_rate),
        agency_total_ext = mean(agency_total_ext)
            ) %>%
  arrange(agency_num) %>%
  mutate(weighted_tax_rate = agency_tax_rate*eav) %>% 
  ungroup() %>%
  mutate(composite_tax_rate = sum(weighted_tax_rate)/max(eav) )

taxing_agencies

# saves composite tax rate as its own object because I might plug it in with the TIF stuff later.
composite_tax_rate <- first(taxing_agencies$composite_tax_rate)


## Exact match (besides column names) with JD's values for Taxing Agencies. 
taxing_agencies %>%
    mutate(`Tax Rate` = round(agency_tax_rate, digits = 6),
           EAVbeforeExemptions = scales::comma(eav)) %>%
select(agency_name, agency_name, EAVbeforeExemptions, `Tax Rate`, weighted_tax_rate, composite_tax_rate)
```

Taxing Agency Values above match JD's simulation 5 excel file. 

These are all the Non-TIF taxing agencies though! The ones that are in output when using tax_bill() in ptaxsim.

## Using lookup() commands


## EAV by Class

```{r}
#17,296 pins, has av, eav, class, and exemptions for each UNIQUE pin
pin_data <- lookup_pin(2021, area_pins2)

# get class info with pin expemption data
#class_dict$class_code <- as.character(class_dict$class_code)
pin_data <- left_join(pin_data, class_dict, by=c("class" = "class_code")) %>% 
  mutate(inTIF = ifelse(pin %in% tif_pins_dt$pin, 1,0)) 
# aggregate by major class code
# MATCHES - By Class (from PTAXSIM) by JD

eav_by_class_summary <- pin_data %>% 
  group_by(major_class_code, major_class_type) %>% 
  summarise(eav = sum(eav))
eav_by_class_summary


eav_by_class_summary2 <- pin_data %>% 
  group_by(reporting_group,major_class_code, major_class_type) %>% 
  summarise(eav = sum(eav))
eav_by_class_summary2

eav_inout_TIF <- pin_data %>% 
  group_by(major_class_code, major_class_type, inTIF) %>% 
  summarise(eav = sum(eav)) %>% 
  pivot_wider(names_from = inTIF, values_from = eav)%>% 
  mutate(total = `0`+`1`) %>%
  rename(EAVoutofTIF = `0`,
         EAVinTIF = `1`,
         TOTALEAV = total)

eav_inout_TIF
```


```{r eval=FALSE}
nonresidential<- data.frame(major_class_code = "Non-residential", 
                            major_class_type = "Non-residential", 
                            eav= with(exemptions_by_class_summary, sum(eav[major_class_code %in% c("1", "5A", "5B", "6B", "7","8")])))

residential<-  data.frame(major_class_code = "Residential", 
                            major_class_type = "Residential", 
                            eav=with(exemptions_by_class_summary, sum(eav[major_class_code %in% c("2","3","9")])))

TOTAL <-  data.frame(major_class_code = "TOTAL", 
                            major_class_type = "TOTAL", 
                            eav= with(exemptions_by_class_summary, sum(eav)))

## Matches JD excel file!
values_by_class<- rbind(exemptions_by_class_summary, TOTAL, residential, nonresidential) 

 values_by_class %>% mutate(eav = format(eav, big.mark=","))
```

Perfect match for EAV by class.

## Exemptions by Property Type 

> Pin data table is the only way to get the exemptions broken down by type. Created with lookup_pin()

```{r}
exemptions_by_class <- pin_data %>% 
  group_by(major_class_code,major_class_type)%>%
  summarize(#eav = sum(eav),
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_longtime_homeowner = sum(exe_longtime_homeowner),
  exe_disabled = sum(exe_disabled),
  exe_vet_returning = sum(exe_vet_returning),
  exe_vet_dis = sum(exe_vet_dis_lt50+exe_vet_dis_50_69+exe_vet_dis_ge70),
  exe_abate = sum(exe_abate)
  
) %>%
  mutate(TOTAL = sum(exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
                       exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate)) 

exemptions_by_class %>% summarize(  
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_allothers = sum(exe_longtime_homeowner:exe_abate),
 # exe_disabled = sum(exe_disabled),
 # exe_vet_returning = sum(exe_vet_returning),
 # exe_vet_dis = sum(exe_vet_dis_lt50+exe_vet_dis_50_69+exe_vet_dis_ge70),
 # exe_abate = sum(exe_abate)
 )
#area_data %>%arrange(desc(eav))

total_exemptions <-exemptions_by_class%>%ungroup()%>%summarize(TotalExemptions = sum(TOTAL))


total_exemptions$TotalExemptions %>% scales::comma()
```
## District & TIF Revenue

Taxing agency revenue by property major class code:

```{r}
class_eav <- area_data %>% 
  group_by(           
    major_class_code) %>% 
  summarize(
            final_tax_to_dist = sum(final_tax_to_dist),
            final_tax_to_tif = sum(final_tax_to_tif),
            tax_amt_exe = sum(tax_amt_exe),
            tax_amt_pre_exe = sum(tax_amt_pre_exe),
            tax_amt_post_exe = sum(tax_amt_post_exe),
            ) %>%

 # arrange(agency_num) %>%
 # mutate(weighted_tax_rate = agency_tax_rate*eav) %>% 
 # ungroup() %>%
      mutate(total_revenue = final_tax_to_dist+final_tax_to_tif,
             dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist))



nicer_table <- class_eav %>% left_join(exemptions_by_class)%>%
  mutate(#EAV = scales::dollar(eav),
    Exemptions=TOTAL,
                            "Total Tax Revenue(District+TIF)" = scales::dollar(tax_amt_post_exe),
                            "District Revenue" = scales::dollar(final_tax_to_dist),
                            "TIF Revenue" = scales::dollar(final_tax_to_tif),
                            "Lost Revenue from Exempt." = scales::dollar(tax_amt_exe), # same as tax_amt_pre_exe-tax_amt_post_exe
                            "District Tax Share" = scales::percent(dist_tax_share),
                            "EAV in TIF (Increment)" = final_tax_to_tif/composite_tax_rate,
                            # TIF EAV matches JD almost perfectly, Commercial 5A does not match. 
                            "EAV outside TIF" = final_tax_to_dist/composite_tax_rate
                            ) %>% 
  mutate(`EAV in and out of TIFs` = `EAV in TIF (Increment)`+`EAV outside TIF`,
             EAVbeforeExemptions = `EAV in and out of TIFs`+Exemptions) %>%
  select(-c(tax_amt_post_exe,total_revenue, dist_tax_share, final_tax_to_dist:tax_amt_pre_exe,exe_homeowner:TOTAL)) 

nicer_table

#class_exemptions <- full_join(exemptions_by_class,  class_eav, by = "major_class_code") %>%
#  select(major_class_code, major_class_type, eav, final_tax_to_dist, tax_share)
#class_exemptions
```

> What is this ratio supposed to be? Exemptions / ????? Total EAV, EAV the district taxes, or what


```{r}
total_exemptions/sum(nicer_table$TaxableBase)
```


```{r}
area_data %>% 
  summarize(
    final_tax_to_dist = sum(final_tax_to_dist),
    final_tax_to_tif = sum(final_tax_to_tif),
    tax_amt_exe = sum(tax_amt_exe),
    tax_amt_pre_exe = sum(tax_amt_pre_exe),
    tax_amt_post_exe = sum(tax_amt_post_exe),
  ) %>%
  mutate(total_revenue = final_tax_to_dist+final_tax_to_tif,
         tax_share = total_revenue / sum(total_revenue),
         dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist)) %>%
  mutate(
    "Total Tax Revenue(District+TIF)" = scales::dollar(tax_amt_post_exe),
    "District Revenue" = scales::dollar(final_tax_to_dist),
    "TIF Revenue" = scales::dollar(final_tax_to_tif),
    "Lost Revenue from Exempt." = scales::dollar(tax_amt_exe), # same as tax_amt_pre_exe-tax_amt_post_exe
    "District Tax Share" = scales::percent(dist_tax_share),
    "EAV in TIF" = final_tax_to_tif/composite_tax_rate,
    # TIF EAV matches JD almost perfectly, Commercial 5A does not match. 
    "EAV outside TIF" = final_tax_to_dist/composite_tax_rate,
    TotalEAVafterExemptions = `EAV outside TIF`+total_exemptions$TotalExemptions) %>% 
  mutate(EAVbeforeExemptions = `EAV in TIF`+ `EAV outside TIF` + total_exemptions$TotalExemptions) %>%
  select(-c(tax_amt_post_exe:tax_share, dist_tax_share, final_tax_to_dist:tax_amt_pre_exe))
```

Amount paid to taxing district and tif by property class?

> the final_tax_to_dist(renamed to District Revenue) variable is very close to JD's Tax Amount Column by class in Excel. 

Tax Share percentages now match perfectly.




## Exemptions by Type of Exemption

 Perfect match with JD Excel file
```{r}
pin_data_summarytable<- pin_data %>% 
  mutate(inTIF = ifelse(pin %in% tif_pins_dt$pin, 1,0)) %>%
  summarize(#eav = sum(eav),
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_longtime_homeowner = sum(exe_longtime_homeowner),
  exe_disabled = sum(exe_disabled),
  exe_vet_returning = sum(exe_vet_returning),
  exe_vet_dis = sum(exe_vet_dis_lt50+exe_vet_dis_50_69+exe_vet_dis_ge70),
  exe_abate = sum(exe_abate)
  
) %>%
  mutate(TOTAL = sum(exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
                       exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate))  %>% 
  pivot_longer(cols = exe_homeowner:TOTAL, 
               values_to = "exemptions", 
               names_to = "exemption_type")

pin_data_summarytable


```

Exemption Total Values match JD's file.

`r pin_data_summarytable %>% filter(exemption_type == "TOTAL") %>% mutate(exemptions = format(exemptions, big.mark=","))`




### TIFs

Tax Code Rate 2021 for All Cicero TIFS is 14.376. That is exactly the same as the composite tax rate calculated earlier.

TIF information comes from Cook County Clerk's Office.

`tif_share` = the tax_code_distribution_pct / 100 and comes from tif_distribution table. Comes from lookup_tif() command. Calculated behind the scenes. Documentation for their process is in Gitlab R/lookup.R file

Lets find TIF taxing agencies and combine them with the other taxing agencies for the geographic area:

```{r eav-per-taxcode}

revtoTIF_per_taxcode <- area_data %>%
  group_by(tax_code) %>%
  summarize(#eav = sum(eav),
            final_tax_to_tif=sum(final_tax_to_tif),
            final_tax_to_dist=sum(final_tax_to_dist))
# 12 tax_codes with eav inside each one
revtoTIF_per_taxcode



area_data %>%
  group_by(agency_name, tax_code) %>%
  summarize(#eav = sum(eav),
            exe_toal = sum(exe_total),
            pin_count = n())
 
```


```{r tif-taxing-agencies}
# slightly more tax_codes than pins
# most pins have one tax code
tax_codes <- lookup_tax_code(2021, area_pins2) 

# gives you tax_codes and agency_num and agency_name and the tif_share
# agency_minor_type = TIF
tif_taxing_agencies <- lookup_tif(2021, tax_codes) #all tax codes within a tif

tif_taxing_agencies # tif taxcodes and tif taxing agencies


#pindata_in_tifs <- inner_join(tif_taxing_agencies, area_data
      #)
# 25,200 pins in tifs. 
#pindata_in_tifs %>% arrange(tif_share)


tif_tax_codes <- as.character(tif_taxing_agencies$tax_code)
#tax_codes <- lookup_tax_code(2021, tif_tax_codes)
```

All non tif taxing agencies:
```{r}
# there are 13 non-tif taxing agencies in Cicero.
taxing_agencies <- lookup_agency(2021, tax_codes) 
taxing_agencies %>% arrange(tax_code)

taxing_agencies %>% 
  group_by(agency_name)%>%
  summarize(EAV = first(agency_total_eav),
    total_levy = first(agency_total_ext)) %>% 
  arrange(total_levy)
  
# all_taxing_agencies <- full_join(taxing_agencies, tif_taxing_agencies, 
#                              #    by = c("year", "tax_code", "agency_name", "agency_num")
#                                  ) %>% mutate(in_tif = ifelse(is.na(tif_share), 0, 1))
```

Combine tif and non-tif taxing agencies:
```{r}


all_taxing_agencies <- rbind(taxing_agencies, tif_taxing_agencies, fill=TRUE) %>% 
  mutate(in_tif = ifelse(is.na(tif_share), 0, 1))


all_taxing_agencies %>%
  group_by(agency_num, agency_name, in_tif) %>% 
  summarize(agency_total_eav = mean(agency_total_eav),
            tif_share = mean(tif_share),
            agency_total_ext=mean(agency_total_ext)
          #  ,summed_eav = sum(eav)
            )

all_taxing_agencies %>%
  group_by(agency_num,agency_name, in_tif) %>% 
  summarize(eav = first(agency_total_eav)) %>% 
  pivot_wider(names_from="in_tif", values_from = "eav")
```

Need EAV of each Tax Code. Then we know the TIF eav from TIF tax_codes and other agency EAVs from Tax codes associated with other agencies.
all_taxing_agencies has agency_total_eav but that includes all pin values everywhere that are included in that tax_code (So across all of cook county for Cook County's total eav)

```{r pins-in-tifs}
taxcodes_intifs <- all_taxing_agencies %>% filter(in_tif==1) %>% select(tax_code) %>% distinct() 

taxcodes_intifs
# 9 tax codes in tifs

tif_agency_nums <- all_taxing_agencies %>% filter(in_tif==1) %>% select(agency_num) %>% distinct()

tif_agency_nums
# TIF distributions will include all the unique tax codes that make up
# a TIF

# tif_dists <- DBI::dbGetQuery(
#   ptaxsim_db_conn, "
#   SELECT *
#   FROM tif_distribution
#   WHERE agency_num IN tif_agency_nums
#   "
# )

 joined_data <- left_join(pin_data, all_taxing_agencies)

 joined_data %>%
   group_by(agency_num, agency_name, in_tif) %>% 
   summarize(eav =# ifelse(in_tif==1, sum(eav), 
                          mean(agency_total_eav),
             levy=mean(agency_total_ext))# %>% 
  # pivot_wider(names_from = "in_tif", values_from = "eav")
```
> Calculate the increment by comparing the total property value in the TIF (in EAV) to the frozen amount. Anything above the frozen amount is taxed by the TIF

Get all pins within TIF area, then compare total equalized assessed value to the value "frozen" by the TIF.

```{r}
# pins_in_tifs <- pindata_in_tifs %>% distinct(pin) %>% as.character()
# tif_pins_dt <- lookup_pin(2021, pins_in_tifs)# %>%
#   mutate(tax_code = lookup_tax_code(year, pin))
# 
# tif_pins_summ <- tif_pins_dt %>%
#   group_by(year) %>%
#   summarize(total_eav = sum(eav)) %>%
#   left_join(tif_dists, by = "year") %>%
#   mutate(amt_to_tif = total_eav - tax_code_frozen_eav)
```


```{r eval=FALSE}
pins_in_tifs <- left_join(taxcodes_intifs, area_data#, by = c("agency_name"="tif_agency_name")
                          ) %>% 
  mutate(pin_in_tif = ifelse(final_tax_to_tif > 0, 1, 0))

area_data <- left_join(area_data, pins_in_tifs)

pins_in_tifs %>% group_by(tif_agency_name) %>% 
  summarize(eav = sum(eav),
        #    final_tax = sum(final_tax), # final tax only exists if simplify = TRUE in that tax_bill() command.
            final_tax_to_dist = sum(final_tax_to_dist),
            final_tax_to_tif = sum(final_tax_to_tif),
            tax_amt_exe = sum(tax_amt_exe),
            tax_amt_pre_exe = sum(tax_amt_pre_exe),
            tax_amt_post_exe = sum(tax_amt_post_exe),
        agency_tax_rate = mean(agency_tax_rate)
            ) %>%
#  arrange(agency_num) %>%
  mutate(weighted_tax_rate = agency_tax_rate*eav) %>% 
  ungroup() %>%
  mutate(composite_tax_rate = sum(weighted_tax_rate)/max(eav) )
```


agency_total_eav			The total amount of EAV within the taxing district, otherwise known as the “base”. This is the denominator when calculating tax rates


agency_total_ext			The total extension requested by the taxing district, otherwise known as the “levy”. This is the amount the district needs in tax revenue and is the numerator when calculating tax rates


"Changing tax_code_vec “relocates” a PIN by changing the things that are taxing it. This can be useful for counterfactual analysis. For example, if you own property within a school district and want to know what your tax bill would be just outside the district, but otherwise within the same municipality, then you can find the tax code that represents that situation and plug it into tax_bill()"




```{r}
#agency <- lookup_agency(2021, tax_code)
#agency 

#oak_pins2 <- fromJSON(rawToChar(oak_pins$content))$pin

#oak_pins2 %>% group_by(pin) %>% distinct()

tifs <- lookup_tif(2021, tax_codes)
tifs

joined <- left_join(area_data, tifs, by = c("year", "tax_code", "agency_num", "agency_name"))



joined  %>%
  group_by(major_class_type, major_class_code) %>%
  summarize(EAV = sum(eav),
    Exemptions =  sum(tax_amt_exe),
    tax_amt_pre_exe = sum(tax_amt_pre_exe),
            tax_amt_post_exe = sum(tax_amt_post_exe),
            tif_amount = sum(final_tax_to_tif),
            tax_to_district = sum(final_tax_to_dist)) %>%
  arrange(major_class_code)
 # mutate(Tax_Amount=sum(district_amount),
 #        TIF_Amount = sum(tif_amount))


#area_data <- full_join(area_data, pin_data)
area_data%>% 
  filter(final_tax_to_tif>0) %>%
  group_by(major_class_code)%>%
  summarise(tax_to_tif = sum(final_tax_to_tif),)
```

# Counterfactuals

## Removing Exemptions

```{r}
bills_w_exe <- tax_bill(2018:2021, muni_pins$pin, simplify = FALSE)

bills_w_exe_summ <- bills_w_exe %>%
  group_by(year) %>%
  summarize(
    exe = sum(tax_amt_exe),
    bill_total = sum(final_tax_to_tif) + sum(final_tax_to_dist),
    Type = "With exemptions"
  ) %>%
  select(Year = year, Type, "Exemption Amt." = exe, "Bill Amt." = bill_total)

## now remove exemptions
exe_dt <- lookup_pin(2018:2021, muni_pins$pin) %>%
  mutate(across(starts_with("exe_"), ~0)) %>%
  setDT(key = c("year", "pin"))

bills_no_exe <- tax_bill(2018:2021,
  muni_pins$pin,
  pin_dt = exe_dt,
  simplify = FALSE
)

bills_no_exe_summ <- bills_no_exe %>%
  group_by(year) %>%
  summarize(
    exe = sum(tax_amt_exe),
    bill_total = sum(final_tax_to_tif) + sum(final_tax_to_dist),
    Type = "No exemptions"
  ) %>%
  select(Year = year, Type, "Exemption Amt." = exe, "Bill Amt." = bill_total)
bills_no_exe_summ

bills_plot_2 <- rbind(bills_w_exe_summ, bills_no_exe_summ) %>%
  ggplot() +
  geom_line(aes(x = Year, y = `Bill Amt.`, linetype = Type), linewidth = 1.1) +
#  scale_x_continuous(n.breaks = 9) +
  scale_y_continuous(labels = scales::label_dollar()) +
  scale_linetype_manual(
    name = "",
    values = c("With exemptions" = "solid", "No exemptions" = "dashed")
  ) +
  theme_minimal() 
bills_plot_2
```
```{r}
t_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "
  SELECT DISTINCT pin
  FROM pin
  WHERE substr(tax_code_num, 1, 2) = '14'
  "
)
t_pins <- muni_pins$pin
t_years <- 2006:2021

t_bills_w_exe <- tax_bill(t_years, t_pins)[, stage := "With exemptions"]

t_pin_dt_no_exe <- lookup_pin(t_years, t_pins)
t_pin_dt_no_exe[, tax_code := lookup_tax_code(year, pin)]

exe_cols <- names(t_pin_dt_no_exe)[startsWith(names(t_pin_dt_no_exe), "exe_")]
t_tc_sum_no_exe <- t_pin_dt_no_exe[,
  .(exe_total = sum(rowSums(.SD))),
  .SDcols = exe_cols,
  by = .(year, tax_code)
]

t_agency_dt_no_exe <- lookup_agency(t_years, t_pin_dt_no_exe$tax_code)
t_agency_dt_no_exe[
  t_tc_sum_no_exe,
  on = .(year, tax_code),
  agency_total_eav := agency_total_eav + exe_total
]

t_pin_dt_no_exe[, (exe_cols) := 0][, c("tax_code") := NULL]

t_bills_no_exe <- tax_bill(
  year_vec = t_years,
  pin_vec = t_pins,
  agency_dt = t_agency_dt_no_exe,
  pin_dt = t_pin_dt_no_exe
)[
  , stage := "No exemptions"
]

# Little function to get the statistical mode
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

t_no_exe_summ <- rbind(t_bills_w_exe, t_bills_no_exe)[
  , class := Mode(substr(class, 1, 1)),
  by = pin
][
  class %in% c("2", "3", "5"),
][
  , class := ifelse(class == "2", "Residential", "Commercial")
][
  , .(total_bill = sum(final_tax)),
  by = .(year, pin, class, stage)
][
  , .(avg_bill = mean(total_bill)),
  by = .(year, class, stage)
][
  , idx_bill := (avg_bill / avg_bill[year == 2006]) * 100,
  by = .(class, stage)
]

t_annot <- tibble(
  class = c("Residential", "Commercial"),
  x = c(2008, 2006.4),
  y = c(105, 115)
)

# Plot the change in indexed values over time
t_no_exe_summ_plot <- ggplot(data = t_no_exe_summ) +
  geom_line(
    aes(x = year, y = idx_bill, color = class, linetype = stage),
    linewidth = 1.1
  ) +
  geom_text(
    data = t_annot,
    aes(x = x, y = y, color = class, label = class),
    hjust = 0
  ) +
  scale_y_continuous(name = "Average Tax Bill, Indexed to 2006") +
  scale_x_continuous(name = "Year", n.breaks = 10, limits = c(2006, 2020.4)) +
  scale_linetype_manual(
    name = "",
    values = c("With exemptions" = "solid", "No exemptions" = "dashed")
  ) +
  scale_color_brewer(name = "", palette = "Set1", direction = -1) +
  guides(color = "none") +
  facet_wrap(vars(class)) +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text.y = element_text(size = 11),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )
t_no_exe_summ_plot
```

## Changing exemptions 

PTAXSIM can also answer hypotheticals about large areas. For example, how would the average residential tax bill in ____ change if the Senior Exemption increased by $5,000 and the Senior Freeze Exemption was removed?

To find out, we again create a PIN input with modified exemption amounts, then recalculate the base by taking the difference between the real and hypothetical exemptions.

```{r}
t_pin_dt_new_exe <- lookup_pin(t_years, t_pins)
t_pin_dt_new_exe[, tax_code := lookup_tax_code(year, pin)]

t_tc_sum_new_exe <- t_pin_dt_new_exe[
  , .(exe_total = sum(exe_freeze - (5000 * (exe_senior != 0)))),
  by = .(year, tax_code)
]
```

Next, we recalculate the base of each district. This time, the base may _lose_ some EAV, since the Senior Exemption is increasing substantially.

```{r}
t_agency_dt_new_exe <- lookup_agency(t_years, t_pin_dt_new_exe$tax_code)
t_agency_dt_new_exe[
  t_tc_sum_new_exe,
  on = .(year, tax_code),
  agency_total_eav := agency_total_eav + exe_total
]
```

Then, we again alter the `pin_dt` input by setting the Senior Freeze Exemption to zero and adding $5,000 to any Senior Exemption.

```{r}
t_pin_dt_new_exe <- t_pin_dt_new_exe[
  , exe_freeze := 0
][
  exe_senior != 0, exe_senior := exe_senior + 5000
][
  , c("tax_code") := NULL
]
```

We again recalculate all tax bills with our updated exemptions and with an updated tax base for each district.

```{r}
t_bills_new_exe <- tax_bill(
  year_vec = t_years,
  pin_vec = t_pins,
  agency_dt = t_agency_dt_new_exe,
  pin_dt = t_pin_dt_new_exe
)[
  , stage := "Changed exemptions"
]
```

Then, do the same aggregation and indexing we did previously, this time using the updated bills.

```{r}
t_new_exe_summ <- rbind(t_bills_w_exe, t_bills_new_exe)[
  , class := Mode(substr(class, 1, 1)),
  by = pin
][
  class %in% c("2", "3", "5"),
][
  , class := ifelse(class == "2", "Residential", "Commercial")
][
  , .(total_bill = sum(final_tax)),
  by = .(year, pin, class, stage)
][
  , .(avg_bill = mean(total_bill)),
  by = .(year, class, stage)
][
  , idx_bill := (avg_bill / avg_bill[year == 2006]) * 100,
  by = .(class, stage)
]



t_new_exe_summ_plot <- ggplot(data = t_new_exe_summ) +
  geom_line(
    aes(x = year, y = idx_bill, color = class, linetype = stage),
    linewidth = 1.1
  ) +
  geom_text(
    data = t_annot,
    aes(x = x, y = y, color = class, label = class),
    hjust = 0
  ) +
  scale_y_continuous(name = "Average Tax Bill, Indexed to 2006") +
  scale_x_continuous(name = "Year", n.breaks = 10, limits = c(2006, 2020.4)) +
  scale_linetype_manual(
    name = "",
    values = c("With exemptions" = "solid", "Changed exemptions" = "dotted")
  ) +
  scale_color_brewer(name = "", palette = "Set1", direction = -1) +
  guides(color = "none") +
  facet_wrap(vars(class)) +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text.y = element_text(size = 11),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

t_new_exe_summ_plot
```

"The net effect of increasing the Senior Exemption while removing the Senior Freeze Exemption is a slight decrease in the _average_ bill. However, this conclusion is ambiguous, complicated by the fact that the Senior Freeze is means-tested, while the Senior Exemption is not. The "real-world effect" of our hypothetical policy change would most likely be an increase in the property tax bills of poorer seniors, even though the average bill decreased.

Ultimately, with some careful coding and assumptions, PTAXSIM (and its included data) can be used to test almost any hypothetical change in exemptions." - exemption vingette


## What if there were no TIFs?

Update output of lookup_tif. `tif_share` is a variable used within tax_bill(). To remove the share of the bill dedicated to a TIF, make this percentage equal to zero. 

Then recalculate Tax Base for all 

```{r}
tif_dt_noTIFS <- lookup_tif(
  2006:2021,
  lookup_tax_code(2006:2021, muni_pins$pin)
) %>%
  # Set TIF shares to 0 for ALL tifs in the municipality, leave non-tif others untouched
  mutate(tif_share = ifelse(agency_num %in% tif_agency_nums, 0, tif_share))

# Recalcuclate Tax base:

# Get the unaltered levy and base for all PINs in geographic area
tif_agency_cntr <- lookup_agency(
  2006:2021,
  lookup_tax_code(2006:2021, muni_pins$pin)
)

# # For each agency and year, get the amount recovered from the TIF using the
# # summary table we created earlier (tif_pins_summ)
# tif_agency_amt_to_add <- tif_agency_cntr %>%
#  # filter(tax_code == "38228") %>%
#   distinct(year, agency_num) %>%
#   left_join(
#     tif_pins_summ %>% select(year, tif_revenue_withinTIF),
#     by = "year"
#   )
# 
# # Update the base by adding the recovered amount to the each district's tax base
# tif_agency_cntr_updated <- tif_agency_cntr %>%
#   left_join(tif_agency_amt_to_add, by = c("year", "agency_num")) %>%
#   rowwise() %>%
#   mutate(agency_total_rev= sum(revenue_todistrict_inTIF+ tif_revenue_withinTIF, na.rm = TRUE)) %>%
#   select(-amt_to_tif) %>%
#   setDT(key = c("year", "tax_code", "agency_num"))
```

Didn't finish this. Memory issue and impatient. Code might work? But idk for sure. 
```{r eval=FALSE}
## Step 3. Recalculate bills
# Calculate unaltered, original bills for comparison
muni_bills <- tax_bill(2006:2021, muni_pins$pin)

# Calculate counterfactual tax bills where the WTC2 TIF does not exist
tif_bills <- tax_bill(
  year_vec = 2006:2021,
  pin_vec = muni_pins$pin,
  agency_dt = tif_agency_cntr_updated,
  tif_dt = tif_dt_noTIFS
)



## Make a graph
tif_bills_cntr_summ <- muni_bills %>%
  group_by(year, pin) %>%
  summarize(`With TIF` = sum(final_tax)) %>%
  left_join(
    tif_bills %>%
      group_by(year, pin) %>%
      summarize(`No TIF` = sum(final_tax)),
    by = c("year", "pin")
  ) %>%
  tidyr::pivot_longer(ends_with("TIF")) %>%
  group_by(year, name) %>%
  summarize(med_bill = median(value)) %>%
  mutate(
    lt = ifelse(name == "No TIF" & year >= 2015, "s", "d"),
    name = factor(name, levels = c("No TIF", "With TIF")),
  )

tif_bills_cntr_summ


tif_plot_cntr <- ggplot(tif_bills_cntr_summ) +
  geom_line(
    aes(x = year, y = med_bill, color = name, linetype = lt),
    linewidth = 1.1
  ) +
  scale_x_continuous(n.breaks = 9, expand = c(0, 0.4)) +
  scale_y_continuous(n.breaks = 7, labels = scales::label_dollar()) +
  scale_color_manual(
    name = "",
    values = c("With TIF" = "grey50", "No TIF" = "#7d26cd")
  ) +
  labs(x = "Year", y = "Median Tax Bill") +
  guides(linetype = "none") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text = element_text(size = 11),
    axis.ticks.x = element_line(color = "grey70"),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )
tif_plot_cntr
```





