---
title: "Burden Shift from Incentive Properties in [xx]" 
format: 
  html:
    df-print: paged
    code-fold: true
    code-download: true
    toc: true
    toc-location: left
    fig-cap-location: top
    fig-height: 10

---

# Preliminary Setup

```{r setup, warning = FALSE, output = FALSE}

library(tidyverse)
library(ptaxsim)
library(DBI)
library(httr)
library(jsonlite)
library(glue)
library(sf)

knitr::opts_chunk$set(warning = FALSE, message = FALSE)


```

```{r}
#| code-fold: true

nicknames <- readxl::read_excel("./Necessary_Files/muni_shortnames.xlsx")

MC_sums <- read_csv("./Output/ptaxsim_muni_MC_2006-2021.csv") %>% 
  filter(year == 2021) %>% 
  left_join(nicknames)

incentive_sums <- MC_sums %>%
  mutate(
         incentive = ifelse(major_class_code %in% c("6A","6B", "6C", "7A","7B","7C","8"), "Incentive", "Non-Incentive")) %>%
  group_by(clean_name, incentive) %>%
  summarize(av = sum(av),
            eav = sum(eav),
            pins_in_muni = sum(pins_in_muni),
            final_tax_to_dist = sum(final_tax_to_dist),
            current_rate = mean(cur_comp_muni_rate),
            current_taxable_eav = sum(current_taxable_eav))%>%
  mutate(new_av = ifelse(incentive == "Incentive", av*2.5, av),
    new_taxable_eav = ifelse(incentive ==  "Incentive", current_taxable_eav * 2.5 , current_taxable_eav))

incentive_sums <- incentive_sums %>% 
  group_by(clean_name) %>% 
  mutate(munilevy = sum(final_tax_to_dist),
         cur_muni_taxable_eav = sum(current_taxable_eav),
         new_muni_taxable_eav = sum(new_taxable_eav)) %>%
  ungroup() %>%
  mutate(new_comp_rate = munilevy / new_muni_taxable_eav * 100)




burden <- incentive_sums %>% 

  mutate(group_taxes_hyp = new_taxable_eav * (new_comp_rate),
         group_taxes_cur = current_taxable_eav * current_rate,
         pct_eav = eav / cur_muni_taxable_eav) %>%
  mutate(
         pct_taxburden_current = group_taxes_cur / munilevy,
         pct_taxburden_no_incent = group_taxes_hyp / munilevy,
         burden_shift = (pct_taxburden_current - pct_taxburden_no_incent))

burden %>% select(Municipality = clean_name, current_rate, new_comp_rate, pct_taxburden_current, pct_taxburden_no_incent )
```

## Change in Composite Tax Rate 
```{r}

# as a dot graph ## 

order <- burden %>%  
  as_tibble() %>% 
  filter(incentive == "Incentive") %>% 
  # summarize( 
  #           clean_name = unique(clean_name), 
  #           current_rate = unique(current_rate), 
  #           new_comp_rate = unique(new_comp_rate)) %>% 
  arrange(current_rate) %>%
  select(clean_name, current_rate)

head(order)
burden %>% 
  # filter(tax_rate_current < (median(tax_rate_current))+0.002 & tax_rate_current > (median(tax_rate_current))-0.002 |
  #  (tax_rate_current > 0.25 | tax_rate_current < 0.08 )) %>%
  #          (tax_rate_current < (median(tax_rate_current))+0.005 & tax_rate_current > (median(tax_rate_current))-0.005 )) %>% 
  #filter(PropType == "Single-Family") %>%
  filter(incentive == "Incentive") %>%
  #ungroup() %>% 
  select(clean_name, current_rate, new_comp_rate) %>% 
  pivot_longer(c("current_rate", "new_comp_rate"), 
               names_to = "type", values_to = "tax_rate") %>% 
  left_join(order) %>%
  ggplot(aes(x = tax_rate, y= reorder(clean_name, current_rate)))+
  
  geom_line(aes(group = clean_name))+ 
 # geom_hline(yintercept = 3.5, linetype = 2)+
 # geom_hline(yintercept = 13.5, linetype = 2) +
  geom_point(aes(color=type), size=3 )+
  theme_minimal() + 
  theme( 
    legend.title = element_blank(),
    plot.title.position = "plot",
    #   panel.background = element_rect(fill='transparent'), #transparent panel bg
    plot.background = element_rect(fill='transparent', color=NA) #transparent plot bg
  )+
  scale_color_brewer(palette="Paired", labels = c("Incentives", "No Incentives"), direction = 1)+
  
  labs(title = "Difference in Composite Tax Rate if Assessed at 25%",
       subtitle = "Ordered by Current Composite Tax Rate", x = "Composite Tax Rate (%)", y = "" , 
       caption = "For the highest, median, and lowest municipality composite tax rates")
```


## Change in Tax Burden

```{r}

# as a dot graph ## 

order <- burden %>%  
  as_tibble() %>% 
  filter(incentive == "Incentive") %>% 
  # summarize( 
  #           clean_name = unique(clean_name), 
  #           current_rate = unique(current_rate), 
  #           new_comp_rate = unique(new_comp_rate)) %>% 
  arrange(pct_taxburden_current) %>%
  select(clean_name, pct_taxburden_current)

head(order)
burden %>% 
  # filter(tax_rate_current < (median(tax_rate_current))+0.002 & tax_rate_current > (median(tax_rate_current))-0.002 |
  #  (tax_rate_current > 0.25 | tax_rate_current < 0.08 )) %>%
  #          (tax_rate_current < (median(tax_rate_current))+0.005 & tax_rate_current > (median(tax_rate_current))-0.005 )) %>% 
  #filter(PropType == "Single-Family") %>%
  filter(incentive == "Incentive") %>%
  #ungroup() %>% 
  select(clean_name, pct_taxburden_current, pct_taxburden_no_incent) %>% 
  pivot_longer(c("pct_taxburden_current", "pct_taxburden_no_incent"), 
               names_to = "type", values_to = "tax_rate") %>% 
  left_join(order) %>%
  ggplot(aes(x = tax_rate, y= reorder(clean_name, pct_taxburden_current)))+
  
  geom_line(aes(group = clean_name))+ 
 # geom_hline(yintercept = 3.5, linetype = 2)+
 # geom_hline(yintercept = 13.5, linetype = 2) +
  geom_point(aes(color=type), size=3 )+
  theme_minimal() + 
  theme( 
    legend.title = element_blank(),
    plot.title.position = "plot",
    #   panel.background = element_rect(fill='transparent'), #transparent panel bg
    plot.background = element_rect(fill='transparent', color=NA) #transparent plot bg
  )+
  scale_color_brewer(palette="Paired", labels = c("Incentives", "No Incentives"), direction = 1)+
  
  labs(title = "Difference in Tax Burden if Assessed at 25%",
       subtitle = "Ordered by Current Tax Burden", x = "% of Levy Paid", y = "" , 
       caption = "")
```
