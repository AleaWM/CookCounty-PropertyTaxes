---
title: "Bridgeview Data Replication"
author: "Alea Wilbur"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    df_print: paged
  word_document:
    toc: yes
---

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error=TRUE)


library(tidyverse)
library(DBI)
library(data.table)
library(ggspatial)
library(gstat)
library(here)
library(httr)
library(jsonlite)
library(ptaxsim)
library(sf)
library(stars)
library(glue)


#remotes::install_gitlab("ccao-data-science---modeling/packages/ptaxsim")

#renv::install("gitlab::ccao-data-science---modeling/packages/ptaxsim")


# Create the DB connection with the default name expected by PTAXSIM functions
ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), "./ptaxsim.db/ptaxsim-2021.0.4.db")

# has all potential property classes for pins
# downloaded from CCAO gitlab website
## I used this to merge additional information to the pins and class data later on.
class_dict <- read_csv("class_dict.csv")
```

# Oak Park Replication Numbers

```{r include=FALSE}


#Including `pin`, `class` and `tax_code` in the `$select` command creates duplicate rows.  If you want unique pins to use in other commands (such as `lookup_pin()`), then you must group & summarize by pin.

#Otherwise only include `pin` in your select = command.


# old way of pulling pins from data portal. Not needed if using other method of pulling pins within MUNI taxing agency.
base_url <- "https://datacatalog.cookcountyil.gov/resource/tx2p-k2g9.json"

area_data <- GET(
  base_url,
  query = list(
    year = 2021,
    property_city = "BRIDGEVIEW",
   # `$select` = paste0(c("pin", "class","tax_code"),
 #  collapse = ","),   
   `$select` =  "pin",     # if we want ONLY the pin
    `$limit` = 500000L
  )
)

# change data type to character
# 5339 pins
area_pins2 <- fromJSON(rawToChar(area_data$content))$pin 

# 5339 tax codes
#area_taxcodes <- fromJSON(rawToChar(area_data$content))$tax_code
```

## Pulling Muni data tables

Pulling all taxing agencies directly related to Bridgeview. Includes TIFs, SSAs, Library, and Village of Bridgeview (what we want).

Then we use the agency number for the the Village to pull all unique pins in the municipality, and plug that into tax_bill() for historic data of tax bills within the municipality.

Also create object for unique tax codes, and unique pins to plug into lookup() commands later.

```{r}
agency_names <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE agency_name LIKE '%OAK PARK%'"
)
## 17 agency names (TIF & non-TIF) that have anything to do with Bridgeview in their names
agency_names


# agency_num = 030120000. So far so good. 
muni_agency_nums<- agency_names %>% 
  filter(minor_type %in% c("MUNI", "TOWNSHIP")) %>%
  select(agency_num)

# 27 tax codes in MUNI taxing agencies for Bridgeview in 2021
muni_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({muni_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

# 5302 pins in tax codes within muni taxing agency in 2021
muni_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT pin, class
  FROM pin
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))
```

There were 27 distinct taxing agencies for the Village of Bridgeview and 5302 PINs with those tax codes during 2021.

## Tax Bill values from tax_bill()

In general, I never use the simply=TRUE default in the tax_bill() function. I want the amount that goes to the tif, the district, and the pre and post exemption bill amounts. These are only returned if `simplify=FALSE`.




Notes to self:

-   Composite tax rates is the aggregate of taxing agency rates.

-   Taxing agencies revenues = tax rate \* frozen EAV

-   Frozen EAV = Tax Revenue / tax rate

-   TIF revenue = TIF's tax rate \* incremental EAV

```{r}
## Small difference in number of taxbills between methods
# 78,335 taxbills/observations for muni in 2021
# 77832 using muni_pins$pin method from ptaxsim datatable


# method pulls pins from Cook County data portal for properties within property_city = "BRIDGEVIEW"
# method used in old exampes on their GitLab. Probably won't use anymore.
# area_data <- tax_bill(2021, area_pins2, simplify = FALSE)

# 77832 using muni_pins$pin method from ptaxsim datatable
bills <- tax_bill(2021, muni_pins$pin, simplify = FALSE)

# all taxpbills for PINs in 2021 in the municipality
# does include 
bills 

# get class info with pin expemption data
class_dict$class_code <- as.character(class_dict$class_code)

bills <- left_join(bills, class_dict, 
                       by=c("class" = "class_code")) %>% 
  mutate(in_tif = ifelse(final_tax_to_tif > 0, 1, 0)) # creat variable for if tax revenue went toward TIF.
```

Amount collected by each taxing agency within the municipality:

```{r}
agency_levies <- bills %>% 
  mutate( weighted_tax_rate = agency_tax_rate*eav) %>%
  group_by(agency_num,agency_name) %>%
  summarize(
    weighted_tax_rate = round(sum(weighted_tax_rate), digits=0), #comparison to JD weighted tax rate
    levy_within_muni = round(sum(final_tax_to_dist, na.rm=TRUE), digits=0),
    tif_rev = round(sum(final_tax_to_tif, na.rm=FALSE), digits=0),
    percent_to_tif = round(tif_rev/ (levy_within_muni+tif_rev), digits = 4))

agency_levies
```

### Composite Tax Rate & Taxing Agencies


```{r}
## values are after exemptions have been subtracted! 
taxing_agencies <- bills %>% 
  group_by(agency_name, agency_num, agency_tax_rate) %>% 
  summarize(eav = sum(eav),
        #    final_tax = sum(final_tax), 
        # final tax only exists if simplify = TRUE in that tax_bill() command.
            final_tax_to_dist = sum(final_tax_to_dist),
            final_tax_to_tif = sum(final_tax_to_tif),
            tax_amt_exe = sum(tax_amt_exe),
            tax_amt_pre_exe = sum(tax_amt_pre_exe),
            tax_amt_post_exe = sum(tax_amt_post_exe),
        agency_tax_rate = mean(agency_tax_rate)
            ) %>%
  arrange(agency_num) %>%
  mutate(weighted_tax_rate = agency_tax_rate*eav) %>% 
  ungroup() %>%
  mutate(composite_tax_rate = sum(weighted_tax_rate)/max(eav) 
         )

taxing_agencies
```

The table above does not include the names of TIF taxing agencies. However it does include the amount of revenue that went to the taxing district compared to the TIF. Sp total amount to TIF we have, but the amount to [each]{.underline} TIF we do not have (yet).

Save the `composite_tax_rate` as its own object because we will reference it in later calculations.

```{r}
# saves composite tax rate as its own object because I might plug it in with the TIF stuff later.
composite_tax_rate <- first(taxing_agencies$composite_tax_rate)


nonTIF_taxingagencies_table <- taxing_agencies %>%
    mutate(`Tax Rate` = round(agency_tax_rate, digits = 6),
           EAV = scales::comma(eav)) %>%

  select(agency_name, agency_name, EAV, `Tax Rate`, weighted_tax_rate, composite_tax_rate) %>%
  rename("Weighted Tax Rate" = weighted_tax_rate,
        "Composite Tax Rate" = composite_tax_rate)

# comparable to JD taxing agency table
nonTIF_taxingagencies_table 
```

Taxing Agency Values above very close to JD excel files. Slight difference for this municipality - Not sure why yet - Most likely from difference in number of bills included in data pull.

Remember, the agencies returned in the tax_bill command are all the Non-TIF taxing agencies ! TIFs do not have their own taxing rate, they just use the composite tax rate for the municipality.

Therefore, we need to calculate the eav within each TIF and then multiply it by the composite tax rate. We can also sum the amount paid to TIFs within each tax_code using the municipal tax bill data for pins and then apply the tif_distribution data table to calculate how much of each tif is in each taxcode.

I do both in the code below and have not chosen one method to stick with.


### Tax Revenue by Property Class

Holds Levy constant.

> EAV pre-exemptions in this calculation will be wrong because the composite tax rate is based on the levy/EAV. So if the eav changes, then the composite tax rate will change. For one bill this doesn't matter. When changing a lot of bills, this matters a lot. New agency rates should be calculated if changing exemptions.

Use the pre- exemption EAV calculated from the pin_lookup() data frame `pin_data$eav` if calculating the original EAV before exemptions.

> Is lookup_pin() eav before or after exemptions??? Check their gitlab code for creating the table.

Need levy to calculate new agency rates or district rates.

**Reminder: Don't sum exe_total or eav from area_data because the values are for pins and there are repeated pins in this data frame!**

```{r}
district_revenue <- bills %>% 
  summarize(
    # tax bill reduced by this much due to exemptions
            tax_amt_exe = sum(tax_amt_exe), 
            
             # What individual tax bill would have been without exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe),
            
             # what tax bill was after exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe),
            
            final_tax_to_dist = sum(final_tax_to_dist), 
            final_tax_to_tif = sum(final_tax_to_tif)) %>%
  
  mutate(total_revenue_amount = final_tax_to_dist + final_tax_to_tif,
         # post exemption district tax share! It changes if exemptions are changed
         dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist),
         # making sure tax_amt_exe is what I think it is next line. Variable not used
         pre_minus_post = tax_amt_pre_exe-tax_amt_post_exe,
         exempted_EAV = tax_amt_exe/composite_tax_rate)


total_revenue_table <- district_revenue %>%
  mutate(
    # eav BEFORE exemptions - Will be wrong if calculated this way!
    EAV_pre_exemptions = tax_amt_pre_exe/composite_tax_rate, 
    EAV_post_exemptions = tax_amt_post_exe/composite_tax_rate, # eav after exemptions
    "Lost Revenue from Exemptions" = scales::dollar(tax_amt_exe), 
    
    "Total Revenue Pre-Exe" = scales::dollar(tax_amt_pre_exe),
    "Total Revenue Post-Exe" = scales::dollar(tax_amt_post_exe),
    
    "TIF Increment Post-Exe" = scales::comma(final_tax_to_tif/composite_tax_rate),
    "EAV outside TIF Post-Exe" = final_tax_to_dist/composite_tax_rate,
    "District Rev Post-Exe" = scales::dollar(final_tax_to_dist),
    "TIF Rev Post-Exe" = scales::dollar(final_tax_to_tif),
    "District Tax Share Post-Exe" = scales::percent(dist_tax_share),
       eav_total = scales::dollar(exempted_EAV+EAV_post_exemptions)

    # EAV in TIF pre-exe will be off becase EAV pre-exemptions will be off. 
   # "EAV in TIF Pre-Exe" = (EAV_pre_exemptions-`EAV outside TIF Post-Exe`),
   # "EAV in TIF Post-Exe" = (EAV_post_exemptions-`EAV outside TIF Post-Exe`)
   ) %>%
  select(-c(final_tax_to_dist:pre_minus_post, tax_amt_exe:tax_amt_post_exe))


total_revenue_table


rev_by_district_and_tif <- bills %>%
  group_by(in_tif) %>%
  summarize(tax_amt_exe = sum(tax_amt_exe), # tax bill reduced by this much due to exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe), # What individual tax bill would have been without exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe), # what tax bill was after exemptions
            final_tax_to_dist = sum(final_tax_to_dist), 
            final_tax_to_tif = sum(final_tax_to_tif)) %>%
  
  mutate(total_revenue_amount = final_tax_to_dist+final_tax_to_tif,
         # post exemption district tax share! It changes if exemptions are changed
         dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist),
         # making sure tax_amt_exe is what I think it is next line. Variable not used
         pre_minus_post = tax_amt_pre_exe-tax_amt_post_exe) %>%
  mutate(
    # eav BEFORE exemptions - Will be wrong if calculated this way!
    EAV_pre_exemptions = tax_amt_pre_exe/composite_tax_rate, 
    EAV_post_exemptions = tax_amt_post_exe/composite_tax_rate, # eav after exemptions

    
    "TIF Increment Post-Exe" = scales::comma(final_tax_to_tif/composite_tax_rate),
    "EAV outside TIF Post-Exe" = final_tax_to_dist/composite_tax_rate,
    "EAV in TIF Post-Exe" = (EAV_post_exemptions-`EAV outside TIF Post-Exe`),
     
    
    "Total Revenue Pre-Exe" = scales::dollar(tax_amt_pre_exe),
    "Total Revenue Post-Exe" = scales::dollar(tax_amt_post_exe),
    
    "District Rev Post-Exe" = scales::dollar(final_tax_to_dist),
    "TIF Rev Post-Exe" = scales::dollar(final_tax_to_tif),
    
    "District Tax Share Post-Exe" = scales::percent(dist_tax_share),
    # EAV in TIF pre-exe will be off becase EAV pre-exemptions will be off. 
   # "EAV in TIF Pre-Exe" = (EAV_pre_exemptions-`EAV outside TIF Post-Exe`),
   "Lost Revenue from Exemptions" = scales::dollar(tax_amt_exe),
   ) %>%
  select(-c(tax_amt_exe:tax_amt_post_exe, final_tax_to_dist:pre_minus_post))

rev_by_district_and_tif

```



```{r}
revenue_by_class <- bills %>% 
  group_by(major_class_code) %>% 
  summarize(
            final_tax_to_dist = sum(final_tax_to_dist), 
            final_tax_to_tif = sum(final_tax_to_tif),
            tax_amt_exe = sum(tax_amt_exe), # tax revenue lost due to exemptions. was individual tax bill decreases for each agency
            tax_amt_pre_exe = sum(tax_amt_pre_exe), # What revenue would have been without exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe) # what revenue was after exemptions
            ) %>%
      mutate(total_tax_amount = final_tax_to_dist+final_tax_to_tif,
             dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist),
             # making sure tax_amt_exe is what I think it is next line. Variable not used
             pre_minus_post = tax_amt_pre_exe-tax_amt_post_exe)

# ENTIRE TABLE IS ARTER EXEMPTIONS ARE SUBTRACTED
revenue_by_class %>% 
  mutate(
    "Major Class" = major_class_code,
    EAV_post_exe = tax_amt_post_exe/composite_tax_rate, # eav after exemptions
    "TIF Increment Post-Exe" = scales::comma(final_tax_to_tif/composite_tax_rate),
    "EAV outside TIF Post-Exe" = final_tax_to_dist/composite_tax_rate,

    "EAV in TIF Post-Exe" = (EAV_post_exe-`EAV outside TIF Post-Exe`),
    
    "Total Revenue Post-Exe" = scales::dollar(tax_amt_post_exe),
    "District Rev Post-Exe" = scales::dollar(final_tax_to_dist),
    "TIF Rev Post-Exe" = scales::dollar(final_tax_to_tif),
    
    "District Tax Share Post-Exe" = scales::percent(dist_tax_share),
     "Lost Revenue from Exemptions" = scales::dollar(tax_amt_exe) # same as tax_amt_pre_exe-tax_amt_post_exe

   ) %>%
 # mutate(EAV = `EAV in TIF Post-Exe`+`EAV outside TIF Post-Exe`) %>%
  select(-c(tax_amt_post_exe:dist_tax_share,final_tax_to_dist:tax_amt_pre_exe, pre_minus_post, major_class_code))
```

## Create TIF vectors

```{r}
# Determining the increment / TIF stuff
# 9 taxing agencies overlap with TIFs
tif_agency_nums <- agency_names %>% 
  filter(minor_type == "TIF") %>% select(agency_num)

# #18 tax_codes for all years
# tif_tax_codes <- DBI::dbGetQuery(
#   ptaxsim_db_conn, 
#   glue_sql("
#   SELECT DISTINCT tax_code_num
#   FROM tax_code
#   WHERE agency_num IN ({tif_agency_nums$agency_num*})
#   ",
#   .con = ptaxsim_db_conn
#   )
# )


# 15 tax_codes in 2021
tif_tax_codes2021 <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({tif_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)


# # 1670 unique pin-class combinations for all years Some pins change classes over time
# # 4978 unique pins
# tif_pins <- DBI::dbGetQuery(
#   ptaxsim_db_conn,
#   glue_sql(
#   "SELECT DISTINCT pin, class
#   FROM pin
#   WHERE tax_code_num IN ({unique_tif_taxcodes$tax_code_num*})
#   ",
#   .con = ptaxsim_db_conn
# ))

# if we want just pins that existed in 2021:
# 415 uniaue pins  in TIFs in 2021
tif_pins2021 <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT year, pin, class
  FROM pin
  WHERE tax_code_num IN ({tif_tax_codes2021$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))

# 1615 distinct pins that are in TIFs for all years
# 415 in 2021
# tif_pins %>% distinct(pin) %>% count()
tif_pins2021 %>%distinct(pin) %>% count()
```

```{r}
# TIF distributions will include all the unique tax codes that make up
# a TIF

# has eav values for each tax code
tif_distrib <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT *
  FROM tif_distribution
  WHERE agency_num IN ({tif_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

#tif_distribution


# has same number of pins as method used above but way faster. 
tif_pins_vec <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue::glue_sql("
    SELECT DISTINCT pin
    FROM pin
    WHERE tax_code_num IN ({unique(tif_distrib$tax_code_num)*})
    AND year = 2021
  ",
    .con = ptaxsim_db_conn
  )
) %>%
  pull(pin)

# has EAV values for each pin in the TIF
# 73,256 obs for all years: pin-tax_code-year combinations.

tif_pins_dt <- lookup_pin(2006:2021, pin = tif_pins_vec) %>%
  mutate(tax_code = lookup_tax_code(year, pin))
# 4672 pins in TIFs in 2021


```

## Lookup_pin() command.

Exemption data is only stored at the individual pin level. Must pull all pins and then aggregate to the level desired.

`area_data` was results from `tax_bill` command which had how much of the taxbill went to each taxing district or the TIF.

`pin_data` created below with the lookup_pin() function has the information on exemptions, eav before exemptions, and the property type. I also create a dummy variable for if the pin is located in a tax_code within a TIF.

```{r}
pin_data <- lookup_pin(2021, muni_pins$pin)

# get class info with pin expemption data
#class_dict$class_code <- as.character(class_dict$class_code)
pin_data <- left_join(pin_data, class_dict, by=c("class" = "class_code")) %>% 
  # create a dummy variable for if the pin is located in a tax_code that is within a tif
  mutate(in_tif = ifelse(pin %in% tif_pins2021$pin, 1,0))
```

EAV by Property Type for Municipality:

```{r}
eav_by_class_inMUNI <- pin_data %>% 
  group_by(major_class_code, major_class_type) %>% 
  summarise(eav = sum(eav))
eav_by_class_inMUNI
```

Amount of EAV in and outside of TIF areas:

> This is the EAV before exemptions are subtracted. Comes from lookup_pin() command.

Individual properties are summed together within the municipality.

```{r error=TRUE}

EAV_inandout_TIF <- pin_data %>% 
  group_by(in_tif) %>% 
  summarise(eav = sum(eav)) %>% 
  pivot_wider(names_from = in_tif, values_from = eav)%>% 
  mutate(total = `0`+`1`) %>%
  rename(
    "EAV outside TIF" = `0`,
    "EAV within TIF" = `1`,
    "Total EAV before exemptions" = total)

EAV_inandout_TIF


EAV_inandout_TIF <- pin_data %>% 
  group_by(major_class_code, major_class_type, in_tif) %>% 
  summarise(eav = sum(eav)) %>% 
  pivot_wider(names_from = in_tif, values_from = eav)%>% 
  mutate(total = `0`+`1`) %>%
  rename("Major Class Num" = major_class_code,
         "Major Class Name" = major_class_type,
    "EAV outside TIF" = `0`,
         "EAV within TIF" = `1`,
         "Total EAV before exemptions" = total)

EAV_inandout_TIF

```

### Exemptions by Exemption Type and Property Class

```{r}
exemptions_by_class <- pin_data %>% 
  group_by(major_class_code, major_class_type)%>%
  summarize(
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_longtime_homeowner = sum(exe_longtime_homeowner),
  exe_disabled = sum(exe_disabled),
  exe_vet_returning = sum(exe_vet_returning),
  exe_vet_dis = sum(exe_vet_dis_lt50+exe_vet_dis_50_69+exe_vet_dis_ge70),
  exe_abate = sum(exe_abate)
  
) %>%
  mutate("Total Exemptions in Class" = sum(exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
                       exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate)) 

exemptions_by_class %>%   
  rename("Major Class Num" = major_class_code,
         "Major Class Name" = major_class_type)
```

## Joining pin_data exemptions & tax_bill revenue data

Join by summed pin_data by property type with summed tax_bill property by type?

```{r}
joined_table <- revenue_by_class %>% 
  left_join(exemptions_by_class)%>%
  mutate(
                            "Tax Revenue(District+TIF)" = scales::dollar(tax_amt_post_exe),
                            TotalEAV = tax_amt_post_exe/composite_tax_rate,
                            "District Revenue" = scales::dollar(final_tax_to_dist),
                            "TIF Revenue" = scales::dollar(final_tax_to_tif),
                            "Lost Revenue from Exempt." = scales::dollar(tax_amt_exe), # same as tax_amt_pre_exe-tax_amt_post_exe
                            "Tax Share" = scales::percent(dist_tax_share),
                            "EAV in TIF" = final_tax_to_tif/composite_tax_rate,
                            # TIF EAV matches JD almost perfectly, Commercial 5A does not match. 
                            "EAV outside TIF" = final_tax_to_dist/composite_tax_rate
                            ) %>% 
  mutate(EAV = `EAV in TIF`+`EAV outside TIF`)
 # select(-c(tax_amt_post_exe:tax_share, final_tax_to_dist:tax_amt_pre_exe,exe_homeowner:TOTAL)) 


#class_exemptions <- full_join(exemptions_by_class,  class_eav, by = "major_class_code") %>%
#  select(major_class_code, major_class_type, eav, final_tax_to_dist, tax_share)
#class_exemptions

joined_table %>% 
  rename("Major Class Num" = major_class_code,
         "Major Class Name" = major_class_type
         ) %>%
  select(-c(tax_amt_pre_exe:pre_minus_post, exe_homeowner:exe_abate, final_tax_to_dist:tax_amt_exe))



```

## TIF Data tables

Increment:\
- Gather all pins within the TIF\
- Sum their EAV\
- compare to value "frozen" by the TIF

```{r}


class_dict$class_code <- as.character(class_dict$class_code)


# tif_pins_dt is unique pins and their exemptions. 
# can sum EAV from this data frame. 
eav_by_class_inTIFS <- tif_pins_dt %>% 
  left_join(class_dict, by = c("class"="class_code")) %>%
  filter(year == 2021) %>%
  group_by(major_class_code, major_class_type) %>% 
  summarize(eav_inTIF = sum(eav))

eav_by_class_inTIFS

tif_pins_summ <- tif_pins_dt %>%
  group_by(year) %>%
  #Summed TIF EAV amounts 
  summarize(eav_inTIF_pre_exe = sum(eav)) %>%
  left_join(tif_distrib, by = "year"
            ) %>%
  # amount of value taxed by tifs  = all EAV in tax code - Frozen EAV level
  mutate(tif_increment = tax_code_eav - tax_code_frozen_eav,
         tifrev2 = tax_code_rate*tif_increment)


tif_pins_sum <- tif_pins_summ %>% group_by(year) %>% 
  summarize(tax_code_eav_pre_exe = sum(tax_code_eav),
            tif_increment_pre_exe = sum(tif_increment),
            frozen_eav_pre_exe = sum(tax_code_frozen_eav))
tif_pins_sum
```

```{r}
tif_inc_plot <- tif_pins_summ %>% 
#  group_by(year)%>% 
  #summarize(frozen_eav = sum(tax_code_frozen_eav)) %>%
  ggplot() +
  
    geom_col(
    aes(x = year, y = tax_code_eav),
    fill = "red",
    alpha = 0.5
  ) +
      geom_col(
    aes(x = year, y = tax_code_frozen_eav),
    fill = "gray40"
  ) +
  scale_y_continuous(
    labels = scales::label_dollar(scale = 1e-6, suffix = "M"),
    expand = c(0, 0)
  ) +
  scale_x_continuous(n.breaks = 9, expand = c(0, 0.4)) +
  labs(x = "Year", y = "Total EAV of PINs in _____", caption = "Red is amount of EAV taxed where the revenue went to the TIF") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text = element_text(size = 11),
    axis.ticks.x = element_line(color = "grey70"),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )
tif_inc_plot
```


### TIFs

`tif_share` = the tax_code_distribution_pct / 100 and comes from tif_distribution table. Comes from lookup_tif() command. Calculated behind the scenes. Documentation for their process is in Gitlab R/lookup.R file

Lets find TIF taxing agencies and combine them with the other taxing agencies for the geographic area:

```{r eav-per-taxcode}

eav_per_taxcode <- bills %>%
  group_by(tax_code) %>%
  summarize(eav = sum(eav),
            final_tax_to_tif=sum(final_tax_to_tif),
            final_tax_to_dist=sum(final_tax_to_dist))
# 20 tax_codes with eav inside each one
eav_per_taxcode

eav_perclasstype <- bills %>%
  group_by(major_class_code, major_class_type) %>%
  summarize(#eav = sum(eav), Don't sum eav at this stage, adds pin eavs multiple times since pins are not unique
            final_tax_to_tif=sum(final_tax_to_tif),
            final_tax_to_dist=sum(final_tax_to_dist))
## Counts pins multiple times? 
## Not unique pins so eav for a pin is added multiple times
eav_perclasstype


bills %>%
  group_by(tax_code) %>%
  summarize(
           # exe_toal = sum(exe_total),
            pin_count = n())

bills %>%
  group_by(agency_name) %>%
  summarize(
            pin_count = n())
```

```{r tif-taxing-agencies}
# slightly more tax_codes than pins
# most pins have one tax code
tax_codes <- lookup_tax_code(2021, muni_pins$pin) 

# gives you tax_codes and agency_num and agency_name and the tif_share
# agency_minor_type = TIF
tif_taxing_agencies <- lookup_tif(2021, tax_codes) #all tax codes within a tif

tif_taxing_agencies # tif taxcodes and tif taxing agencies


#pindata_in_tifs <- inner_join(tif_taxing_agencies, area_data
      #)
# 25,200 pins in tifs. 
#pindata_in_tifs %>% arrange(tif_share)


tif_tax_codes <- as.character(tif_taxing_agencies$tax_code)
#tax_codes <- lookup_tax_code(2021, tif_tax_codes)
```

All non tif taxing agencies:

```{r}
taxing_agencies <- lookup_agency(2021, tax_codes) 
taxing_agencies %>% arrange(tax_code)

taxing_agencies %>% 
  group_by(agency_name)%>%
  summarize(EAV = first(agency_total_eav),
    total_levy = first(agency_total_ext)) %>% 
  arrange(total_levy)
  
# all_taxing_agencies <- full_join(taxing_agencies, tif_taxing_agencies, 
#                              #    by = c("year", "tax_code", "agency_name", "agency_num")
#                                  ) %>% mutate(in_tif = ifelse(is.na(tif_share), 0, 1))
```

Combine tif and non-tif taxing agencies:

```{r}


all_taxing_agencies <- rbind(taxing_agencies, tif_taxing_agencies, fill=TRUE) %>% 
  mutate(in_tif = ifelse(is.na(tif_share), 0, 1))


all_taxing_agencies %>%
  group_by(agency_num, agency_name, in_tif) %>% 
  summarize(agency_total_eav = mean(agency_total_eav),
            tif_share = mean(tif_share),
            agency_total_ext=mean(agency_total_ext)
          #  ,summed_eav = sum(eav)
            )
```

Need EAV of each Tax Code. Then we know the TIF eav from TIF tax_codes and other agency EAVs from Tax codes associated with other agencies.

all_taxing_agencies has agency_total_eav but that includes all pin values everywhere that are included in that tax_code (So across all of cook county for Cook County's total eav)

```{r pins-in-tifs}
taxcodes_intifs <- all_taxing_agencies %>% 
  filter(in_tif==1) %>% 
  select(tax_code) %>% 
  distinct() 

taxcodes_intifs

tif_agency_nums <- all_taxing_agencies %>% 
  filter(in_tif==1) %>% 
  select(agency_num) %>% 
  distinct()

tif_agency_nums

```

> Calculate the increment by comparing the total property value in the TIF (in EAV) to the frozen amount. Anything above the frozen amount is taxed by the TIF

Get all pins within TIF area, then compare total equalized assessed value to the value "frozen" by the TIF.

agency_total_eav The total amount of EAV within the taxing district, otherwise known as the "base". This is the denominator when calculating tax rates

agency_total_ext The total extension requested by the taxing district, otherwise known as the "levy". This is the amount the district needs in tax revenue and is the numerator when calculating tax rates

"Changing tax_code_vec "relocates" a PIN by changing the things that are taxing it. This can be useful for counterfactual analysis. For example, if you own property within a school district and want to know what your tax bill would be just outside the district, but otherwise within the same municipality, then you can find the tax code that represents that situation and plug it into tax_bill()"

```{r}

tifs <- lookup_tif(2021, tax_codes)
tifs

```

### Exemption Types in TIFs

```{r}


# has exemptions for pins within TIFs
tif_pins_dt <- lookup_pin(2021, pin = tif_pins_vec) %>% 
  mutate(tax_code = lookup_tax_code(year, pin))

pin_data_summarytable<- tif_pins_dt %>% 
#  mutate(inTIF = ifelse(pin %in% tif_pins, 1,0)) %>%
  summarize(#eav = sum(eav),
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_longtime_homeowner = sum(exe_longtime_homeowner),
  exe_disabled = sum(exe_disabled),
  exe_vet_returning = sum(exe_vet_returning),
  exe_vet_dis = sum(exe_vet_dis_lt50+exe_vet_dis_50_69+exe_vet_dis_ge70),
  exe_abate = sum(exe_abate)
  
) %>%
  mutate(TOTAL = sum(exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
                       exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate))  %>% 
  pivot_longer(cols = exe_homeowner:TOTAL, 
               values_to = "exemptions", 
               names_to = "exemption_type")

pin_data_summarytable


```

Exemption Total Values match JD's file.

`r pin_data_summarytable %>% filter(exemption_type == "TOTAL") %>% mutate(exemptions = format(exemptions, big.mark=","))`

Not sure how value within TIF is calculated.



## Exporting data into Excel

```{r}
library(openxlsx)

dataset_names <- list('Taxing Agencies from Tax Bills' = taxing_agencies, #tifs not listed as agencies
                      'Agency Levies' = agency_levies, 

                      # comparable to JD taxing agency table
                      'JD Taxing Agencies Comparison' = nonTIF_taxingagencies_table, 
                      
                      'Total District Revenue' = district_revenue,
                      'Total Revenue' = total_revenue_table,
                      'Revenue by District&TIF' = rev_by_district_and_tif,
                      'Revenue by Class' = revenue_by_class,
                     # 'Taxcodes in TIFs' == tif_tax_codes2021, creates problem with excel file?
                      'TIF pins' = tif_pins_dt,
                      'EAV in and out of TIF' = EAV_inandout_TIF,
                      'Exemptions by Class' = exemptions_by_class,
                      'Joined Table' = joined_table,
                     
                      'EAV in Muni'= eav_by_class_inMUNI, # PRE exemptions! 
                      'eav in tifs'= eav_by_class_inTIFS,
                      'TIF increment&frozenTotal'= tif_pins_sum,
                      'tif taxing agencies' = tif_taxing_agencies,
                     
                      'exemption in tifs'= pin_data_summarytable
                      
                      )

write.xlsx(dataset_names, file = 'Bridgeview_2021.xlsx')
```




# Forest Park Replication Numbers


## Pulling Muni data tables

Pulling all taxing agencies directly related to Bridgeview. Includes TIFs, SSAs, Library, and Village of Bridgeview (what we want).

Then we use the agency number for the the Village to pull all unique pins in the municipality, and plug that into tax_bill() for historic data of tax bills within the municipality.

Also create object for unique tax codes, and unique pins to plug into lookup() commands later.

```{r}
agency_names <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE agency_name LIKE '%FOREST PARK%'"
)
## 17 agency names (TIF & non-TIF) that have anything to do with Bridgeview in their names
agency_names


# agency_num = 030120000. So far so good. 
muni_agency_nums<- agency_names %>% 
  filter(minor_type %in% c("MUNI", "TOWNSHIP")) %>%
  select(agency_num)

# 27 tax codes in MUNI taxing agencies for Bridgeview in 2021
muni_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({muni_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

# 5302 pins in tax codes within muni taxing agency in 2021
muni_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT pin, class
  FROM pin
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))
```

There were 27 distinct taxing agencies for the Village of Bridgeview and 5302 PINs with those tax codes during 2021.

## Tax Bill values from tax_bill()

In general, I never use the simply=TRUE default in the tax_bill() function. I want the amount that goes to the tif, the district, and the pre and post exemption bill amounts. These are only returned if `simplify=FALSE`.




Notes to self:

-   Composite tax rates is the aggregate of taxing agency rates.

-   Taxing agencies revenues = tax rate \* frozen EAV

-   Frozen EAV = Tax Revenue / tax rate

-   TIF revenue = TIF's tax rate \* incremental EAV

```{r}
## Small difference in number of taxbills between methods
# 78,335 taxbills/observations for muni in 2021
# 77832 using muni_pins$pin method from ptaxsim datatable


# method pulls pins from Cook County data portal for properties within property_city = "BRIDGEVIEW"
# method used in old exampes on their GitLab. Probably won't use anymore.
# area_data <- tax_bill(2021, area_pins2, simplify = FALSE)

# 77832 using muni_pins$pin method from ptaxsim datatable
bills <- tax_bill(2021, muni_pins$pin, simplify = FALSE)

# all taxpbills for PINs in 2021 in the municipality
# does include 
bills 

# get class info with pin expemption data
class_dict$class_code <- as.character(class_dict$class_code)

bills <- left_join(bills, class_dict, 
                       by=c("class" = "class_code")) %>% 
  mutate(in_tif = ifelse(final_tax_to_tif > 0, 1, 0)) # creat variable for if tax revenue went toward TIF.
```

Amount collected by each taxing agency within the municipality:

```{r}
agency_levies <- bills %>% 
  mutate( weighted_tax_rate = agency_tax_rate*eav) %>%
  group_by(agency_num,agency_name) %>%
  summarize(
    weighted_tax_rate = round(sum(weighted_tax_rate), digits=0), #comparison to JD weighted tax rate
    levy_within_muni = round(sum(final_tax_to_dist, na.rm=TRUE), digits=0),
    tif_rev = round(sum(final_tax_to_tif, na.rm=FALSE), digits=0),
    percent_to_tif = round(tif_rev/ (levy_within_muni+tif_rev), digits = 4))

agency_levies
```

### Composite Tax Rate & Taxing Agencies


```{r}
## values are after exemptions have been subtracted! 
taxing_agencies <- bills %>% 
  group_by(agency_name, agency_num, agency_tax_rate) %>% 
  summarize(eav = sum(eav),
        #    final_tax = sum(final_tax), 
        # final tax only exists if simplify = TRUE in that tax_bill() command.
            final_tax_to_dist = sum(final_tax_to_dist),
            final_tax_to_tif = sum(final_tax_to_tif),
            tax_amt_exe = sum(tax_amt_exe),
            tax_amt_pre_exe = sum(tax_amt_pre_exe),
            tax_amt_post_exe = sum(tax_amt_post_exe),
        agency_tax_rate = mean(agency_tax_rate)
            ) %>%
  arrange(agency_num) %>%
  mutate(weighted_tax_rate = agency_tax_rate*eav) %>% 
  ungroup() %>%
  mutate(composite_tax_rate = sum(weighted_tax_rate)/max(eav) 
         )

taxing_agencies
```

The table above does not include the names of TIF taxing agencies. However it does include the amount of revenue that went to the taxing district compared to the TIF. Sp total amount to TIF we have, but the amount to [each]{.underline} TIF we do not have (yet).

Save the `composite_tax_rate` as its own object because we will reference it in later calculations.

```{r}
# saves composite tax rate as its own object because I might plug it in with the TIF stuff later.
composite_tax_rate <- first(taxing_agencies$composite_tax_rate)


nonTIF_taxingagencies_table <- taxing_agencies %>%
    mutate(`Tax Rate` = round(agency_tax_rate, digits = 6),
           EAV = scales::comma(eav)) %>%

  select(agency_name, agency_name, EAV, `Tax Rate`, weighted_tax_rate, composite_tax_rate) %>%
  rename("Weighted Tax Rate" = weighted_tax_rate,
        "Composite Tax Rate" = composite_tax_rate)

# comparable to JD taxing agency table
nonTIF_taxingagencies_table 
```

Taxing Agency Values above very close to JD excel files. Slight difference for this municipality - Not sure why yet - Most likely from difference in number of bills included in data pull.

Remember, the agencies returned in the tax_bill command are all the Non-TIF taxing agencies ! TIFs do not have their own taxing rate, they just use the composite tax rate for the municipality.

Therefore, we need to calculate the eav within each TIF and then multiply it by the composite tax rate. We can also sum the amount paid to TIFs within each tax_code using the municipal tax bill data for pins and then apply the tif_distribution data table to calculate how much of each tif is in each taxcode.

I do both in the code below and have not chosen one method to stick with.


### Tax Revenue by Property Class

Holds Levy constant.

> EAV pre-exemptions in this calculation will be wrong because the composite tax rate is based on the levy/EAV. So if the eav changes, then the composite tax rate will change. For one bill this doesn't matter. When changing a lot of bills, this matters a lot. New agency rates should be calculated if changing exemptions.

Use the pre- exemption EAV calculated from the pin_lookup() data frame `pin_data$eav` if calculating the original EAV before exemptions.

> Is lookup_pin() eav before or after exemptions??? Check their gitlab code for creating the table.

Need levy to calculate new agency rates or district rates.

**Reminder: Don't sum exe_total or eav from area_data because the values are for pins and there are repeated pins in this data frame!**

```{r}
district_revenue <- bills %>% 
  summarize(
    # tax bill reduced by this much due to exemptions
            tax_amt_exe = sum(tax_amt_exe), 
            
             # What individual tax bill would have been without exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe),
            
             # what tax bill was after exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe),
            
            final_tax_to_dist = sum(final_tax_to_dist), 
            final_tax_to_tif = sum(final_tax_to_tif)) %>%
  
  mutate(total_revenue_amount = final_tax_to_dist + final_tax_to_tif,
         # post exemption district tax share! It changes if exemptions are changed
         dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist),
         # making sure tax_amt_exe is what I think it is next line. Variable not used
         pre_minus_post = tax_amt_pre_exe-tax_amt_post_exe,
         exempted_EAV = tax_amt_exe/composite_tax_rate)


total_revenue_table <- district_revenue %>%
  mutate(
    # eav BEFORE exemptions - Will be wrong if calculated this way!
    EAV_pre_exemptions = tax_amt_pre_exe/composite_tax_rate, 
    EAV_post_exemptions = tax_amt_post_exe/composite_tax_rate, # eav after exemptions
    "Lost Revenue from Exemptions" = scales::dollar(tax_amt_exe), 
    
    "Total Revenue Pre-Exe" = scales::dollar(tax_amt_pre_exe),
    "Total Revenue Post-Exe" = scales::dollar(tax_amt_post_exe),
    
    "TIF Increment Post-Exe" = scales::comma(final_tax_to_tif/composite_tax_rate),
    "EAV outside TIF Post-Exe" = final_tax_to_dist/composite_tax_rate,
    "District Rev Post-Exe" = scales::dollar(final_tax_to_dist),
    "TIF Rev Post-Exe" = scales::dollar(final_tax_to_tif),
    "District Tax Share Post-Exe" = scales::percent(dist_tax_share),
       eav_total = scales::dollar(exempted_EAV+EAV_post_exemptions)

    # EAV in TIF pre-exe will be off becase EAV pre-exemptions will be off. 
   # "EAV in TIF Pre-Exe" = (EAV_pre_exemptions-`EAV outside TIF Post-Exe`),
   # "EAV in TIF Post-Exe" = (EAV_post_exemptions-`EAV outside TIF Post-Exe`)
   ) %>%
  select(-c(final_tax_to_dist:pre_minus_post, tax_amt_exe:tax_amt_post_exe))


total_revenue_table


rev_by_district_and_tif <- bills %>%
  group_by(in_tif) %>%
  summarize(tax_amt_exe = sum(tax_amt_exe), # tax bill reduced by this much due to exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe), # What individual tax bill would have been without exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe), # what tax bill was after exemptions
            final_tax_to_dist = sum(final_tax_to_dist), 
            final_tax_to_tif = sum(final_tax_to_tif)) %>%
  
  mutate(total_revenue_amount = final_tax_to_dist+final_tax_to_tif,
         # post exemption district tax share! It changes if exemptions are changed
         dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist),
         # making sure tax_amt_exe is what I think it is next line. Variable not used
         pre_minus_post = tax_amt_pre_exe-tax_amt_post_exe) %>%
  mutate(
    # eav BEFORE exemptions - Will be wrong if calculated this way!
    EAV_pre_exemptions = tax_amt_pre_exe/composite_tax_rate, 
    EAV_post_exemptions = tax_amt_post_exe/composite_tax_rate, # eav after exemptions

    
    "TIF Increment Post-Exe" = scales::comma(final_tax_to_tif/composite_tax_rate),
    "EAV outside TIF Post-Exe" = final_tax_to_dist/composite_tax_rate,
    "EAV in TIF Post-Exe" = (EAV_post_exemptions-`EAV outside TIF Post-Exe`),
     
    
    "Total Revenue Pre-Exe" = scales::dollar(tax_amt_pre_exe),
    "Total Revenue Post-Exe" = scales::dollar(tax_amt_post_exe),
    
    "District Rev Post-Exe" = scales::dollar(final_tax_to_dist),
    "TIF Rev Post-Exe" = scales::dollar(final_tax_to_tif),
    
    "District Tax Share Post-Exe" = scales::percent(dist_tax_share),
    # EAV in TIF pre-exe will be off becase EAV pre-exemptions will be off. 
   # "EAV in TIF Pre-Exe" = (EAV_pre_exemptions-`EAV outside TIF Post-Exe`),
   "Lost Revenue from Exemptions" = scales::dollar(tax_amt_exe),
   ) %>%
  select(-c(tax_amt_exe:tax_amt_post_exe, final_tax_to_dist:pre_minus_post))

rev_by_district_and_tif

```



```{r}
revenue_by_class <- bills %>% 
  group_by(major_class_code) %>% 
  summarize(
            final_tax_to_dist = sum(final_tax_to_dist), 
            final_tax_to_tif = sum(final_tax_to_tif),
            tax_amt_exe = sum(tax_amt_exe), # tax revenue lost due to exemptions. was individual tax bill decreases for each agency
            tax_amt_pre_exe = sum(tax_amt_pre_exe), # What revenue would have been without exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe) # what revenue was after exemptions
            ) %>%
      mutate(total_tax_amount = final_tax_to_dist+final_tax_to_tif,
             dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist),
             # making sure tax_amt_exe is what I think it is next line. Variable not used
             pre_minus_post = tax_amt_pre_exe-tax_amt_post_exe)

# ENTIRE TABLE IS ARTER EXEMPTIONS ARE SUBTRACTED
revenue_by_class %>% 
  mutate(
    "Major Class" = major_class_code,
    EAV_post_exe = tax_amt_post_exe/composite_tax_rate, # eav after exemptions
    "TIF Increment Post-Exe" = scales::comma(final_tax_to_tif/composite_tax_rate),
    "EAV outside TIF Post-Exe" = final_tax_to_dist/composite_tax_rate,

    "EAV in TIF Post-Exe" = (EAV_post_exe-`EAV outside TIF Post-Exe`),
    
    "Total Revenue Post-Exe" = scales::dollar(tax_amt_post_exe),
    "District Rev Post-Exe" = scales::dollar(final_tax_to_dist),
    "TIF Rev Post-Exe" = scales::dollar(final_tax_to_tif),
    
    "District Tax Share Post-Exe" = scales::percent(dist_tax_share),
     "Lost Revenue from Exemptions" = scales::dollar(tax_amt_exe) # same as tax_amt_pre_exe-tax_amt_post_exe

   ) %>%
 # mutate(EAV = `EAV in TIF Post-Exe`+`EAV outside TIF Post-Exe`) %>%
  select(-c(tax_amt_post_exe:dist_tax_share,final_tax_to_dist:tax_amt_pre_exe, pre_minus_post, major_class_code))
```

## Create TIF vectors

```{r}
# Determining the increment / TIF stuff
# 9 taxing agencies overlap with TIFs
tif_agency_nums <- agency_names %>% 
  filter(minor_type == "TIF") %>% select(agency_num)

# #18 tax_codes for all years
# tif_tax_codes <- DBI::dbGetQuery(
#   ptaxsim_db_conn, 
#   glue_sql("
#   SELECT DISTINCT tax_code_num
#   FROM tax_code
#   WHERE agency_num IN ({tif_agency_nums$agency_num*})
#   ",
#   .con = ptaxsim_db_conn
#   )
# )


# 15 tax_codes in 2021
tif_tax_codes2021 <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({tif_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)


# # 1670 unique pin-class combinations for all years Some pins change classes over time
# # 4978 unique pins
# tif_pins <- DBI::dbGetQuery(
#   ptaxsim_db_conn,
#   glue_sql(
#   "SELECT DISTINCT pin, class
#   FROM pin
#   WHERE tax_code_num IN ({unique_tif_taxcodes$tax_code_num*})
#   ",
#   .con = ptaxsim_db_conn
# ))

# if we want just pins that existed in 2021:
# 415 uniaue pins  in TIFs in 2021
tif_pins2021 <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT year, pin, class
  FROM pin
  WHERE tax_code_num IN ({tif_tax_codes2021$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))

# 1615 distinct pins that are in TIFs for all years
# 415 in 2021
# tif_pins %>% distinct(pin) %>% count()
tif_pins2021 %>%distinct(pin) %>% count()
```

```{r}
# TIF distributions will include all the unique tax codes that make up
# a TIF

# has eav values for each tax code
tif_distrib <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT *
  FROM tif_distribution
  WHERE agency_num IN ({tif_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

#tif_distribution


# has same number of pins as method used above but way faster. 
tif_pins_vec <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue::glue_sql("
    SELECT DISTINCT pin
    FROM pin
    WHERE tax_code_num IN ({unique(tif_distrib$tax_code_num)*})
    AND year = 2021
  ",
    .con = ptaxsim_db_conn
  )
) %>%
  pull(pin)

# has EAV values for each pin in the TIF
# 73,256 obs for all years: pin-tax_code-year combinations.

tif_pins_dt <- lookup_pin(2006:2021, pin = tif_pins_vec) %>%
  mutate(tax_code = lookup_tax_code(year, pin))
# 4672 pins in TIFs in 2021


```

## Lookup_pin() command.

Exemption data is only stored at the individual pin level. Must pull all pins and then aggregate to the level desired.

`area_data` was results from `tax_bill` command which had how much of the taxbill went to each taxing district or the TIF.

`pin_data` created below with the lookup_pin() function has the information on exemptions, eav before exemptions, and the property type. I also create a dummy variable for if the pin is located in a tax_code within a TIF.

```{r}
pin_data <- lookup_pin(2021, muni_pins$pin)

# get class info with pin expemption data
#class_dict$class_code <- as.character(class_dict$class_code)
pin_data <- left_join(pin_data, class_dict, by=c("class" = "class_code")) %>% 
  # create a dummy variable for if the pin is located in a tax_code that is within a tif
  mutate(in_tif = ifelse(pin %in% tif_pins2021$pin, 1,0))
```

EAV by Property Type for Municipality:

```{r}
eav_by_class_inMUNI <- pin_data %>% 
  group_by(major_class_code, major_class_type) %>% 
  summarise(eav = sum(eav))
eav_by_class_inMUNI
```

Amount of EAV in and outside of TIF areas:

> This is the EAV before exemptions are subtracted. Comes from lookup_pin() command.

Individual properties are summed together within the municipality.

```{r error=TRUE}

EAV_inandout_TIF <- pin_data %>% 
  group_by(in_tif) %>% 
  summarise(eav = sum(eav)) %>% 
  pivot_wider(names_from = in_tif, values_from = eav)%>% 
  mutate(total = `0`+`1`) %>%
  rename(
    "EAV outside TIF" = `0`,
    "EAV within TIF" = `1`,
    "Total EAV before exemptions" = total)

EAV_inandout_TIF


EAV_inandout_TIF <- pin_data %>% 
  group_by(major_class_code, major_class_type, in_tif) %>% 
  summarise(eav = sum(eav)) %>% 
  pivot_wider(names_from = in_tif, values_from = eav)%>% 
  mutate(total = `0`+`1`) %>%
  rename("Major Class Num" = major_class_code,
         "Major Class Name" = major_class_type,
    "EAV outside TIF" = `0`,
         "EAV within TIF" = `1`,
         "Total EAV before exemptions" = total)

EAV_inandout_TIF

```

### Exemptions by Exemption Type and Property Class

```{r}
exemptions_by_class <- pin_data %>% 
  group_by(major_class_code, major_class_type)%>%
  summarize(
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_longtime_homeowner = sum(exe_longtime_homeowner),
  exe_disabled = sum(exe_disabled),
  exe_vet_returning = sum(exe_vet_returning),
  exe_vet_dis = sum(exe_vet_dis_lt50+exe_vet_dis_50_69+exe_vet_dis_ge70),
  exe_abate = sum(exe_abate)
  
) %>%
  mutate("Total Exemptions in Class" = sum(exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
                       exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate)) 

exemptions_by_class %>%   
  rename("Major Class Num" = major_class_code,
         "Major Class Name" = major_class_type)
```

## Joining pin_data exemptions & tax_bill revenue data

Join by summed pin_data by property type with summed tax_bill property by type?

```{r}
joined_table <- revenue_by_class %>% 
  left_join(exemptions_by_class)%>%
  mutate(
                            "Tax Revenue(District+TIF)" = scales::dollar(tax_amt_post_exe),
                            TotalEAV = tax_amt_post_exe/composite_tax_rate,
                            "District Revenue" = scales::dollar(final_tax_to_dist),
                            "TIF Revenue" = scales::dollar(final_tax_to_tif),
                            "Lost Revenue from Exempt." = scales::dollar(tax_amt_exe), # same as tax_amt_pre_exe-tax_amt_post_exe
                            "Tax Share" = scales::percent(dist_tax_share),
                            "EAV in TIF" = final_tax_to_tif/composite_tax_rate,
                            # TIF EAV matches JD almost perfectly, Commercial 5A does not match. 
                            "EAV outside TIF" = final_tax_to_dist/composite_tax_rate
                            ) %>% 
  mutate(EAV = `EAV in TIF`+`EAV outside TIF`)
 # select(-c(tax_amt_post_exe:tax_share, final_tax_to_dist:tax_amt_pre_exe,exe_homeowner:TOTAL)) 


#class_exemptions <- full_join(exemptions_by_class,  class_eav, by = "major_class_code") %>%
#  select(major_class_code, major_class_type, eav, final_tax_to_dist, tax_share)
#class_exemptions

joined_table %>% 
  rename("Major Class Num" = major_class_code,
         "Major Class Name" = major_class_type
         ) %>%
  select(-c(tax_amt_pre_exe:pre_minus_post, exe_homeowner:exe_abate, final_tax_to_dist:tax_amt_exe))



```

## TIF Data tables

Increment:\
- Gather all pins within the TIF\
- Sum their EAV\
- compare to value "frozen" by the TIF

```{r}


class_dict$class_code <- as.character(class_dict$class_code)


# tif_pins_dt is unique pins and their exemptions. 
# can sum EAV from this data frame. 
eav_by_class_inTIFS <- tif_pins_dt %>% 
  left_join(class_dict, by = c("class"="class_code")) %>%
  filter(year == 2021) %>%
  group_by(major_class_code, major_class_type) %>% 
  summarize(eav_inTIF = sum(eav))

eav_by_class_inTIFS

tif_pins_summ <- tif_pins_dt %>%
  group_by(year) %>%
  #Summed TIF EAV amounts 
  summarize(eav_inTIF_pre_exe = sum(eav)) %>%
  left_join(tif_distrib, by = "year"
            ) %>%
  # amount of value taxed by tifs  = all EAV in tax code - Frozen EAV level
  mutate(tif_increment = tax_code_eav - tax_code_frozen_eav,
         tifrev2 = tax_code_rate*tif_increment)


tif_pins_sum <- tif_pins_summ %>% group_by(year) %>% 
  summarize(tax_code_eav_pre_exe = sum(tax_code_eav),
            tif_increment_pre_exe = sum(tif_increment),
            frozen_eav_pre_exe = sum(tax_code_frozen_eav))
tif_pins_sum
```

```{r}
tif_inc_plot <- tif_pins_summ %>% 
#  group_by(year)%>% 
  #summarize(frozen_eav = sum(tax_code_frozen_eav)) %>%
  ggplot() +
  
    geom_col(
    aes(x = year, y = tax_code_eav),
    fill = "red",
    alpha = 0.5
  ) +
      geom_col(
    aes(x = year, y = tax_code_frozen_eav),
    fill = "gray40"
  ) +
  scale_y_continuous(
    labels = scales::label_dollar(scale = 1e-6, suffix = "M"),
    expand = c(0, 0)
  ) +
  scale_x_continuous(n.breaks = 9, expand = c(0, 0.4)) +
  labs(x = "Year", y = "Total EAV of PINs in _____", caption = "Red is amount of EAV taxed where the revenue went to the TIF") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text = element_text(size = 11),
    axis.ticks.x = element_line(color = "grey70"),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )
tif_inc_plot
```


### TIFs

`tif_share` = the tax_code_distribution_pct / 100 and comes from tif_distribution table. Comes from lookup_tif() command. Calculated behind the scenes. Documentation for their process is in Gitlab R/lookup.R file

Lets find TIF taxing agencies and combine them with the other taxing agencies for the geographic area:

```{r }

eav_per_taxcode <- bills %>%
  group_by(tax_code) %>%
  summarize(eav = sum(eav),
            final_tax_to_tif=sum(final_tax_to_tif),
            final_tax_to_dist=sum(final_tax_to_dist))
# 20 tax_codes with eav inside each one
eav_per_taxcode

eav_perclasstype <- bills %>%
  group_by(major_class_code, major_class_type) %>%
  summarize(#eav = sum(eav), Don't sum eav at this stage, adds pin eavs multiple times since pins are not unique
            final_tax_to_tif=sum(final_tax_to_tif),
            final_tax_to_dist=sum(final_tax_to_dist))
## Counts pins multiple times? 
## Not unique pins so eav for a pin is added multiple times
eav_perclasstype


bills %>%
  group_by(tax_code) %>%
  summarize(
           # exe_toal = sum(exe_total),
            pin_count = n())

bills %>%
  group_by(agency_name) %>%
  summarize(
            pin_count = n())
```

```{r }
# slightly more tax_codes than pins
# most pins have one tax code
tax_codes <- lookup_tax_code(2021, muni_pins$pin) 

# gives you tax_codes and agency_num and agency_name and the tif_share
# agency_minor_type = TIF
tif_taxing_agencies <- lookup_tif(2021, tax_codes) #all tax codes within a tif

tif_taxing_agencies # tif taxcodes and tif taxing agencies


#pindata_in_tifs <- inner_join(tif_taxing_agencies, area_data
      #)
# 25,200 pins in tifs. 
#pindata_in_tifs %>% arrange(tif_share)


tif_tax_codes <- as.character(tif_taxing_agencies$tax_code)
#tax_codes <- lookup_tax_code(2021, tif_tax_codes)
```

All non tif taxing agencies:

```{r}
taxing_agencies <- lookup_agency(2021, tax_codes) 
taxing_agencies %>% arrange(tax_code)

taxing_agencies %>% 
  group_by(agency_name)%>%
  summarize(EAV = first(agency_total_eav),
    total_levy = first(agency_total_ext)) %>% 
  arrange(total_levy)
  
# all_taxing_agencies <- full_join(taxing_agencies, tif_taxing_agencies, 
#                              #    by = c("year", "tax_code", "agency_name", "agency_num")
#                                  ) %>% mutate(in_tif = ifelse(is.na(tif_share), 0, 1))
```

Combine tif and non-tif taxing agencies:

```{r}


all_taxing_agencies <- rbind(taxing_agencies, tif_taxing_agencies, fill=TRUE) %>% 
  mutate(in_tif = ifelse(is.na(tif_share), 0, 1))


all_taxing_agencies %>%
  group_by(agency_num, agency_name, in_tif) %>% 
  summarize(agency_total_eav = mean(agency_total_eav),
            tif_share = mean(tif_share),
            agency_total_ext=mean(agency_total_ext)
          #  ,summed_eav = sum(eav)
            )
```

Need EAV of each Tax Code. Then we know the TIF eav from TIF tax_codes and other agency EAVs from Tax codes associated with other agencies.

all_taxing_agencies has agency_total_eav but that includes all pin values everywhere that are included in that tax_code (So across all of cook county for Cook County's total eav)

```{r }
taxcodes_intifs <- all_taxing_agencies %>% 
  filter(in_tif==1) %>% 
  select(tax_code) %>% 
  distinct() 

taxcodes_intifs

tif_agency_nums <- all_taxing_agencies %>% 
  filter(in_tif==1) %>% 
  select(agency_num) %>% 
  distinct()

tif_agency_nums

```

> Calculate the increment by comparing the total property value in the TIF (in EAV) to the frozen amount. Anything above the frozen amount is taxed by the TIF

Get all pins within TIF area, then compare total equalized assessed value to the value "frozen" by the TIF.

agency_total_eav The total amount of EAV within the taxing district, otherwise known as the "base". This is the denominator when calculating tax rates

agency_total_ext The total extension requested by the taxing district, otherwise known as the "levy". This is the amount the district needs in tax revenue and is the numerator when calculating tax rates

"Changing tax_code_vec "relocates" a PIN by changing the things that are taxing it. This can be useful for counterfactual analysis. For example, if you own property within a school district and want to know what your tax bill would be just outside the district, but otherwise within the same municipality, then you can find the tax code that represents that situation and plug it into tax_bill()"

```{r}

tifs <- lookup_tif(2021, tax_codes)
tifs

```

### Exemption Types in TIFs

```{r}


# has exemptions for pins within TIFs
tif_pins_dt <- lookup_pin(2021, pin = tif_pins_vec) %>% 
  mutate(tax_code = lookup_tax_code(year, pin))

pin_data_summarytable<- tif_pins_dt %>% 
#  mutate(inTIF = ifelse(pin %in% tif_pins, 1,0)) %>%
  summarize(#eav = sum(eav),
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_longtime_homeowner = sum(exe_longtime_homeowner),
  exe_disabled = sum(exe_disabled),
  exe_vet_returning = sum(exe_vet_returning),
  exe_vet_dis = sum(exe_vet_dis_lt50+exe_vet_dis_50_69+exe_vet_dis_ge70),
  exe_abate = sum(exe_abate)
  
) %>%
  mutate(TOTAL = sum(exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
                       exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate))  %>% 
  pivot_longer(cols = exe_homeowner:TOTAL, 
               values_to = "exemptions", 
               names_to = "exemption_type")

pin_data_summarytable


```

Exemption Total Values match JD's file.

`r pin_data_summarytable %>% filter(exemption_type == "TOTAL") %>% mutate(exemptions = format(exemptions, big.mark=","))`

Not sure how value within TIF is calculated.



## Exporting data into Excel

```{r}
library(openxlsx)

dataset_names <- list('Taxing Agencies from Tax Bills' = taxing_agencies, #tifs not listed as agencies
                      'Agency Levies' = agency_levies, 

                      # comparable to JD taxing agency table
                      'JD Taxing Agencies Comparison' = nonTIF_taxingagencies_table, 
                      
                      'Total District Revenue' = district_revenue,
                      'Total Revenue' = total_revenue_table,
                      'Revenue by District&TIF' = rev_by_district_and_tif,
                      'Revenue by Class' = revenue_by_class,
                     # 'Taxcodes in TIFs' == tif_tax_codes2021, creates problem with excel file?
                      'TIF pins' = tif_pins_dt,
                      'EAV in and out of TIF' = EAV_inandout_TIF,
                      'Exemptions by Class' = exemptions_by_class,
                      'Joined Table' = joined_table,
                     
                      'EAV in Muni'= eav_by_class_inMUNI, # PRE exemptions! 
                      'eav in tifs'= eav_by_class_inTIFS,
                      'TIF increment&frozenTotal'= tif_pins_sum,
                      'tif taxing agencies' = tif_taxing_agencies,
                     
                      'exemption in tifs'= pin_data_summarytable
                      
                      )

write.xlsx(dataset_names, file = 'ForestPark_2021.xlsx')
```

# Cicero Replication Numbers

## Pulling Muni data tables

Pulling all taxing agencies directly related to Bridgeview. Includes TIFs, SSAs, Library, and Village of Bridgeview (what we want).

Then we use the agency number for the the Village to pull all unique pins in the municipality, and plug that into tax_bill() for historic data of tax bills within the municipality.

Also create object for unique tax codes, and unique pins to plug into lookup() commands later.

```{r}
agency_names <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE agency_name LIKE '%CICERO%'"
)
## 17 agency names (TIF & non-TIF) that have anything to do with Bridgeview in their names
agency_names


# agency_num = 030120000. So far so good. 
muni_agency_nums<- agency_names %>% 
  filter(minor_type %in% c("MUNI", "TOWNSHIP")) %>%
  select(agency_num)

# 27 tax codes in MUNI taxing agencies for Bridgeview in 2021
muni_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({muni_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

# 5302 pins in tax codes within muni taxing agency in 2021
muni_pins <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT pin, class
  FROM pin
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))
```

There were 27 distinct taxing agencies for the Village of Bridgeview and 5302 PINs with those tax codes during 2021.

## Tax Bill values from tax_bill()

In general, I never use the simply=TRUE default in the tax_bill() function. I want the amount that goes to the tif, the district, and the pre and post exemption bill amounts. These are only returned if `simplify=FALSE`.




Notes to self:

-   Composite tax rates is the aggregate of taxing agency rates.

-   Taxing agencies revenues = tax rate \* frozen EAV

-   Frozen EAV = Tax Revenue / tax rate

-   TIF revenue = TIF's tax rate \* incremental EAV

```{r}
## Small difference in number of taxbills between methods
# 78,335 taxbills/observations for muni in 2021
# 77832 using muni_pins$pin method from ptaxsim datatable


# method pulls pins from Cook County data portal for properties within property_city = "BRIDGEVIEW"
# method used in old exampes on their GitLab. Probably won't use anymore.
# area_data <- tax_bill(2021, area_pins2, simplify = FALSE)

# 77832 using muni_pins$pin method from ptaxsim datatable
bills <- tax_bill(2021, muni_pins$pin, simplify = FALSE)

# all taxpbills for PINs in 2021 in the municipality
# does include 
bills 

# get class info with pin expemption data
class_dict$class_code <- as.character(class_dict$class_code)

bills <- left_join(bills, class_dict, 
                       by=c("class" = "class_code")) %>% 
  mutate(in_tif = ifelse(final_tax_to_tif > 0, 1, 0)) # creat variable for if tax revenue went toward TIF.
```

Amount collected by each taxing agency within the municipality:

```{r}
agency_levies <- bills %>% 
  mutate( weighted_tax_rate = agency_tax_rate*eav) %>%
  group_by(agency_num,agency_name) %>%
  summarize(
    weighted_tax_rate = round(sum(weighted_tax_rate), digits=0), #comparison to JD weighted tax rate
    levy_within_muni = round(sum(final_tax_to_dist, na.rm=TRUE), digits=0),
    tif_rev = round(sum(final_tax_to_tif, na.rm=FALSE), digits=0),
    percent_to_tif = round(tif_rev/ (levy_within_muni+tif_rev), digits = 4))

agency_levies
```

### Composite Tax Rate & Taxing Agencies


```{r}
## values are after exemptions have been subtracted! 
taxing_agencies <- bills %>% 
  group_by(agency_name, agency_num, agency_tax_rate) %>% 
  summarize(eav = sum(eav),
        #    final_tax = sum(final_tax), 
        # final tax only exists if simplify = TRUE in that tax_bill() command.
            final_tax_to_dist = sum(final_tax_to_dist),
            final_tax_to_tif = sum(final_tax_to_tif),
            tax_amt_exe = sum(tax_amt_exe),
            tax_amt_pre_exe = sum(tax_amt_pre_exe),
            tax_amt_post_exe = sum(tax_amt_post_exe),
        agency_tax_rate = mean(agency_tax_rate)
            ) %>%
  arrange(agency_num) %>%
  mutate(weighted_tax_rate = agency_tax_rate*eav) %>% 
  ungroup() %>%
  mutate(composite_tax_rate = sum(weighted_tax_rate)/max(eav) 
         )

taxing_agencies
```

The table above does not include the names of TIF taxing agencies. However it does include the amount of revenue that went to the taxing district compared to the TIF. Sp total amount to TIF we have, but the amount to [each]{.underline} TIF we do not have (yet).

Save the `composite_tax_rate` as its own object because we will reference it in later calculations.

```{r}
# saves composite tax rate as its own object because I might plug it in with the TIF stuff later.
composite_tax_rate <- first(taxing_agencies$composite_tax_rate)


nonTIF_taxingagencies_table <- taxing_agencies %>%
    mutate(`Tax Rate` = round(agency_tax_rate, digits = 6),
           EAV = scales::comma(eav)) %>%

  select(agency_name, agency_name, EAV, `Tax Rate`, weighted_tax_rate, composite_tax_rate) %>%
  rename("Weighted Tax Rate" = weighted_tax_rate,
        "Composite Tax Rate" = composite_tax_rate)

# comparable to JD taxing agency table
nonTIF_taxingagencies_table 
```

Taxing Agency Values above very close to JD excel files. Slight difference for this municipality - Not sure why yet - Most likely from difference in number of bills included in data pull.

Remember, the agencies returned in the tax_bill command are all the Non-TIF taxing agencies ! TIFs do not have their own taxing rate, they just use the composite tax rate for the municipality.

Therefore, we need to calculate the eav within each TIF and then multiply it by the composite tax rate. We can also sum the amount paid to TIFs within each tax_code using the municipal tax bill data for pins and then apply the tif_distribution data table to calculate how much of each tif is in each taxcode.

I do both in the code below and have not chosen one method to stick with.


### Tax Revenue by Property Class

Holds Levy constant.

> EAV pre-exemptions in this calculation will be wrong because the composite tax rate is based on the levy/EAV. So if the eav changes, then the composite tax rate will change. For one bill this doesn't matter. When changing a lot of bills, this matters a lot. New agency rates should be calculated if changing exemptions.

Use the pre- exemption EAV calculated from the pin_lookup() data frame `pin_data$eav` if calculating the original EAV before exemptions.

> Is lookup_pin() eav before or after exemptions??? Check their gitlab code for creating the table.

Need levy to calculate new agency rates or district rates.

**Reminder: Don't sum exe_total or eav from area_data because the values are for pins and there are repeated pins in this data frame!**

```{r}
district_revenue <- bills %>% 
  summarize(
    # tax bill reduced by this much due to exemptions
            tax_amt_exe = sum(tax_amt_exe), 
            
             # What individual tax bill would have been without exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe),
            
             # what tax bill was after exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe),
            
            final_tax_to_dist = sum(final_tax_to_dist), 
            final_tax_to_tif = sum(final_tax_to_tif)) %>%
  
  mutate(total_revenue_amount = final_tax_to_dist + final_tax_to_tif,
         # post exemption district tax share! It changes if exemptions are changed
         dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist),
         # making sure tax_amt_exe is what I think it is next line. Variable not used
         pre_minus_post = tax_amt_pre_exe-tax_amt_post_exe,
         exempted_EAV = tax_amt_exe/composite_tax_rate)


total_revenue_table <- district_revenue %>%
  mutate(
    # eav BEFORE exemptions - Will be wrong if calculated this way!
    EAV_pre_exemptions = tax_amt_pre_exe/composite_tax_rate, 
    EAV_post_exemptions = tax_amt_post_exe/composite_tax_rate, # eav after exemptions
    "Lost Revenue from Exemptions" = scales::dollar(tax_amt_exe), 
    
    "Total Revenue Pre-Exe" = scales::dollar(tax_amt_pre_exe),
    "Total Revenue Post-Exe" = scales::dollar(tax_amt_post_exe),
    
    "TIF Increment Post-Exe" = scales::comma(final_tax_to_tif/composite_tax_rate),
    "EAV outside TIF Post-Exe" = final_tax_to_dist/composite_tax_rate,
    "District Rev Post-Exe" = scales::dollar(final_tax_to_dist),
    "TIF Rev Post-Exe" = scales::dollar(final_tax_to_tif),
    "District Tax Share Post-Exe" = scales::percent(dist_tax_share),
       eav_total = scales::dollar(exempted_EAV+EAV_post_exemptions)

    # EAV in TIF pre-exe will be off becase EAV pre-exemptions will be off. 
   # "EAV in TIF Pre-Exe" = (EAV_pre_exemptions-`EAV outside TIF Post-Exe`),
   # "EAV in TIF Post-Exe" = (EAV_post_exemptions-`EAV outside TIF Post-Exe`)
   ) %>%
  select(-c(final_tax_to_dist:pre_minus_post, tax_amt_exe:tax_amt_post_exe))


total_revenue_table


rev_by_district_and_tif <- bills %>%
  group_by(in_tif) %>%
  summarize(tax_amt_exe = sum(tax_amt_exe), # tax bill reduced by this much due to exemptions
            tax_amt_pre_exe = sum(tax_amt_pre_exe), # What individual tax bill would have been without exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe), # what tax bill was after exemptions
            final_tax_to_dist = sum(final_tax_to_dist), 
            final_tax_to_tif = sum(final_tax_to_tif)) %>%
  
  mutate(total_revenue_amount = final_tax_to_dist+final_tax_to_tif,
         # post exemption district tax share! It changes if exemptions are changed
         dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist),
         # making sure tax_amt_exe is what I think it is next line. Variable not used
         pre_minus_post = tax_amt_pre_exe-tax_amt_post_exe) %>%
  mutate(
    # eav BEFORE exemptions - Will be wrong if calculated this way!
    EAV_pre_exemptions = tax_amt_pre_exe/composite_tax_rate, 
    EAV_post_exemptions = tax_amt_post_exe/composite_tax_rate, # eav after exemptions

    
    "TIF Increment Post-Exe" = scales::comma(final_tax_to_tif/composite_tax_rate),
    "EAV outside TIF Post-Exe" = final_tax_to_dist/composite_tax_rate,
    "EAV in TIF Post-Exe" = (EAV_post_exemptions-`EAV outside TIF Post-Exe`),
     
    
    "Total Revenue Pre-Exe" = scales::dollar(tax_amt_pre_exe),
    "Total Revenue Post-Exe" = scales::dollar(tax_amt_post_exe),
    
    "District Rev Post-Exe" = scales::dollar(final_tax_to_dist),
    "TIF Rev Post-Exe" = scales::dollar(final_tax_to_tif),
    
    "District Tax Share Post-Exe" = scales::percent(dist_tax_share),
    # EAV in TIF pre-exe will be off becase EAV pre-exemptions will be off. 
   # "EAV in TIF Pre-Exe" = (EAV_pre_exemptions-`EAV outside TIF Post-Exe`),
   "Lost Revenue from Exemptions" = scales::dollar(tax_amt_exe),
   ) %>%
  select(-c(tax_amt_exe:tax_amt_post_exe, final_tax_to_dist:pre_minus_post))

rev_by_district_and_tif

```



```{r}
revenue_by_class <- bills %>% 
  group_by(major_class_code) %>% 
  summarize(
            final_tax_to_dist = sum(final_tax_to_dist), 
            final_tax_to_tif = sum(final_tax_to_tif),
            tax_amt_exe = sum(tax_amt_exe), # tax revenue lost due to exemptions. was individual tax bill decreases for each agency
            tax_amt_pre_exe = sum(tax_amt_pre_exe), # What revenue would have been without exemptions
            tax_amt_post_exe = sum(tax_amt_post_exe) # what revenue was after exemptions
            ) %>%
      mutate(total_tax_amount = final_tax_to_dist+final_tax_to_tif,
             dist_tax_share = final_tax_to_dist/sum(final_tax_to_dist),
             # making sure tax_amt_exe is what I think it is next line. Variable not used
             pre_minus_post = tax_amt_pre_exe-tax_amt_post_exe)

# ENTIRE TABLE IS ARTER EXEMPTIONS ARE SUBTRACTED
revenue_by_class %>% 
  mutate(
    "Major Class" = major_class_code,
    EAV_post_exe = tax_amt_post_exe/composite_tax_rate, # eav after exemptions
    "TIF Increment Post-Exe" = scales::comma(final_tax_to_tif/composite_tax_rate),
    "EAV outside TIF Post-Exe" = final_tax_to_dist/composite_tax_rate,

    "EAV in TIF Post-Exe" = (EAV_post_exe-`EAV outside TIF Post-Exe`),
    
    "Total Revenue Post-Exe" = scales::dollar(tax_amt_post_exe),
    "District Rev Post-Exe" = scales::dollar(final_tax_to_dist),
    "TIF Rev Post-Exe" = scales::dollar(final_tax_to_tif),
    
    "District Tax Share Post-Exe" = scales::percent(dist_tax_share),
     "Lost Revenue from Exemptions" = scales::dollar(tax_amt_exe) # same as tax_amt_pre_exe-tax_amt_post_exe

   ) %>%
 # mutate(EAV = `EAV in TIF Post-Exe`+`EAV outside TIF Post-Exe`) %>%
  select(-c(tax_amt_post_exe:dist_tax_share,final_tax_to_dist:tax_amt_pre_exe, pre_minus_post, major_class_code))
```

## Create TIF vectors

```{r}
# Determining the increment / TIF stuff
# 9 taxing agencies overlap with TIFs
tif_agency_nums <- agency_names %>% 
  filter(minor_type == "TIF") %>% select(agency_num)

# #18 tax_codes for all years
# tif_tax_codes <- DBI::dbGetQuery(
#   ptaxsim_db_conn, 
#   glue_sql("
#   SELECT DISTINCT tax_code_num
#   FROM tax_code
#   WHERE agency_num IN ({tif_agency_nums$agency_num*})
#   ",
#   .con = ptaxsim_db_conn
#   )
# )


# 15 tax_codes in 2021
tif_tax_codes2021 <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({tif_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)


# # 1670 unique pin-class combinations for all years Some pins change classes over time
# # 4978 unique pins
# tif_pins <- DBI::dbGetQuery(
#   ptaxsim_db_conn,
#   glue_sql(
#   "SELECT DISTINCT pin, class
#   FROM pin
#   WHERE tax_code_num IN ({unique_tif_taxcodes$tax_code_num*})
#   ",
#   .con = ptaxsim_db_conn
# ))

# if we want just pins that existed in 2021:
# 415 uniaue pins  in TIFs in 2021
tif_pins2021 <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql(
  "SELECT DISTINCT year, pin, class
  FROM pin
  WHERE tax_code_num IN ({tif_tax_codes2021$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
))

# 1615 distinct pins that are in TIFs for all years
# 415 in 2021
# tif_pins %>% distinct(pin) %>% count()
tif_pins2021 %>%distinct(pin) %>% count()
```

```{r}
# TIF distributions will include all the unique tax codes that make up
# a TIF

# has eav values for each tax code
tif_distrib <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT *
  FROM tif_distribution
  WHERE agency_num IN ({tif_agency_nums$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)

#tif_distribution


# has same number of pins as method used above but way faster. 
tif_pins_vec <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue::glue_sql("
    SELECT DISTINCT pin
    FROM pin
    WHERE tax_code_num IN ({unique(tif_distrib$tax_code_num)*})
    AND year = 2021
  ",
    .con = ptaxsim_db_conn
  )
) %>%
  pull(pin)

# has EAV values for each pin in the TIF
# 73,256 obs for all years: pin-tax_code-year combinations.

tif_pins_dt <- lookup_pin(2006:2021, pin = tif_pins_vec) %>%
  mutate(tax_code = lookup_tax_code(year, pin))
# 4672 pins in TIFs in 2021


```

## Lookup_pin() command.

Exemption data is only stored at the individual pin level. Must pull all pins and then aggregate to the level desired.

`area_data` was results from `tax_bill` command which had how much of the taxbill went to each taxing district or the TIF.

`pin_data` created below with the lookup_pin() function has the information on exemptions, eav before exemptions, and the property type. I also create a dummy variable for if the pin is located in a tax_code within a TIF.

```{r}
pin_data <- lookup_pin(2021, muni_pins$pin)

# get class info with pin expemption data
#class_dict$class_code <- as.character(class_dict$class_code)
pin_data <- left_join(pin_data, class_dict, by=c("class" = "class_code")) %>% 
  # create a dummy variable for if the pin is located in a tax_code that is within a tif
  mutate(in_tif = ifelse(pin %in% tif_pins2021$pin, 1,0))
```

EAV by Property Type for Municipality:

```{r}
eav_by_class_inMUNI <- pin_data %>% 
  group_by(major_class_code, major_class_type) %>% 
  summarise(eav = sum(eav))
eav_by_class_inMUNI
```

Amount of EAV in and outside of TIF areas:

> This is the EAV before exemptions are subtracted. Comes from lookup_pin() command.

Individual properties are summed together within the municipality.

```{r error=TRUE}

EAV_inandout_TIF <- pin_data %>% 
  group_by(in_tif) %>% 
  summarise(eav = sum(eav)) %>% 
  pivot_wider(names_from = in_tif, values_from = eav)%>% 
  mutate(total = `0`+`1`) %>%
  rename(
    "EAV outside TIF" = `0`,
    "EAV within TIF" = `1`,
    "Total EAV before exemptions" = total)

EAV_inandout_TIF


EAV_inandout_TIF <- pin_data %>% 
  group_by(major_class_code, major_class_type, in_tif) %>% 
  summarise(eav = sum(eav)) %>% 
  pivot_wider(names_from = in_tif, values_from = eav)%>% 
  mutate(total = `0`+`1`) %>%
  rename("Major Class Num" = major_class_code,
         "Major Class Name" = major_class_type,
    "EAV outside TIF" = `0`,
         "EAV within TIF" = `1`,
         "Total EAV before exemptions" = total)

EAV_inandout_TIF

```

### Exemptions by Exemption Type and Property Class

```{r}
exemptions_by_class <- pin_data %>% 
  group_by(major_class_code, major_class_type)%>%
  summarize(
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_longtime_homeowner = sum(exe_longtime_homeowner),
  exe_disabled = sum(exe_disabled),
  exe_vet_returning = sum(exe_vet_returning),
  exe_vet_dis = sum(exe_vet_dis_lt50+exe_vet_dis_50_69+exe_vet_dis_ge70),
  exe_abate = sum(exe_abate)
  
) %>%
  mutate("Total Exemptions in Class" = sum(exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
                       exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate)) 

exemptions_by_class %>%   
  rename("Major Class Num" = major_class_code,
         "Major Class Name" = major_class_type)
```

## Joining pin_data exemptions & tax_bill revenue data

Join by summed pin_data by property type with summed tax_bill property by type?

```{r}
joined_table <- revenue_by_class %>% 
  left_join(exemptions_by_class)%>%
  mutate(
                            "Tax Revenue(District+TIF)" = scales::dollar(tax_amt_post_exe),
                            TotalEAV = tax_amt_post_exe/composite_tax_rate,
                            "District Revenue" = scales::dollar(final_tax_to_dist),
                            "TIF Revenue" = scales::dollar(final_tax_to_tif),
                            "Lost Revenue from Exempt." = scales::dollar(tax_amt_exe), # same as tax_amt_pre_exe-tax_amt_post_exe
                            "Tax Share" = scales::percent(dist_tax_share),
                            "EAV in TIF" = final_tax_to_tif/composite_tax_rate,
                            # TIF EAV matches JD almost perfectly, Commercial 5A does not match. 
                            "EAV outside TIF" = final_tax_to_dist/composite_tax_rate
                            ) %>% 
  mutate(EAV = `EAV in TIF`+`EAV outside TIF`)
 # select(-c(tax_amt_post_exe:tax_share, final_tax_to_dist:tax_amt_pre_exe,exe_homeowner:TOTAL)) 


#class_exemptions <- full_join(exemptions_by_class,  class_eav, by = "major_class_code") %>%
#  select(major_class_code, major_class_type, eav, final_tax_to_dist, tax_share)
#class_exemptions

joined_table %>% 
  rename("Major Class Num" = major_class_code,
         "Major Class Name" = major_class_type
         ) %>%
  select(-c(tax_amt_pre_exe:pre_minus_post, exe_homeowner:exe_abate, final_tax_to_dist:tax_amt_exe))



```

## TIF Data tables

Increment:\
- Gather all pins within the TIF\
- Sum their EAV\
- compare to value "frozen" by the TIF

```{r}


class_dict$class_code <- as.character(class_dict$class_code)


# tif_pins_dt is unique pins and their exemptions. 
# can sum EAV from this data frame. 
eav_by_class_inTIFS <- tif_pins_dt %>% 
  left_join(class_dict, by = c("class"="class_code")) %>%
  filter(year == 2021) %>%
  group_by(major_class_code, major_class_type) %>% 
  summarize(eav_inTIF = sum(eav))

eav_by_class_inTIFS

tif_pins_summ <- tif_pins_dt %>%
  group_by(year) %>%
  #Summed TIF EAV amounts 
  summarize(eav_inTIF_pre_exe = sum(eav)) %>%
  left_join(tif_distrib, by = "year"
            ) %>%
  # amount of value taxed by tifs  = all EAV in tax code - Frozen EAV level
  mutate(tif_increment = tax_code_eav - tax_code_frozen_eav,
         tifrev2 = tax_code_rate*tif_increment)


tif_pins_sum <- tif_pins_summ %>% group_by(year) %>% 
  summarize(tax_code_eav_pre_exe = sum(tax_code_eav),
            tif_increment_pre_exe = sum(tif_increment),
            frozen_eav_pre_exe = sum(tax_code_frozen_eav))
tif_pins_sum
```

```{r}
tif_inc_plot <- tif_pins_summ %>% 
#  group_by(year)%>% 
  #summarize(frozen_eav = sum(tax_code_frozen_eav)) %>%
  ggplot() +
  
    geom_col(
    aes(x = year, y = tax_code_eav),
    fill = "red",
    alpha = 0.5
  ) +
      geom_col(
    aes(x = year, y = tax_code_frozen_eav),
    fill = "gray40"
  ) +
  scale_y_continuous(
    labels = scales::label_dollar(scale = 1e-6, suffix = "M"),
    expand = c(0, 0)
  ) +
  scale_x_continuous(n.breaks = 9, expand = c(0, 0.4)) +
  labs(x = "Year", y = "Total EAV of PINs in _____", caption = "Red is amount of EAV taxed where the revenue went to the TIF") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 13),
    axis.title.x = element_text(margin = margin(t = 6)),
    axis.title.y = element_text(margin = margin(r = 6)),
    axis.text = element_text(size = 11),
    axis.ticks.x = element_line(color = "grey70"),
    strip.text = element_text(size = 16),
    strip.background = element_rect(fill = "#c9c9c9"),
    legend.title = element_text(size = 14),
    legend.key.size = unit(24, "points"),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )
tif_inc_plot
```


### TIFs

`tif_share` = the tax_code_distribution_pct / 100 and comes from tif_distribution table. Comes from lookup_tif() command. Calculated behind the scenes. Documentation for their process is in Gitlab R/lookup.R file

Lets find TIF taxing agencies and combine them with the other taxing agencies for the geographic area:

```{r }

eav_per_taxcode <- bills %>%
  group_by(tax_code) %>%
  summarize(eav = sum(eav),
            final_tax_to_tif=sum(final_tax_to_tif),
            final_tax_to_dist=sum(final_tax_to_dist))
# 20 tax_codes with eav inside each one
eav_per_taxcode

eav_perclasstype <- bills %>%
  group_by(major_class_code, major_class_type) %>%
  summarize(#eav = sum(eav), Don't sum eav at this stage, adds pin eavs multiple times since pins are not unique
            final_tax_to_tif=sum(final_tax_to_tif),
            final_tax_to_dist=sum(final_tax_to_dist))
## Counts pins multiple times? 
## Not unique pins so eav for a pin is added multiple times
eav_perclasstype


bills %>%
  group_by(tax_code) %>%
  summarize(
           # exe_toal = sum(exe_total),
            pin_count = n())

bills %>%
  group_by(agency_name) %>%
  summarize(
            pin_count = n())
```

```{r}
# slightly more tax_codes than pins
# most pins have one tax code
tax_codes <- lookup_tax_code(2021, muni_pins$pin) 

# gives you tax_codes and agency_num and agency_name and the tif_share
# agency_minor_type = TIF
tif_taxing_agencies <- lookup_tif(2021, tax_codes) #all tax codes within a tif

tif_taxing_agencies # tif taxcodes and tif taxing agencies


#pindata_in_tifs <- inner_join(tif_taxing_agencies, area_data
      #)
# 25,200 pins in tifs. 
#pindata_in_tifs %>% arrange(tif_share)


tif_tax_codes <- as.character(tif_taxing_agencies$tax_code)
#tax_codes <- lookup_tax_code(2021, tif_tax_codes)
```

All non tif taxing agencies:

```{r}
taxing_agencies <- lookup_agency(2021, tax_codes) 
taxing_agencies %>% arrange(tax_code)

taxing_agencies %>% 
  group_by(agency_name)%>%
  summarize(EAV = first(agency_total_eav),
    total_levy = first(agency_total_ext)) %>% 
  arrange(total_levy)
  
# all_taxing_agencies <- full_join(taxing_agencies, tif_taxing_agencies, 
#                              #    by = c("year", "tax_code", "agency_name", "agency_num")
#                                  ) %>% mutate(in_tif = ifelse(is.na(tif_share), 0, 1))
```

Combine tif and non-tif taxing agencies:

```{r}


all_taxing_agencies <- rbind(taxing_agencies, tif_taxing_agencies, fill=TRUE) %>% 
  mutate(in_tif = ifelse(is.na(tif_share), 0, 1))


all_taxing_agencies %>%
  group_by(agency_num, agency_name, in_tif) %>% 
  summarize(agency_total_eav = mean(agency_total_eav),
            tif_share = mean(tif_share),
            agency_total_ext=mean(agency_total_ext)
          #  ,summed_eav = sum(eav)
            )
```

Need EAV of each Tax Code. Then we know the TIF eav from TIF tax_codes and other agency EAVs from Tax codes associated with other agencies.

all_taxing_agencies has agency_total_eav but that includes all pin values everywhere that are included in that tax_code (So across all of cook county for Cook County's total eav)

```{r }
taxcodes_intifs <- all_taxing_agencies %>% 
  filter(in_tif==1) %>% 
  select(tax_code) %>% 
  distinct() 

taxcodes_intifs

tif_agency_nums <- all_taxing_agencies %>% 
  filter(in_tif==1) %>% 
  select(agency_num) %>% 
  distinct()

tif_agency_nums

```

> Calculate the increment by comparing the total property value in the TIF (in EAV) to the frozen amount. Anything above the frozen amount is taxed by the TIF

Get all pins within TIF area, then compare total equalized assessed value to the value "frozen" by the TIF.

agency_total_eav The total amount of EAV within the taxing district, otherwise known as the "base". This is the denominator when calculating tax rates

agency_total_ext The total extension requested by the taxing district, otherwise known as the "levy". This is the amount the district needs in tax revenue and is the numerator when calculating tax rates

"Changing tax_code_vec "relocates" a PIN by changing the things that are taxing it. This can be useful for counterfactual analysis. For example, if you own property within a school district and want to know what your tax bill would be just outside the district, but otherwise within the same municipality, then you can find the tax code that represents that situation and plug it into tax_bill()"

```{r}

tifs <- lookup_tif(2021, tax_codes)
tifs

```

### Exemption Types in TIFs

```{r}


# has exemptions for pins within TIFs
tif_pins_dt <- lookup_pin(2021, pin = tif_pins_vec) %>% 
  mutate(tax_code = lookup_tax_code(year, pin))

pin_data_summarytable<- tif_pins_dt %>% 
#  mutate(inTIF = ifelse(pin %in% tif_pins, 1,0)) %>%
  summarize(#eav = sum(eav),
  exe_homeowner = sum(exe_homeowner),
  exe_senior = sum(exe_senior),
  exe_freeze = sum(exe_freeze),
  exe_longtime_homeowner = sum(exe_longtime_homeowner),
  exe_disabled = sum(exe_disabled),
  exe_vet_returning = sum(exe_vet_returning),
  exe_vet_dis = sum(exe_vet_dis_lt50+exe_vet_dis_50_69+exe_vet_dis_ge70),
  exe_abate = sum(exe_abate)
  
) %>%
  mutate(TOTAL = sum(exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
                       exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate))  %>% 
  pivot_longer(cols = exe_homeowner:TOTAL, 
               values_to = "exemptions", 
               names_to = "exemption_type")

pin_data_summarytable


```

Exemption Total Values match JD's file.

`r pin_data_summarytable %>% filter(exemption_type == "TOTAL") %>% mutate(exemptions = format(exemptions, big.mark=","))`

Not sure how value within TIF is calculated.



## Exporting data into Excel

```{r}
library(openxlsx)

dataset_names <- list('Taxing Agencies from Tax Bills' = taxing_agencies, #tifs not listed as agencies
                      'Agency Levies' = agency_levies, 

                      # comparable to JD taxing agency table
                      'JD Taxing Agencies Comparison' = nonTIF_taxingagencies_table, 
                      
                      'Total District Revenue' = district_revenue,
                      'Total Revenue' = total_revenue_table,
                      'Revenue by District&TIF' = rev_by_district_and_tif,
                      'Revenue by Class' = revenue_by_class,
                     # 'Taxcodes in TIFs' == tif_tax_codes2021, creates problem with excel file?
                      'TIF pins' = tif_pins_dt,
                      'EAV in and out of TIF' = EAV_inandout_TIF,
                      'Exemptions by Class' = exemptions_by_class,
                      'Joined Table' = joined_table,
                     
                      'EAV in Muni'= eav_by_class_inMUNI, # PRE exemptions! 
                      'eav in tifs'= eav_by_class_inTIFS,
                      'TIF increment&frozenTotal'= tif_pins_sum,
                      'tif taxing agencies' = tif_taxing_agencies,
                     
                      'exemption in tifs'= pin_data_summarytable
                      
                      )

write.xlsx(dataset_names, file = 'Cicero_2021.xlsx')
```



