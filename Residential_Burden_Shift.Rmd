---
title: "Mapping Residential Property Tax Burden Shift"
author: "Alea Wilbur"
date: "`r Sys.Date()`"

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)


library(tidyverse)
library(DBI)
library(data.table)
library(ggspatial)
library(gstat)
library(here)
library(httr)
library(jsonlite)
library(ptaxsim)
library(sf)
library(stars)
library(glue)

# Create the DB connection with the default name expected by PTAXSIM functions
ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), "./ptaxsim.db/ptaxsim-2021.0.4.db")


options(digits=4, scipen = 999)

library(sf)
library(jsonlite)
library(httr)

# link to the API output as a JSON file
muni_shp <- read_sf("https://gis.cookcountyil.gov/traditional/rest/services/politicalBoundary/MapServer/2/query?outFields=*&where=1%3D1&f=geojson")

```

# Data Prep

Pull all agency names that exist, then use agency numbers associated with MUNI types to pull only the `muni_agency_names` object.

There are 946 unique taxing agencies that existed in 2021.

```{r agency-dt}
# has EAV values, extensions by agency_num
agency_dt <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT *
  FROM agency
  WHERE year = 2021
  "
)

```

This table is used for the municipality levy in later calculations.

`agency_dt` has all taxing agencies (but not TIFs) that existed each year and includes their total taxable base (cty_cook_eav), their levy, taxing rate, binary variables for if a municipality is home rule or not, as well as many other variables. Also currently doesn't have agency_names to go with the agency numbers. That will be merged in shortly.

The table has waaaay too many columns to display all at once. Click the arrow on the right-hand side of the table to see additional columns that are hidden initially in the display.

```{r all-muni-names}
# grabs all unique muni names. Would be needed if creating a loop for calculating all munis
# municipality names and their agency number
muni_agency_names <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE minor_type = 'MUNI'
  OR agency_num = '020060000'  

  "
)

muni_agency_names <- muni_agency_names %>% 
  mutate(first6 = str_sub(agency_num,1,6),
         first5 = str_sub(agency_num,1,5)) %>% 
  select(-minor_type)

```

Makes a list of ALL taxing agencies, including TIFs, SSAs, etc.

First 5 and 6 digit codes variables are created to nest TIFs and other taxing agencies within the municipality. Still experimental, variables are not used in the code below.

There are 1,878 taxing agencies. When grouped by minor_type, there are 133 muni agencies, 639 tif agencies, 30 townships, etc.

```{r all-taxingagency-names}
# all agency names, numbers, and types
# includes TIF and non-TIF agencies
all_taxing_agencies <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  "
)

# create same first 5 and 6 digit codes 
all_taxing_agencies <- all_taxing_agencies %>%
  mutate(first6 = str_sub(agency_num,1,6),
         first5 = str_sub(agency_num,1,5))

```

All agencies have an agency name, but there isn't an indicator for which municipality each taxing agency is within. Merging the `muni_agency_names` to `all_taxing_agencies` hopefully adds a variable that allows for grouping and summing at the municipality level that includes SSAs, (if we want to do that). Does not work for School districts or other taxing districts which begin with completely different values (e.g. school districts begin with 4).

> Everything depends on the tax codes.

```{r all-taxingagency-names2}
# none of these are included in their geographic municipality areas automatically. have different agency number code beginnings too. 
all_taxing_agencies %>% 
  filter(major_type == "MISCELLANEOUS") %>% 
  group_by(minor_type) %>%
  summarize(count = n()) 
#all_taxing_agencies %>% filter(minor_type == "FIRE") 
```

Add agency names since those weren't included originally in the table:

```{r all-taxingagency-names3}
all_taxing_agencies <- all_taxing_agencies %>% 
  left_join(muni_agency_names, by = c("first5", "first6")) %>% 
  rename(muni_name =  agency_name.y,
        muni_num = agency_num.y,
        agency_name = agency_name.x,
        agency_num = agency_num.x)



# combine taxing agency names and agency type to data table that has eav and extension values
agency_data <- right_join(agency_dt, all_taxing_agencies) %>% 
  # get rid of unneeded columns to make table outputs smaller
  select(-c(cty_dupage_eav:cty_livingston_eav, lim_numerator, lim_denominator)) %>% # drop some of the unused variables
  arrange(first5, agency_num)

```

Using the agency numbers for each municipality, I pull all tax codes that have an agency_num included in the muni_agency_names object. By narrowing the agencies down to just Municipality types, this prevents duplicate tax_codes from being pulled.

There are 3774 tax codes within Cook County that are taxed by Municipalities. There are 4228 unique tax codes in Cook County in 2021.

```{r municiple-taxcodes}
# muni_agency_nums<- all_taxing_agencies %>% 
#   filter(minor_type %in% c("MUNI")) %>%
#   select(agency_num)

muni_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql("
  SELECT*
  FROM tax_code
  WHERE agency_num IN ({muni_agency_names$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)# %>% select(-agency_rate)


```

```{r}
# Agency number and agency name for all TIFs
TIF_agencies <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  WHERE minor_type = 'TIF'
  "
)

unique_tif_taxcodes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({TIF_agencies$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)


```

## Tax code level data

Read in summarized tax code level data for exemptions and taxbills.

```{r}
taxbills_by_Class_per_TC <- read_csv("taxbills_inMunis_perTC.csv")  %>% 
  mutate(tax_code = as.character(tax_code))  


# get rid of rpm variables, tax_amt_exe,pre and post exemption variables,
exemptions_by_class_per_TC <- read_csv("all_exemptions_by_TC.csv") %>%
    mutate(tax_code_num = as.character(tax_code_num))

tif_distrib <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT *
  FROM tif_distribution
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
) %>% mutate(tax_code_num = as.character(tax_code_num))




taxcodes <- full_join(taxbills_by_Class_per_TC, muni_tax_codes, 
                      by = c("tax_code" = "tax_code_num")) #%>% left_join(tif_distrib,   by = c("tax_code" = "tax_code_num"))
  
  
Change_in_Taxrates <- taxcodes %>% group_by(agency_num) %>% 
  summarize(MuniLevy = sum(final_tax_to_dist, na.rm = TRUE),
            TaxableEAV = sum(final_tax_to_dist/(tax_code_rate.y/100), na.rm = TRUE),
            TIF_increment = sum(final_tax_to_tif/(tax_code_rate.y/100), na.rm=TRUE),
            Exempt_EAV = sum(tax_amt_exe/(tax_code_rate.y/100), na.rm=TRUE))  %>%
  mutate(tax_rate_current = MuniLevy/TaxableEAV,
         Taxable_plus_exemptEAV = TaxableEAV + Exempt_EAV,
         taxrate_new = MuniLevy/Taxable_plus_exemptEAV)
Change_in_Taxrates


taxcodes <-full_join(exemptions_by_class_per_TC, tif_distrib) #%>% mutate(tax_code_frozen_eav = ifelse(is.na(tax_code_frozen_eav), 0, tax_code_frozen_eav))


taxcodes2 <- taxcodes %>% 
 # select(-c(rpm_tif_to_cps:rpm_tif_to_dist,rev_perTC_pre_exemp, rev_perTC_post_exemp)) %>%
  mutate(tax_code_frozen_eav = replace_na(tax_code_frozen_eav, 0),

      ) %>%
  select(-c(year:tax_code_rate, tax_code_eav, tax_code_revenue, tax_code_distribution_pct))

taxcodes2 <- taxcodes2 %>% 
  left_join(muni_tax_codes) %>% 
  left_join(muni_agency_names) %>%   
  left_join(Change_in_Taxrates) %>%
  select(-c(first6, first5, agency_rate)) %>%
  #ungroup() %>%
  mutate(total_exemptions = exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
           exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate,
         district_rev_collected  = ((eav - total_exemptions)*tax_rate_current),
    current_burden = district_rev_collected / MuniLevy,
         no_exemptions_burden = ((eav)*taxrate_new)/MuniLevy,
    ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Commercial"),
         
         PropType = case_when(
           major_class_code %in% c("3","9") ~ "Multi-Family",
           major_class_code == "2" ~ "Single-Family",
           TRUE~ "Commercial-Industrial")) %>% 
  arrange(agency_name)

taxcodes2 

taxcodes2 %>% write.csv("taxcodes_byPropClasses_withEachExemptionType.csv")
```

```{r}
cross_county_lines <- c("030340000","030030000","030040000","030050000", "030080000","030150000","030180000",
  "030280000", "030320000","030440000","030500000", "030560000", "030585000", "030890000",
  "031000000","031120000","031210000","031270000", "031280000")
```

```{r}
burden_shift <- taxcodes2 %>% 
  group_by(agency_name, major_class_code, major_class_type, tax_rate_current, taxrate_new, PropType, ResidentialProps, agency_num) %>%
  summarize(district_rev_collected = sum(district_rev_collected),
            current_burden = sum(current_burden),
            no_exemptions_burden = sum(no_exemptions_burden)) %>%
  select(agency_name, major_class_type, current_burden, no_exemptions_burden, tax_rate_current, taxrate_new, everything()) %>% 
  filter(!agency_num %in% cross_county_lines)

burden_shift

burden_shift %>% arrange(-current_burden)

#burden_shift %>% write.csv("burdenshift_July5.csv")
```



## Maps


Change in Tax Rate for All municipalities after removing exemptions:

```{r}
# 6 Highest and 6 lowest tax rates. View the extremes on both sides
Change_in_Taxrates %>%  filter(tax_rate_current > 0.25 )
                           
Change_in_Taxrates %>%  filter( tax_rate_current < 0.08)

burden_shift <- burden_shift %>% 
  mutate(
    burden_change = no_exemptions_burden-current_burden,
    taxrate_change = taxrate_new - tax_rate_current,
    ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Commercial"),
         
         PropType = case_when(
           major_class_code %in% c("3","9") ~ "Multi-Family",
           major_class_code == "2" ~ "Single-Family",
           TRUE~ "Commercial-Industrial")) %>% filter(!agency_num %in% cross_county_lines)

rate_change<- burden_shift %>% 
  group_by(agency_name) %>% 
  summarize(rate_change = first(taxrate_change))

burden_shift %>% 
    filter(major_class_code == 2) %>% # all property types have same composite tax rate
  full_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = tax_rate_current)) + 
      theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_gradientn(colors = c("white", "maroon"), 
                    #   limits = c(0,.6),
                       n = 6,
                        name = "Tax Rate", label = scales::percent)+
  geom_sf(aes(geometry = geometry), color = "black") +  
  labs(title = "Current tax rates with current exemptions in place")


burden_shift %>%  
  # eliminate duplicate tax rates for each property type
  filter(major_class_code == 2) %>% #  all property types have same composite tax rate
  full_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = taxrate_new)) + 
  geom_sf(aes(geometry = geometry), color = "black") +       theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_gradientn(colors = c("white", "maroon"), 
                    #   limits = c(0,.6),
                       n = 6,
                        name = "Tax Rate", label = scales::percent)+
  geom_sf(aes(geometry = geometry), color = "black")+
  labs(title = "Composite tax rates if there were no homeowner exemptions")
```
```{r}
# as a dot graph ## 

order <- burden_shift %>% ungroup %>% as_tibble() %>%
# filter(YEAR == 2019 & NAME != "NA" & CIHISPEED == "10") %>% 
  select(agency_name, tax_rate_current)



# look at ones that changed the most
burden_shift %>%  
  filter(tax_rate_current > 0.23 |tax_rate_current < 0.085) %>% 
  filter(PropType == "Single-Family") %>%
  ungroup() %>% 
  select(agency_name, tax_rate_current, taxrate_new) %>% 
  pivot_longer(c("tax_rate_current", "taxrate_new"), 
               names_to = "type", values_to = "tax_rate") %>% 
  left_join(order) %>%
  ggplot(aes(x = tax_rate, y= reorder(agency_name, tax_rate_current)))+
  geom_line(aes(group = agency_name))+ 
   geom_point(aes(color=type), size=3 )+
  theme_minimal() + 
  theme(#legend.position = "none", 
    legend.title = element_blank(),
               plot.title.position = "plot",
     #   panel.background = element_rect(fill='transparent'), #transparent panel bg
    plot.background = element_rect(fill='transparent', color=NA) #transparent plot bg
   )+
        scale_color_brewer(palette="Paired", labels = c("Exemptions", "No Exemptions"), direction = 1)+

  labs(title = "Change in Composite Tax Rate if there were No Exemptions", x = "", y = "" , caption = "For the highest and lowest composite tax rates")
```


```{r}



rate_change %>% 
  full_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = rate_change)) + 
  geom_sf(aes(geometry = geometry), color = "black") +  
      theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_gradientn(colors = c("darkblue", "white"), 
                    #   limits = c(0,.6),
                       n = 6,
                        name = "Change in Tax Rate")+
  labs(title = "Change in Tax Rate when Exemptions are removed")


```

Change in Tax Burden for Class 2 Properties:

```{r}
burden_shift %>% 
  full_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
    filter(major_class_code == 2) %>%

  ggplot(aes(fill =current_burden)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  theme_classic() + 
  labs(title = "Current share of property tax burden", subtitle = "for Class = 2 Property Types")


burden_shift %>% 
  full_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
    filter(major_class_code == 2) %>%

  ggplot(aes(fill = no_exemptions_burden)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "New share of property tax burden", subtitle = "for Class = 2 Property Types")
```

One of the areas with a huge burden that was really concerning me is the Village of Frankfort. and that is a border muni. Most of its eav is outside of  cook county. So that's why the Residential burden share was 300% of "municipal levy". I sum up the amount of tax billed by the taxing agency within cook county as a proxy for the Muni levy. BUT most of the tax bill doesn't come from Cook, it comes from Grundy county.

```{r}
burden_shift %>% 
  filter(major_class_code == 2) %>%
  full_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = burden_change)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Change in Residential Share of Tax Burden") +
    theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_gradientn(colors = c("white", "red"), 
                    #   limits = c(0,.6),
                       n = 6,
                        name = "Change in Burden", label = scales::percent)
  
   # geom_sf(data = countyIL, fill=NA, color="dark gray")

```

```{r}
# as a dot graph ## 

order <- burden_shift %>% 
  ungroup %>% as_tibble() %>%
  #  filter(ResidentialProps == "Residential") %>%

  filter(PropType == "Single-Family") %>%
  select(agency_name, current_burden)



# burder_shift_ordered <-  burden_shift %>% 
#   ungroup() %>% 
#   select(agency_name, current_burden, no_exemptions_burden) %>%    
#   pivot_longer(c("current_burden", "no_exemptions_burden"), 
#                names_to = "type", values_to = "pct_burden") %>% 
#   left_join(order)

# look at ones that changed the most
burden_shift %>%  
  filter(current_burden > 0.9 |current_burden < .3 ) %>% 
  #filter(ResidentialProps == "Residential") %>%
    filter(PropType == "Single-Family") %>%

  ungroup() %>% 
  select(agency_name, current_burden, no_exemptions_burden) %>% 
  pivot_longer(c("current_burden", "no_exemptions_burden"), 
               names_to = "type", values_to = "pct_burden") %>% 
  inner_join(order) %>%
  ggplot(aes(x = pct_burden, y= reorder(agency_name, current_burden)))+
  geom_line(aes(group = agency_name))+ 
   geom_point(aes(color=type), size=3 )+
  theme_minimal() + 
  theme(#legend.position = "none", 
    legend.title = element_blank(),
               plot.title.position = "plot",
     #   panel.background = element_rect(fill='transparent'), #transparent panel bg
    plot.background = element_rect(fill='transparent', color=NA) #transparent plot bg
   )+
        scale_color_brewer(palette="Paired", labels = c("Exemptions", "No Exemptions"), direction = 1)+

  labs(title = "Change in Single-family Residential Tax Burden", x = "% Share of Levy", y = "" , caption = "Residential Tax Burden is the Share of the property tax collected that was paid for by 
     single-family home owners in property classes 2.") #+
# scale_x_continuous(label = scales::percent)

```

# Burden Shift: 3 Property Categories


Current Burden:
```{r}
munis_3property_types <- burden_shift %>%
  ungroup() %>% 
  group_by(agency_name, PropType) %>%
  summarize(district_rev_collected = sum(district_rev_collected),
            current_burden = sum(current_burden),
            no_exemptions_burden = sum(no_exemptions_burden),
            burden_change = sum(burden_change)) 

munis_3property_types

munis_3property_types %>% pivot_wider( id_cols = agency_name , names_from = "PropType", values_from = "current_burden") %>% arrange(-`Single-Family`)
```
Drop municipalities where most of the EAV is outside of Cook County:

CITY OF ELGIN	North	30340000
VILLAGE OF BARRINGTON	North	30030000
VILLAGE OF BARRINGTON HILLS	North	30040000
VILLAGE OF BARTLETT	North	30050000
VILLAGE OF BENSENVILLE	NA	30080000
VILLAGE OF BUFFALO GROVE	North	30150000
VILLAGE OF BURR RIDGE	South	30180000
VILLAGE OF DEERFIELD	NA	30280000
VILLAGE OF EAST DUNDEE	NA	30320000
VILLAGE OF FRANKFORT	NA	30440000
VILLAGE OF HANOVER PARK	North	30500000
VILLAGE OF HINSDALE	South	30560000
VILLAGE OF HOMER GLEN	NA	30585000
VILLAGE OF OAK BROOK	NA	30890000
VILLAGE OF PARK FOREST	South	31000000
VILLAGE OF ROSELLE	North	31120000
VILLAGE OF STEGER	South	31210000
VILLAGE OF TINLEY PARK	South	31270000
VILLAGE OF UNIVERSITY PARK	NA	31280000


```{r}
cross_county_lines <- c("30340000","30030000","30040000","30050000", "30080000","30150000","30180000",
  "30280000", "30320000","30440000","30500000", "30560000", "30585000", "30890000",
  "31000000","31120000","31210000","31270000","31280000")
```




Tax Burden if there were no exemptions:
```{r}

munis_3property_types %>% pivot_wider( id_cols = agency_name , names_from = "PropType", values_from = "no_exemptions_burden") %>% arrange(-`Single-Family`)
```

Change in Share of Burden if there were no exemptions:

```{r}
burden_shift %>% ungroup() %>% 
  group_by(agency_name, PropType) %>%
  summarize(district_rev_collected = sum(district_rev_collected),
            current_burden = sum(current_burden),
            no_exemptions_burden = sum(no_exemptions_burden)) 

munis_3property_types %>%
  pivot_wider( id_cols = agency_name , names_from = "PropType", values_from = "burden_change") %>% arrange(-`Single-Family`)
```

