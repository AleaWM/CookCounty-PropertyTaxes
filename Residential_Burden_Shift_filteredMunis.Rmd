---
title: "Mapping Property Tax Burden Shift due to Exemptions"
subtitle: "Cook County Municipalities (with >50% EAV within Cook County)"
author: "Alea Wilbur"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    df_print: paged
    code_folding: hide
---

# Getting Data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)


library(tidyverse)
library(DBI)
library(data.table)
library(ggspatial)
library(gstat)
library(here)
library(httr)
library(jsonlite)
library(ptaxsim)
library(sf)
library(stars)
library(glue)

# Create the DB connection with the default name expected by PTAXSIM functions
ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), "./ptaxsim.db/ptaxsim-2021.0.4.db")


options(digits=4, scipen = 999)

library(sf)
library(jsonlite)
library(httr)

# link to the API output as a JSON file
muni_shp <- read_sf("https://gis.cookcountyil.gov/traditional/rest/services/politicalBoundary/MapServer/2/query?outFields=*&where=1%3D1&f=geojson")

#muni_shp <- read_json("muni_shp.json")
nicknames <- readxl::read_excel("muni_shortnames.xlsx")



```

**Data Prep**

Pull all agency names that exist, then use agency numbers associated with MUNI types to pull only the `muni_agency_names` object.

There are 946 unique taxing agencies that existed in 2021.

```{r agency-dt}
# has EAV values, extensions by agency_num
agency_dt <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT *
  FROM agency
  WHERE year = 2021
  "
)

# grabs all unique muni names. Would be needed if creating a loop for calculating all munis
# municipality names and their agency number
muni_agency_names <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, minor_type
  FROM agency_info
  WHERE minor_type = 'MUNI'
  OR agency_num = '020060000'  

  "
)

muni_agency_names <- muni_agency_names %>% 
    mutate(first6 = str_sub(agency_num,1,6),
         first5 = str_sub(agency_num,1,5)) %>% 
  select(-minor_type)



#Makes a list of ALL taxing agencies, including TIFs, SSAs, etc.

# all agency names, numbers, and types
# includes TIF and non-TIF agencies
all_taxing_agencies <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  "
) %>%
  mutate(first6 = str_sub(agency_num,1,6),
         first5 = str_sub(agency_num,1,5))


muni_agency_nums<- all_taxing_agencies %>% 
  filter(minor_type %in% c("MUNI") | 
           agency_num == "020060000") %>%
   select(agency_num)

muni_tax_codes <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  glue_sql("
  SELECT*
  FROM tax_code
  WHERE agency_num IN ({muni_agency_names$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)# %>% select(-agency_rate)

# Agency number and agency name for all TIFs
TIF_agencies <- DBI::dbGetQuery(
  ptaxsim_db_conn,
  "SELECT DISTINCT agency_num, agency_name, major_type, minor_type
  FROM agency_info
  WHERE minor_type = 'TIF'
  "
)

unique_tif_taxcodes <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT DISTINCT tax_code_num
  FROM tax_code
  WHERE agency_num IN ({TIF_agencies$agency_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
)



## Read in summarized tax code level data for exemptions and taxbills.

taxbills_by_Class_per_TC <- read_csv("taxbills_inMunis_perTC.csv")  %>% 
  mutate(tax_code = as.character(tax_code)) 


# get rid of rpm variables, tax_amt_exe,pre and post exemption variables,
exemptions_by_class_per_TC <- read_csv("all_exemptions_by_TC.csv") %>%
    mutate(tax_code_num = as.character(tax_code_num))

tif_distrib <- DBI::dbGetQuery(
  ptaxsim_db_conn, 
  glue_sql("
  SELECT *
  FROM tif_distribution
  WHERE tax_code_num IN ({muni_tax_codes$tax_code_num*})
  AND year = 2021
  ",
  .con = ptaxsim_db_conn
  )
) %>% mutate(tax_code_num = as.character(tax_code_num))



all_taxing_agencies <- all_taxing_agencies %>% 
  left_join(muni_agency_names, by = c("first5", "first6")) %>% 
  rename(muni_name =  agency_name.y,
        muni_num = agency_num.y,
        agency_name = agency_name.x,
        agency_num = agency_num.x)






## Add agency names since those weren't included originally in the table:

# all_taxing_agencies <- all_taxing_agencies %>% 
#   left_join(muni_agency_names, by = c("first5", "first6")) %>% 
#   rename(muni_name =  agency_name.y,
#         muni_num = agency_num.y,
#         agency_name = agency_name.x,
#         agency_num = agency_num.x)
# 


# combine taxing agency names and agency type to data table that has eav and extension values
agency_data <- right_join(agency_dt, all_taxing_agencies) %>% 
  # get rid of unneeded columns to make table outputs smaller
  select(-c(cty_dupage_eav:cty_livingston_eav, lim_numerator, lim_denominator)) %>% # drop some of the unused variables
  arrange(agency_num)
```

This table is used for the municipality levy in later calculations.

`agency_dt` has all taxing agencies (but not TIFs) that existed each year and includes their total taxable base (cty_cook_eav), their levy, taxing rate, binary variables for if a municipality is home rule or not, as well as many other variables. Also currently doesn't have agency_names to go with the agency numbers. That will be merged in shortly.

There are 1,878 taxing agencies. When grouped by minor_type, there are 133 muni agencies, 639 tif agencies, 30 townships, etc.

> Everything depends on the tax codes.



Using the agency numbers for each municipality, I pull all tax codes that have an agency_num included in the muni_agency_names object. By narrowing the agencies down to just Municipality types, this prevents duplicate tax_codes from being pulled.

There are 3774 tax codes within Cook County that are taxed by Municipalities. There are 4228 unique tax codes in Cook County in 2021.

Drop municipalities where most of the EAV is outside of Cook County:



```{r}
cross_county_lines <- c("030440000",
"030585000", "030890000", "030320000", "031280000","030080000", "030560000", "031120000", "030280000", "030340000","030150000","030050000", "030180000","030500000","031210000"
)

# Frankfort, Homer Glenn, Oak Brook are below 1% in Cook County
# East Dundee, University Park, Bensenville, Hinsdale, Roeelle, Deerfield are below 15% in Cook County

# If below 50%, Elgin, buffalo grove, bertlette, burr ridge, hanover park, steger, barrington hills and barrington, and park forest are

# ALL border crossers:
#cross_county_lines <- c("030030000", "030040000", "030050000", "030080000","030150000","030180000", "030280000", "030320000","030340000", "030440000","030500000", "030560000", "030585000", "030890000",  "031000000","031120000","031210000","031270000", "031280000")


# Municipalities | Triad | agency_num 
# 
# CITY OF ELGIN North   30340000  
# VILLAGE OF BARRINGTON North   30030000  
# VILLAGE OF BARRINGTON HILLS   North   30040000  
# VILLAGE OF BARTLETT   North   30050000  
# VILLAGE OF BENSENVILLE    NA  30080000  
# VILLAGE OF BUFFALO GROVE  North   30150000  
# VILLAGE OF BURR RIDGE South   30180000  
# VILLAGE OF DEERFIELD  NA  30280000  
# VILLAGE OF EAST DUNDEE    NA  30320000  
# VILLAGE OF FRANKFORT  NA  30440000  
# VILLAGE OF HANOVER PARK   North   30500000  
# VILLAGE OF HINSDALE   South   30560000  
# VILLAGE OF HOMER GLEN NA  30585000  
# VILLAGE OF OAK BROOK  NA  30890000  
# VILLAGE OF PARK FOREST    South   31000000  
# VILLAGE OF ROSELLE    North   31120000  
# VILLAGE OF STEGER South   31210000  
# VILLAGE OF TINLEY PARK    South   31270000  
# VILLAGE OF UNIVERSITY PARK    NA  31280000  
```



# Muni Land Use

## EAV

using the pin data from ptaxsim, I calculate the eav of all properties, exempt EAV, the current taxbase, and taxbase if there were not exemptios

-   exempt EAV (summed from all exemption types)

-   current taxbase (using the `tif_distrib` table and percent of taxcode rev that goes to the tif). If a taxcode is a TIF taxcode, then do (EAV-exempt EAV) \* (1-%rev that goes to TIF). If the tax code is not a TIF tax code, then use the EAV-exempt EAV.

-   tax base without exemptions: If a taxcode is a TIF taxcode, then do EAV \* (1-%rev that goes to TIF). If the tax code is not a TIF tax code, then use the eav

> Joining problem: in `muni_agency_names`, Cicero is called "TOWN CICERO", in map shapefile it is called "CITY OF CICERO".

```{r}
class_dict <- read_csv("class_dict.csv")

# use exemptions in tax codes to summarize EAV. 
# More accurate that calculating it from revenue collected.tax rate in tax bill data
exemptions_by_class_per_TC <- read_csv("all_exemptions_by_TC.csv") %>% 
  mutate(tax_code_num = as.character(tax_code_num),) %>%
  left_join(muni_tax_codes) %>%
  full_join(muni_agency_names) %>%
  left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
  filter(!agency_num %in% cross_county_lines) %>%
  
  # merge with TIF distrib table to calculate the percent of the EAV that goes to the TIF vs the district
  left_join(tif_distrib, by=c("tax_code_num", "year", "tax_code_rate")) %>%
  mutate(exempt_EAV = (exe_homeowner + exe_senior + exe_freeze + exe_longtime_homeowner + 
         exe_disabled + exe_vet_returning + exe_vet_dis + exe_abate) ,
         in_TIF = ifelse(tax_code_num %in% unique_tif_taxcodes$tax_code_num, 1, 0),
         tax_base_current = ifelse(in_TIF==1, (eav-exempt_EAV)*(1-tax_code_distribution_pct/100), eav-exempt_EAV),
         tax_base_noexemps = ifelse(in_TIF==1, (eav)*(1-tax_code_distribution_pct/100), eav),
         ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Commercial"),
         
         PropType = case_when(
           major_class_code %in% c("3","9") ~ "Multi-Family",
           major_class_code == "2" ~ "Single-Family",
           TRUE~ "Commercial-Industrial"))
```

### Residential (Class 2, 3, & 9)


```{r}
grouped_exemptions <- exemptions_by_class_per_TC %>% 
   # group_by(agency_name, major_class_code, major_class_type, ResidentialProps, PropType) %>%
  group_by(clean_name, ResidentialProps, agency_name, agency_num.x) %>%
  summarize(eav = sum(eav),
           exempt_EAV = sum(exempt_EAV, exe_abate, na.rm=TRUE),
         tax_base_current = sum(tax_base_current, na.rm=TRUE),
         tax_base_noexemps = sum(tax_base_noexemps, na.rm=TRUE)) %>% ungroup() %>% select(clean_name, eav, exempt_EAV, everything())
  
grouped_exemptions 

# calculate totals with ONLY EAV outside of TIFs
muni_eav <- grouped_exemptions %>%  
  group_by(clean_name, agency_name, agency_num.x) %>% 
  summarize(muni_EAV_includesTIF = sum(eav), # all EAV in the municipality that exists
            muni_tax_base_current=sum(tax_base_current), # taxable EAV based on current exemptions
            muni_tax_base_noexemps = sum(tax_base_noexemps)) %>%  # taxable EAV pre-exemptions
  ungroup() 

perc_residential <- full_join(grouped_exemptions, muni_eav) %>% 
  filter(ResidentialProps == "Residential") %>% 
  mutate(percent_residential = eav / muni_EAV_includesTIF)# %>% select()

perc_residential

# nicknames  %>% filter(!clean_name %in% perc_residential$clean_name)
# 
# nicknames  %>% filter(!shpfile_name %in% muni_shp$MUNICIPALITY)
# muni_shp  %>% filter(!MUNICIPALITY %in% nicknames$shpfile_name)
# nicknames  %>% filter(!agency_name %in% muni_shp$AGENCY_DESC)

#muni_shp %>% left_join(muni_agency_names, by = c("AGENCY_DESC" = "agency_name"))
summary(perc_residential)
```

> in this stage, Bensenville, East Dundee, and Homer Glen were dropped. This is fine because I was going to drop them later anyways. They don't have residential EAV within Cook County.

Percent Residential is the Residential EAV outside of TIFs / Municipality EAV outside of TIFs.

The median amount of EAV from residentical parcels is `r scales::percent(median(perc_residential$percent_residential))`. 

```{r}
variable <- perc_residential$percent_residential

breaks_sd = c(
  (median(variable)-2.5*sd(variable)),
  (median(variable)-1.5*sd(variable)),
  median(variable)-.5*sd(variable),
  median(variable),
  median(variable)+.5*sd(variable),
  median(variable)+1.5*sd(variable),
  median(variable)+2.5*sd(variable))



# class 2, 3, 9 combined
perc_residential %>% 
  group_by(ResidentialProps)%>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = percent_residential)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  labs(title = "Residential EAV /  Total EAV", caption = "The median municipality has 70.4% of its EAV from Residential Class 2, 3, & 9 Properties") +
    theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+# +#+
    scale_fill_steps2(
      high = "#008080", low = "#420420",
  #  guide = "legend",
      midpoint = median(perc_residential$percent_residential),
                      breaks = breaks_sd,
  #                      n.breaks = 6,
  show.limits=TRUE,
                        name = "% Residential",
  labels = scales::percent)
```

```{r}

exemptions_to_resEAV_ratios <- grouped_exemptions %>% 
  filter(ResidentialProps == "Residential") %>% 
  mutate(exemptEAV_pctof_resEAV = exempt_EAV/eav,
         nontif_ratio = exempt_EAV / tax_base_noexemps) %>% 
  select(agency_name, clean_name, exemptEAV_pctof_resEAV, nontif_ratio) %>% 
  arrange(nontif_ratio)

exemptions_to_resEAV_ratios %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
 left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = exemptEAV_pctof_resEAV)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Exemptions / Residential EAV (in and out of TIFs)") +
    theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "maroon", low = "black", 
                      # limits = c(0,.8),
                       n.breaks = 7, show.limits=TRUE,
                    nice.breaks = FALSE,
                    midpoint = median(exemptions_to_resEAV_ratios$exemptEAV_pctof_resEAV),
                        name = "% Residential EAV \nthat is exempt", label = scales::percent) + labs(caption = "Median value is 19.5%. 
                                                                                                     Nearly 20% of Residential EAV is tax exempt in the median municipality. ")


summary(exemptions_to_resEAV_ratios$exemptEAV_pctof_resEAV)

exemptions_to_resEAV_ratios %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = nontif_ratio)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Non-TIF EAV only: Homestead Exemptions / Residential EAV", caption = "Village of Phoenix skews graph. Dropped in map below") +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "maroon", low = "black",
     #colors = c("white", "darkblue"), 
                       limits = c(0,.8),
                    midpoint = median(exemptions_to_resEAV_ratios$nontif_ratio),
                       n.breaks = 7, show.limits=TRUE,
                        name = "% Residential EAV \nthat is exempt", label = scales::percent) + labs( caption = "Median value is 19.77% ")

exemptions_to_resEAV_ratios %>% 
  filter(nontif_ratio<.5) %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = nontif_ratio)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Percent of Residential EAV that is Tax Exempt", 
  subtitle = "% of Non-TIF Residential EAV only: \nHomestead Exemptions / Residential EAV", 
  caption = "Residential includes Class 2, 3, and 9.
  Drops Village of Phoenix because it skews map colors (78% of their residential EAV is tax exempt). 
  Median municipality can not get tax revenue from 19.77% of their residential EAV due to exemptions.") +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "maroon", low = "black",
   #  colors = c("white", "darkblue"), 
                      # limits = c(0,.4),
   midpoint = median(exemptions_to_resEAV_ratios$nontif_ratio),
                     #  n.breaks = 7, 
   show.limits=TRUE,
                        name = "% Residential EAV \nthat is exempt", label = scales::percent)
```

```{r}
exemptions_to_resEAV_ratios %>% arrange(desc(nontif_ratio))
```



```{r include = FALSE}
library(cmapplot)
# #lowest % of eav from residential property types
# perc_residential %>% select(-ResidentialProps) %>%
#   arrange(percent_residential) %>% head()
# 
# #highest % of eav from residential property types
# perc_residential %>%  select(-ResidentialProps) %>%
#   arrange(percent_residential) %>% tail()

#breaks = c(0, .1, .3, .5, .7, .9, 1)
#breaks_5 = c(0, .188, 0.5555,  0.7042,  0.6682,  0.8036, 0.9720 )
# variable = perc_residential$percent_residential
# sd(perc_residential$percent_residential) # 1sd = .203. 
# 

#   )
# #  (median(variable)+2.5*sd(variable)))
# 
# breaks_sd2 = c(0,
#   (median(variable)-2*sd(variable)),
#   (median(variable)-1*sd(variable)), 
#   median(variable), 
#   median(variable)+1*sd(variable),
#   (median(variable)+2*sd(variable)),1)
# 
# labels = c("No Residential EAV", "More than 20 pct below the median", "Within 20 pct pts of the median", "More than 20 pct pts above the median", "Only Residential EAV")
# 
# labels2 = c("0-10%", "10-30%", "30-50%", "50-70%", "70-90%")
```


```{r include = FALSE}
# perc_residential %>% 
#   group_by(ResidentialProps)%>%
#     mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
#   left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
#   ggplot(aes(fill = percent_residential)) + 
#   geom_sf(aes(geometry = geometry), color = "black") + theme_cmap()+ 
#   labs(title = "Version 1: Residential EAV /  Total EAV", caption = "Median municipality has 70% of its EAV from Residential Class 2, 3, & 9 Properties.
#        Class 2, 3, and 9 are made up of all parcels with class assignments that begin with a 2, 3, or 9.") +
#   theme(axis.ticks = element_blank(), axis.text = element_blank()) +
#   cmap_fill_continuous("teal_orange", 
#                        middle = .7042, 
#                       guide = "legend",
#   #n = 7,
#    breaks = breaks_sd,
#   #labels = labels,
# # labels = c("0-20%", "20-40%", "40-60%","60-80%", "80%+"),
#    name = "% Residential")


# library(classInt)
# breaks_qt <- classIntervals(c(min(perc_residential$percent_residential) - .00001, perc_residential$percent_residential), n =5, style = "quantile")
# breaks_qt
# 
# perc_residential <- mutate(perc_residential, percent_residential_cat = cut(percent_residential, breaks = breaks_qt$brks, include.lowest=TRUE, ordered=TRUE))
# 
# #table(perc_residential$percent_residential_cat)
# 
# breaks = c(0, .1, .3, .5, .7, .9, 1)
#
```




### Residential (Only Class 2 - Single-family)

```{r}

exemptions_by_class_per_TC %>%     
  filter(major_class_code == 2) %>%
  summarize(eav = sum(eav,na.rm=TRUE))

# Class 2 only
class2_perc <- exemptions_by_class_per_TC %>% 
    filter(major_class_code == 2) %>%
  group_by(clean_name, major_class_code, agency_name, agency_num.x) %>%
  summarize(eav = sum(eav),
           exempt_EAV = sum(exempt_EAV, exe_abate, na.rm=TRUE),
         tax_base_current = sum(tax_base_current, na.rm=TRUE),
         tax_base_noexemps = sum(tax_base_noexemps, na.rm=TRUE)) %>% 
  left_join(muni_eav) %>%
  mutate(perc_class2_totalEAV = eav / muni_EAV_includesTIF) %>%    
  mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) )

class2_perc %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = perc_class2_totalEAV)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  labs(title = "Single-Family Property EAV /  Total EAV in Municipality", 
  caption = "The median municipality has 66.84% of its EAV from Residential Class 2 Properties for Single-Family homes.
       Total EAV includes frozen EAV & TIF increments, and all exempt EAV.") +
  theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+# +#+
  scale_fill_steps2(
    high = "darkblue", low = "black",
    midpoint = median(class2_perc$perc_class2_totalEAV),
  #  breaks = breaks_sd,  # tried to do breaks based on standard deviation but map does that in an easier way by setting the midpoint. 
    nice.breaks = FALSE,
    show.limits=TRUE,
    name = "% Residential",
    labels = scales::percent)
```


```{r eval = FALSE, include = FALSE}
############
median(perc_residential$percent_residential)

#breaks  = c("median(x)-3sd(x)", "median(x)-2sd(x)", median(x)-1sd(x), median(x), median(x)+sd(x), median(x)+2*sd(x), median(x)+3*sd(x))
 
breaks = c(0, .1, .3, .5, .7, .9, 1)

labels = c("No residential EAV", "More than 40% below the median","More than 20% less than the median", "Within 20% of the median",  "More than 20% greater than the median", "All Residiential EAV")

perc_residential <- perc_residential %>% mutate(pct_res_cat = cut(percent_residential, breaks = breaks, labels = labels))

table(perc_residential$pct_res_cat)
caption = "The median municipality has 70% of its EAV from Residientail parcels."

breaks_qt <- classIntervals(c(min(perc_residential$percent_residential) - .00001, perc_residential$percent_residential), n =6, style = "quantile")
breaks_qt
stdev <- sd(perc_residential$percent_residential) #0.2033 is standard deviation

perc_residential <- mutate(perc_residential, percent_residential_cat = cut(percent_residential, breaks = breaks_qt$brks, include.lowest=TRUE, ordered=TRUE))

limits = c(0, 1)

table(perc_residential$percent_residential_cat)
#colors = c("#420420", "beige",  "#008080")

perc_residential %>% 
  group_by(ResidentialProps)%>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = percent_residential)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  labs(title = "Version 3: Residential EAV /  Total EAV", caption = "Median municipality has 70% of its EAV from Residential Class 2, 3, & 9 Properties") +
    theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+# +#+
    scale_fill_gradient2(
        high = "#00e304" , mid = "#FFF5EE", low = "#00cfd4",
   #   low = "maroon", mid = "#FFF5EE", high = "#008080",
                         guide = "legend",
                       #  breaks = breaks_sd2,
      breaks = 7,
     # labels = labels,
                   midpoint = median(perc_residential$percent_residential),
                        # show.limits=TRUE,
                        name = "% Residential")#, label = scales::percent)



```


Percent of Class 2 EAV that is tax exempt: 
Exempt EAV / Residential EAV 


```{r}

exemptions_to_class2EAV_ratios <- class2_perc %>% 
  mutate(exemptEAV_pctof_resEAV = exempt_EAV/eav,
         nontif_ratio = exempt_EAV / tax_base_noexemps) %>% 
  select(agency_name, clean_name, exemptEAV_pctof_resEAV, nontif_ratio) %>% 
  arrange(nontif_ratio)

exemptions_to_class2EAV_ratios %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
 left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = exemptEAV_pctof_resEAV)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Exemptions / Residential EAV (in and out of TIFs)") +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "darkblue", low = "black", 
                      # limits = c(0,.8),
                       n.breaks = 7, show.limits=TRUE,
                    nice.breaks = FALSE,
                    midpoint = median(exemptions_to_class2EAV_ratios$exemptEAV_pctof_resEAV),
                        name = "% Residential EAV \nthat is exempt", label = scales::percent) + 
  labs(caption = "Median value for single-family EAV is 20.76%.")


summary(exemptions_to_class2EAV_ratios$exemptEAV_pctof_resEAV)

exemptions_to_class2EAV_ratios %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = nontif_ratio)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Non-TIF EAV only: Homestead Exemptions / Residential EAV", caption = "Village of Phoenix skews graph. Dropped in map below") +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "darkblue", low = "black",
     #colors = c("white", "darkblue"), 
                      # limits = c(0),
                    midpoint = median(exemptions_to_class2EAV_ratios$nontif_ratio),
                       n.breaks = 7, 
     show.limits=TRUE,
                        name = "% Residential EAV \nthat is exempt", label = scales::percent) + 
  labs( caption = "Median value is 20.85% ")

exemptions_to_class2EAV_ratios %>%  filter(nontif_ratio<.6) %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = nontif_ratio)) + 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Percent of Residential EAV that is Tax Exempt", 
  subtitle = "% of Non-TIF Residential EAV only: \nHomestead Exemptions / Residential EAV", 
  caption = "Drops Village of Phoenix because it skews map colors (78% of their 
  residential EAV is tax exempt). Median municipality can not get tax revenue from 1/5th 
  of their residential EAV due to exemptions. 20.85% of Single-family home EAV is 
  not taxed and transfered to other tax payers.") +
    theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(high = "darkblue", low = "black",
   #  colors = c("white", "darkblue"), 
                       limits = c(0,.4),
   midpoint = median(exemptions_to_class2EAV_ratios$nontif_ratio),
                       n.breaks = 7, show.limits=TRUE,
                        name = "% Residential EAV \nthat is tax exempt", label = scales::percent)
```


## District Shares

Tax base in the tables above are the total EAV outside of TIF areas.

```{r}
TC_bills_current <- read_csv("TC_bills_current.csv") %>% 
  mutate(tax_code = as.character(tax_code))

class_dict$class_code <- as.character(class_dict$class_code)
 

taxcodes_current <- full_join(TC_bills_current, muni_tax_codes, 
                      by = c("tax_code" = "tax_code_num")) 

Current_Taxrates <- taxcodes_current %>% 
  left_join(muni_agency_names) %>%
  left_join(nicknames, by = c("agency_name" = "agency_name")) %>%
  filter(!agency_num %in% cross_county_lines) %>%
  group_by(clean_name, agency_name) %>% 
  summarize(MuniLevy = sum(final_tax_to_dist, na.rm = TRUE), # amount billed by munis with current exemptions in place
            nonTIF_EAV_post_exemps = sum(final_tax_to_dist/(tax_code_rate/100), na.rm = TRUE),
            TIF_increment_EAV = sum(final_tax_to_tif/(tax_code_rate/100), na.rm=TRUE),  
            Exempt_EAV = sum(tax_amt_exe/(tax_code_rate/100), na.rm=TRUE), 
            Total_EAV = sum((tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100), na.rm = TRUE)) %>%

  mutate(tax_rate_current = MuniLevy/nonTIF_EAV_post_exemps,
         nonTIF_EAV_pre_exemps = nonTIF_EAV_post_exemps + Exempt_EAV,
         taxrate_new = MuniLevy/nonTIF_EAV_pre_exemps,
         taxrate_change = tax_rate_current-taxrate_new) %>% 
  select(clean_name, taxrate_change, tax_rate_current, taxrate_new, everything()) %>% 
  arrange(desc(tax_rate_current))

land_use <- taxcodes_current %>% 
  left_join(muni_agency_names) %>% 
  left_join(Current_Taxrates) %>%
  mutate(ResidentialProps = ifelse(major_class_code %in% c("2", "3", "9"), "Residential", "Commercial"),
         PropType = case_when(
           major_class_code %in% c("3","9") ~ "Multi-Family",
           major_class_code == "2" ~ "Single-Family",
           TRUE ~ "Commercial-Industrial")) %>%
  group_by(clean_name,  ResidentialProps, agency_num, tax_rate_current, taxrate_new, taxrate_change, agency_name,) %>% 
  
  # All of the values calculated below are AFTER exemptions have been removed
  summarize(taxrev_from_proptype = sum(final_tax_to_dist, na.rm = TRUE),
            nonTIF_EAV = sum(final_tax_to_dist/(tax_code_rate/100), na.rm = TRUE),
            TIF_increment_EAV = sum(final_tax_to_tif/(tax_code_rate/100), na.rm=TRUE),
            Exempt_EAV = sum(tax_amt_exe/(tax_code_rate/100), na.rm=TRUE),
            Total_EAV = sum((tax_amt_exe+final_tax_to_dist+final_tax_to_tif)/(tax_code_rate/100), na.rm = TRUE) ) %>% ungroup()

Current_Taxrates
```

Current composite tax rates for each municipality are above. Table also includes the new tax rate if there were no exemptions, the levy (aka amount collected by the municipality from final_tax_to_dist variable), EAV outside of TIFs, amount of exempt EAV, and additional variables.

Below: Take EAV values within each property type, joine it with muni level EAV values, and calculate ...

```{r}

grouped_exemptions <- exemptions_by_class_per_TC %>% 
   # group_by(agency_name, major_class_code, major_class_type, ResidentialProps, PropType) %>%
  group_by(clean_name, major_class_type, ResidentialProps, PropType, major_class_code, agency_name) %>%
  summarize(eav = sum(eav),
           exempt_EAV = sum(exempt_EAV, exe_abate, na.rm=TRUE),
         tax_base_current = sum(tax_base_current, na.rm=TRUE),
         tax_base_noexemps = sum(tax_base_noexemps, na.rm=TRUE)) %>% ungroup()
  

# calculate totals with ONLY EAV outside of TIFs
muni_eav <- grouped_exemptions %>%  
  group_by(clean_name, agency_name) %>% 
  summarize(muni_EAV_includesTIF = sum(eav), # all EAV in the municipality that exists
            muni_tax_base_current=sum(tax_base_current), # taxable EAV based on current exemptions
            muni_tax_base_noexemps = sum(tax_base_noexemps)) %>%  # taxable EAV pre-exemptions
  ungroup() 

pct_property_types <- left_join(grouped_exemptions, muni_eav) %>% 
  #filter(ResidentialProps == "Residential") %>% 
  mutate(pct_PropType = eav / muni_EAV_includesTIF)# %>% select()

pct_property_types


burden_table <- pct_property_types %>% 
  left_join(Current_Taxrates, by = c("agency_name", "clean_name")) %>%
  mutate(rev_collected_current = tax_base_current * tax_rate_current,
         rev_collected_new = tax_base_noexemps*taxrate_new,
         burden_current = rev_collected_current/MuniLevy,
         burden_noexemps = rev_collected_new/MuniLevy, 
         burden_change = burden_noexemps- burden_current,
         burden_noexemps = ifelse(burden_noexemps >1, 1, burden_noexemps)) %>%
  mutate(burden_current = ifelse(is.na(burden_current), 0, burden_current),
         burden_noexemps = ifelse(is.na(burden_noexemps), 0, burden_noexemps)) %>%
  mutate(burden_noexemps = ifelse(burden_noexemps>1, 1, burden_noexemps),
         burden_current = ifelse(burden_current>1, 1, burden_current)) %>%
  filter(!is.na(major_class_code))%>%
  mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) )


burden_shift <- burden_table # only to not change code below in graphs. 
```

Compare to 6 municipalities calculated by JD:

Only class 2 property types in output below. Looks good! Yay.

```{r}
burden_table %>%  filter(agency_name %in% c("CITY OF CHICAGO", "VILLAGE OF BRIDGEVIEW", "VILLAGE OF DOLTON", "VILLAGE OF HOFFMAN ESTATES","VILLAGE OF MIDLOTHIAN","VILLAGE OF OAK PARK", "CITY OF CICERO") & major_class_code == 2) %>% select(-c(ResidentialProps, major_class_type, PropType)) %>%
  select(clean_name, muni_EAV_includesTIF, MuniLevy, exempt_EAV,burden_current, burden_noexemps)
```

# Composite Tax Rate Change

The tax rate shown is the composite tax rate for the Municipality. The composite tax rate is the aggregate of the tax rate for each taxing agency X the EAV within the taxing jurisdiction. This was calculated at a tax code level first and then added together for all taxcodes taxed by a municipal taxing agency.

6 Highest and 6 lowest tax rates. View the extremes on both sides

```{r}

Current_Taxrates %>%  filter(tax_rate_current > 0.25 )
                           
Current_Taxrates %>%  filter( tax_rate_current < 0.08)

median(Current_Taxrates$tax_rate_current)

quantile(Current_Taxrates$tax_rate_current, 
     #    props = seq(0,1,.2), 
        # type = 7 
     )

sd(Current_Taxrates$tax_rate_current)

```

# Map of Tax Rate Change

Mostly ignore the map below. It is a tester formatting colors and legend.

```{r include = FALSE}

sd(Current_Taxrates$tax_rate_current) # 5.7%

burden_shift %>% 
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
    mutate(currentrate_quantile = ordered(case_when
         (#tax_rate_current  0.0673 ~ "",
           tax_rate_current < 0.1002 ~ "0-25%",
           tax_rate_current < 0.11 ~ "25-49%",
         tax_rate_current < 0.14 ~ "50%",
           tax_rate_current < 0.1500 ~ "51-75%",
           tax_rate_current <= 0.5 ~ "75-100%"))) %>%

  # mutate(currentrate_quantile = ordered(
  #   case_when
  #   (tax_rate_current < (median(tax_rate_current) + sd(tax_rate_current) ) & 
  #       tax_rate_current > (median(tax_rate_current) -  sd(tax_rate_current) ) ~ "Median +/- 1 St. Dev.",
  #     
  #     tax_rate_current > (median(tax_rate_current)+ sd(tax_rate_current) )  ~ "Above median ",
  #     tax_rate_current < (median(tax_rate_current)- sd(tax_rate_current) ) ~ "Below Median") ) )%>%
  
    # mutate(currentrate_quantile = ordered(
    # case_when
    # (     tax_rate_current > (median(tax_rate_current)+ 0.09 ) ~ 1, #"Rate = 9 pct pts above median",
    #   tax_rate_current < (median(tax_rate_current) + 0.03 ) & 
    #     tax_rate_current > (median(tax_rate_current) -  0.03 ) ~ 2, #"Rate = Median +/- 3 pct pts",
    #   
    #   (tax_rate_current > (median(tax_rate_current)+ 0.03 ) & (tax_rate_current < median(tax_rate_current)+0.06) )~ 3,#"Rate = Median + 3 pct pts ",
    #   tax_rate_current < (median(tax_rate_current)- 0.03 ) ~ 4,#"Rate = Median - 3 pct pts",
    #        tax_rate_current > (median(tax_rate_current)+ 0.06 ) ~ 5#"Rate = 6 pct pts above median"
    #   ) ) 
   # ) %>%
    filter(major_class_code == 2) %>% # all property types have same composite tax rate
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%

    ggplot(aes(fill =currentrate_quantile)) +
                # tax_rate_current)) + 
      theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
  # scale_fill_gradientn(colors = c("white", "maroon"), 
  scale_fill_discrete(#colors = c("white", "#76C3D6", "#1A5E7D"),
                   #   limits = c(0,.35),
     type = c("#ffffcc","#a1dab4" ,"#41b6c4","#2c7fb8", "#253494"),
                  #  show.limits=TRUE,
     n=6,
                     # n.breaks = 6,
                        name = "Tax Rate")+
                        #, label = scales::percent)+
  geom_sf(aes(geometry = geometry), color = "black") +  
  labs(title = "Ranking of Municipalitis' current composite tax rates" ,    
         caption = "The current median composite tax rate is 12.3%. 
       Legend indicates the ranking of Munis. (Bottom quarter, etc.)")
```

```{r include = FALSE}
quantile(Current_Taxrates$tax_rate_current)
#breaks = quantile(Current_Taxrates$tax_rate_current, )
colors = c("#420420","maroon", "beige", "#b0e0e6", "#008080")


variable = Current_Taxrates$tax_rate_current

breaks_sd = c(
  (median(variable)-2.5*sd(variable)),
  (median(variable)-1.5*sd(variable)), 
  median(variable)-.5*sd(variable), 
 #median(variable),
  median(variable)+.5*sd(variable), 
  median(variable)+1.5*sd(variable),
  median(variable)+2.5*sd(variable))


breaks_3 = c(0, 
  (median(variable)-3*sd(variable)),
  (median(variable)-2*sd(variable)), 
  median(variable)-sd(variable), 
  median(variable)+sd(variable), 
  median(variable)+2*sd(variable),
  median(variable)+3*sd(variable),
     1)
```


```{r}
Current_rate_image <- Current_Taxrates %>% 
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) 
    ) %>%
  #  filter(major_class_code == 2) %>% # all property types have same composite tax rate
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%

    ggplot(aes(fill = tax_rate_current)) +
    geom_sf(aes(geometry = geometry), color = "black") + 
      theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
scale_fill_steps2(#colors = colors,
    high = "#420420", low = "black",
   #high = "#00e304" , low = "#00cfd4",
     midpoint = 0.123, 
#breaks = breaks_sd,
#limits = c(0,.45),
guide = "legend",
                   show.limits=TRUE,
  nice.breaks=FALSE,
                    n =6,
                       name = "Tax Rate",
#labels= c("6-12.5%", "", "12.5-18.3%", "24%", "30%", "35%+")              
label = scales::percent
)+
 
  labs(title = "Current composite tax rates" ,    
         caption = "The current median composite tax rate is 12.3%. 
         Highest composite tax rate is in Park Forest (41.4%.)
       Lowest composite tax rate is in Chicago (6.7%).")

Current_rate_image

save.image("Current_rate_image.png")
```

```{r}
# median 
burden_shift %>% filter(major_class_code == 2) %>%
  summarize(median_currentburden = median(burden_current),
            median_new_burden = median(burden_noexemps),
            median_burdenchange = median(burden_change),
            median_currenttaxrate = median(tax_rate_current),
            median_taxratechange = median(taxrate_change),
            median_taxratenew = median(taxrate_new))
```

```{r}
variable =Current_Taxrates$tax_rate_current
breaks_sd = c(
  (median(variable)-2.5*sd(variable)),
  (median(variable)-1.5*sd(variable)), 
  median(variable)-.5*sd(variable), 
  median(variable)+.5*sd(variable), 
  median(variable)+1.5*sd(variable),
  (median(variable)+2.5*sd(variable))

  )

Current_Taxrates %>% 
      mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) 
    ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = taxrate_new)) + 
      theme_void() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
     scale_fill_steps2(# high = "#00e304" , low = "#00cfd4",
      high = "#420420", low = "#008080",#colors = c("white", "#76C3D6", "#1A5E7D"),
                      limits = c(0,.45),
                      midpoint = .1052,
                     #breaks = breaks_sd, 
                   #  na.value = NA,
                     nice.breaks=FALSE,
                      show.limits=TRUE,
     guide = "legend",
                   n=6,
                        name = "Tax Rate", label = scales::percent)+
  geom_sf(aes(geometry = geometry), color = "black") +  
  labs(title = "New composite tax rates if exemptions were eliminated" ,    
         caption = "The new median composite tax rate would be approximately 10.5% 
       if exemptions were removed.")
```

```{r}
median(Current_Taxrates$taxrate_change)

Current_Taxrates %>% 
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
 # filter(clean_name != "Park Forest") %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = taxrate_change)) + 
  geom_sf(aes(geometry = geometry), color = "black") +  
      theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
  
    scale_fill_steps2(
      
     #  high = "#00e304" , low = "#00cfd4",
       high = "#420420", low = "#008080"
       ,#colors = c("#ffffcc","#a1dab4" ,"#41b6c4","#2c7fb8", "#253494"),
 # low = "darkorange", high = "#253494",
#  space = "Lab", 
guide = "legend",
n=6,
midpoint = 0.01388, 
show.limits=TRUE,
nice.breaks=FALSE,
labels = scales::percent,
                        name = "Percentage Point Difference")+
  labs(title = "Change in Composite Tax Rate if Exemptions are Removed",
       caption = "The median change in composite tax rate is 1.38 percentage points")
```


```{r quantile-composite-taxrates, include = FALSE}


# Current_Taxrates %>% 
#     mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
#     # mutate(currentrate_quantile = case_when
#     #      (
#     #        tax_rate_current < 0.1002 ~ "Lowest 25%",
#     #        tax_rate_current < 0.1226 ~ "25-50%",
#     #        tax_rate_current == 0.1226 ~ "Median Rate",
#     #        tax_rate_current > 0.1500 ~ "50-75%",
#     #        tax_rate_current <= 0.4136 ~ "Highest 25%")) %>%
#   left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
#   ggplot(aes(fill = taxrate_change*100)) + 
#   geom_sf(aes(geometry = geometry), color = "black") +  
#       theme_classic() + 
#   theme(axis.ticks = element_blank(), axis.text = element_blank())+
#   
#     scale_fill_stepsn(colors = c("darkorange", "#ffffcc","#a1dab4" ,"#41b6c4","#2c7fb8", "#253494"),
#  # low = "#ffffcc", mid = "#41b6c4", high = "#253494",
# #  space = "Lab",
#                        n.breaks = 6, show.limits=TRUE,
#                         name = "Percentage Point Difference")+
#   labs(title = "Change in Composite Tax Rate if Exemptions are Removed")

    #    scale_fill_stepsn(colors = c("white", "#76C3D6", "#1A5E7D"),
                  #    limits = c(0,.35),

Current_Taxrates %>% 
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
 # filter(clean_name != "Park Forest") %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = taxrate_change*100)) + 
  geom_sf(aes(geometry = geometry), color = "black") +  
      theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
  
    scale_fill_stepsn(colors = c( "#41b6c4","#a1dab4","#ffffcc","#2c7fb8", "#253494"),
 # low = "#ffffcc", mid = "#41b6c4", high = "#253494",
#  space = "Lab",
                       n.breaks = 9, show.limits=TRUE,
                        name = "Percentage Point Difference")+
  labs(title = "Change in Composite Tax Rate if Exemptions are Removed")
```


```{r}
# as a dot graph ## 

order <- burden_shift %>%  
  as_tibble() %>% 
  summarize(agency_name = unique(agency_name), 
            clean_name = unique(clean_name), 
            tax_rate_current = unique(tax_rate_current), 
            taxrate_new = unique(taxrate_new)) %>% 
  arrange(tax_rate_current) %>%
  select(agency_name, clean_name, tax_rate_current)
median(order$tax_rate_current)
head(order)
tail(order)


# look at ones that changed the most
burden_shift %>% 
  filter(tax_rate_current < (median(tax_rate_current))+0.002 & tax_rate_current > (median(tax_rate_current))-0.002 |
   (tax_rate_current > 0.25 | tax_rate_current < 0.08 )) %>%
  #          (tax_rate_current < (median(tax_rate_current))+0.005 & tax_rate_current > (median(tax_rate_current))-0.005 )) %>% 
  filter(PropType == "Single-Family") %>%
  ungroup() %>% 
  select(clean_name, tax_rate_current, taxrate_new, agency_name) %>% 
  pivot_longer(c("tax_rate_current", "taxrate_new"), 
               names_to = "type", values_to = "tax_rate") %>% 
  left_join(order) %>%
  ggplot(aes(x = tax_rate*100, y= reorder(clean_name, tax_rate_current)))+
  geom_line(aes(group = clean_name))+ 
   geom_point(aes(color=type), size=3 )+
  theme_minimal() + 
  theme( 
    legend.title = element_blank(),
               plot.title.position = "plot",
     #   panel.background = element_rect(fill='transparent'), #transparent panel bg
    plot.background = element_rect(fill='transparent', color=NA) #transparent plot bg
   )+
        scale_color_brewer(palette="Paired", labels = c("Exemptions", "No Exemptions"), direction = 1)+

  labs(title = "Difference in Composite Tax Rate if there were No Exemptions",
       subtitle = "Ordered by Current Composite Tax Rate", x = "Composite Tax Rate (%)", y = "" , caption = "For the highest, median, and lowest municipality composite tax rates ")
```

```{r}
# ordered by change in tax rate if exemptions were removed.
# as a dot graph ## 

order <- burden_shift %>% 
  as_tibble() %>%
  group_by(agency_name, clean_name) %>%
    summarize(tax_rate_current = mean(tax_rate_current), 
            taxrate_new = mean(taxrate_new),
            taxrate_change = mean(taxrate_change)) %>%
  arrange(taxrate_change)
median(order$taxrate_change) # median rate change is 1.4 percentage points
head(order)

# this one probably not the best Delete code soon.
# look at ones that changed the most
# burden_shift %>%  
#   filter(tax_rate_current < (median(tax_rate_current))+0.002 & tax_rate_current > (median(tax_rate_current))-0.002 |
#    (tax_rate_current > 0.25 | tax_rate_current < 0.08 )) %>% 
#   filter(PropType == "Single-Family") %>%
#   ungroup() %>% 
#   select(clean_name, tax_rate_current, taxrate_new, agency_name) %>% 
#   pivot_longer(c("tax_rate_current", "taxrate_new"), 
#                names_to = "type", values_to = "tax_rate") %>% 
#   left_join(order) %>%
#   ggplot(aes(x = tax_rate*100, y= reorder(clean_name, taxrate_change)))+
#   geom_line(aes(group = clean_name))+ 
#    geom_point(aes(color=type), size=3 )+
#   theme_minimal() + 
#   theme( 
#     legend.title = element_blank(),
#                plot.title.position = "plot",
#      #   panel.background = element_rect(fill='transparent'), #transparent panel bg
#     plot.background = element_rect(fill='transparent', color=NA) #transparent plot bg
#    )+
#         scale_color_brewer(palette="Paired", labels = c("Exemptions", "No Exemptions"), direction = 1)+
# 
#   labs(title = "Difference in Composite Tax Rate if there were No Exemptions", subtitle = "Ordered by Change in Tax Rate: Top and Bottom Observations",
#        x = "Composite Tax Rate (%)", y = "" , caption = "For the highest and lowest composite tax rates")

burden_shift %>%  
  filter(taxrate_change < 0.002 |taxrate_change > 0.055  |
           taxrate_change < (median(taxrate_change))+0.00059 & taxrate_change > (median(taxrate_change))-0.00059
         ) %>% 
  filter(PropType == "Single-Family") %>%
  ungroup() %>% 
  select(clean_name, tax_rate_current, taxrate_new, agency_name) %>% 
  pivot_longer(c("tax_rate_current", "taxrate_new"), 
               names_to = "type", values_to = "tax_rate") %>% 
  left_join(order) %>%
  ggplot(aes(x = tax_rate*100, y= reorder(clean_name, taxrate_change)))+
  geom_line(aes(group = clean_name))+ 
   geom_point(aes(color=type), size=3 )+
  geom_vline(xintercept = 8)+
    geom_vline(xintercept = 25)+

  theme_minimal() + 
  theme( 
    legend.title = element_blank(),
               plot.title.position = "plot",
     #   panel.background = element_rect(fill='transparent'), #transparent panel bg
    plot.background = element_rect(fill='transparent', color=NA) #transparent plot bg
   )+
        scale_color_brewer(palette="Paired", labels = c("Exemptions", "No Exemptions"), direction = 1)+

  labs(title = "Difference in Composite Tax Rate if there were No Exemptions", subtitle = "Ordered by Change in Tax Rate: Highest, Median, and Smallest Differences",
       x = "Composite Tax Rate (%)", y = "" )
```

# Single-Family (Class 2) Burden Shift

Change in Tax Burden for Class 2 Properties:

```{r}
burden_shift %>%
      mutate(burden_current = ifelse(burden_current>1, 1, burden_current)) %>%

      filter(major_class_code == 2) %>%
  mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%

  ggplot(aes(fill = burden_current)) + 
  geom_sf(aes(geometry = geometry), color = "black") + 
  theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(
   # high = "#00e304" , low = "#00cfd4",
     high = "#420420", low = "#008080",
   #  high = "#00a8ff" , low = "#ff4800",
     nice.breaks=FALSE,
                        show.limits=TRUE, 
   n.breaks = 6,
                     midpoint = 0.65,
   guide = "legend",
                        name = "Current Burden \n(with Exemptions)", labels = scales::percent
                    )+
  labs(title = "Current share of property tax burden", 
       subtitle = "for Class = 2 Property Types", 
       caption = "The median municipality gets 65% of its property tax revenue from Single-Family properties.")
```


```{r}
burden_shift %>% 
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
      filter(major_class_code == 2) %>%

  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%

  ggplot(aes(fill = burden_noexemps)) + 
  geom_sf(aes(geometry = geometry), color = "black") +     
  theme_classic( ) + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+

     scale_fill_steps2(
      #  high = "#00e304" , low = "#00cfd4",
     # colors = c("#ffffcc","#a1dab4" ,"#41b6c4","#2c7fb8", "#253494"),
      high = "#420420", low = "#008080",
  #   high = "#253494" , low = "#3b3c36" ,
     nice.breaks=FALSE,
                        #show.limits=TRUE, 
  guide = "legend",
   n.breaks = 6,
                     midpoint = 0.69,
                        name = "Burden without \nExemptions", labels = scales::percent) +
 labs(title = "New share of property tax burden", subtitle = "for Class = 2 Property Types", caption =
      "Without exemptions, municipalities would get a larger share of 
      their revenue from single-family properties.")
```

```{r burdenchange-map}
burden_shift %>% #filter(clean_name != "Phoenix") %>%
  filter(major_class_code == 2) %>%
    mutate(agency_name = ifelse(agency_name == "TOWN CICERO", "CITY OF CICERO", agency_name) ) %>%
  mutate(burden_change = ifelse(burden_change<0,0, burden_change))%>%
     #    burden_change = ifelse(burden_change>1,1, burden_change))%>%
  left_join(muni_shp, by = c("agency_name" = "AGENCY_DESC")) %>%
  ggplot(aes(fill = (burden_change*100)) )+ 
  geom_sf(aes(geometry = geometry), color = "black") + theme_void()+ 
  labs(title = "Change in Residential Share of Tax Burden", 
       caption = "The median shift from single-family properties to other property types
       due to current exemptions is worth approximately 4.5% of a municipality's levy.") +
    theme_classic() + 
  theme(axis.ticks = element_blank(), axis.text = element_blank())+
   scale_fill_steps2(
     # high = "#00e304" , low = "#00cfd4",
     high = "#420420", low = "#008080",
    # high = "darkblue" , low = "orange",
     nice.breaks=FALSE,
   guide="legend",
                        show.limits=TRUE,# n.breaks = 5,
                     midpoint = 4.6, # median(burden_shift$burden_change*100),
                        name = "Change in Burden \n Pct Points")

```

```{r collapse=TRUE}
# as a dot graph ## 

order <- burden_shift %>% 
  ungroup %>% as_tibble() %>%
  #  filter(ResidentialProps == "Residential") %>%

  filter(PropType == "Single-Family") %>%
  select(agency_name, clean_name, burden_current, burden_change)



# burder_shift_ordered <-  burden_shift %>% 
#   ungroup() %>% 
#   select(agency_name, current_burden, no_exemptions_burden) %>%    
#   pivot_longer(c("current_burden", "no_exemptions_burden"), 
#                names_to = "type", values_to = "pct_burden") %>% 
#   left_join(order)

# look at ones that changed the most

burden_shift %>% filter(PropType == "Single-Family")%>%
summarize(median_change = median(burden_change),
          median_current = median(burden_current),
          median_noexemps = median(burden_noexemps)) # 0.0442



burden_shift %>% 

  filter(PropType == "Single-Family") %>%

  filter(burden_current > 0.9 |burden_current < .3 |
          ( (burden_current < median(burden_current) + 0.01 )& (burden_current > median(burden_current) - 0.01)) )%>% 
  #filter(ResidentialProps == "Residential") %>%

  ungroup() %>% 
  select(agency_name, clean_name, burden_current, burden_noexemps,  burden_change) %>% 
  arrange(burden_change) %>%
  mutate( 
         burden_noexemps = ifelse(burden_noexemps > 1, 1, burden_noexemps)) %>%
  pivot_longer(c("burden_current", "burden_noexemps"), 
               names_to = "type", values_to = "pct_burden") %>% 
  inner_join(order) %>%
  ggplot(aes(x = pct_burden*100, 
             y= reorder(clean_name, burden_change)))+
            # y= reorder(clean_name, burden_current)))+
  geom_line(aes(group = clean_name))+ 
   geom_point(aes(color=type), size=3 )+
  theme_minimal() + 
  theme(#legend.position = "none", 
    legend.title = element_blank(),
               plot.title.position = "plot",
     #   panel.background = element_rect(fill='transparent'), #transparent panel bg
    plot.background = element_rect(fill='transparent', color=NA) #transparent plot bg
   )+
        scale_color_brewer(palette="Paired", labels = c("Current Burden", "Burden if \nNo Exemptions" ), direction = 1)+

  labs(title = "Change in Single-family Residential Tax Burden", 
       subtitle = "Ordered by Current Burden Levels",
  x = "Share of Levy (%)", y = "" , 
  caption = "Residential Tax Burden is the Share of the property tax collected that was paid for by 
     single-family home owners in property classes 2.") #+
# scale_x_continuous(label = scales::percent)
```

```{r collapse=TRUE}
### Change in Burden
burden_shift %>%    
  ungroup() %>% 
    filter(PropType == "Single-Family") %>%
   # filter(burden_change > 0.3 | burden_change < .01) %>% 

  select(agency_name, clean_name, burden_current, burden_noexemps,
         burden_change) %>% 
  mutate(
         burden_current = ifelse(burden_current > 1, 1, burden_current)) %>%
  pivot_longer(c("burden_current", "burden_noexemps"),
               names_to = "type", values_to = "pct_burden") %>%
  inner_join(order) %>%
  ggplot(aes(x = pct_burden, y= reorder(clean_name, burden_current)))+
  geom_line(aes(group = clean_name))+ 
   geom_point(aes(color=type), size=3 )+
  theme_minimal() + 
  theme(#legend.position = "none", 
    legend.title = element_blank(),
               plot.title.position = "plot",
     #   panel.background = element_rect(fill='transparent'), #transparent panel bg
    plot.background = element_rect(fill='transparent', color=NA) #transparent plot bg
   )+
        scale_color_brewer(palette="Paired", labels = c("Current Burden","Burden if \nNo Exemptions"), direction = 1)+

  labs(title = "Change in Single-family Residential Tax Burden", 
  x = "Share of Levy (%)", y = "" , 
  caption = "Residential Tax Burden is the Share of the property tax collected that was paid for by 
     single-family home owners in property classes 2.")



burden_shift %>%    
  ungroup() %>% 
    filter(PropType == "Single-Family") %>%
    filter(burden_noexemps > 0.2 | burden_noexemps < .001) %>% 

  select(agency_name, clean_name, burden_current, burden_noexemps,
         burden_change) %>% 
  mutate(
         burden_current = ifelse(burden_current > 1, 1, burden_current)) %>%
  pivot_longer(c("burden_current", "burden_noexemps"),
               names_to = "type", values_to = "pct_burden") %>%
  inner_join(order) %>%
  ggplot(aes(x = pct_burden, y= reorder(clean_name, burden_change)))+
  geom_line(aes(group = clean_name))+ 
   geom_point(aes(color=type), size=3 )+
  theme_minimal() + 
  theme(#legend.position = "none", 
    legend.title = element_blank(),
               plot.title.position = "plot",
     #   panel.background = element_rect(fill='transparent'), #transparent panel bg
    plot.background = element_rect(fill='transparent', color=NA) #transparent plot bg
   )+
        scale_color_brewer(palette="Paired", labels = c( "Current Burden","Burden if \nNo Exemptions"), direction = 1)+

  labs(title = "Change in Single-family Residential Tax Burden", 
  x = "Share of Levy (%)", y = "" , 
  caption = "Residential Tax Burden is the Share of the property tax collected that was paid for by 
     single-family home owners in property classes 2.")
```

# Summary table of Burden Shift: 3 Property Categories

Same data that is used above but property types are combined into 3 categories:

Single-family (Class 2),\
Multi-Family (Class 3 & 9),\
and Commercial-Industrial (all other Classes: 1,4, 5, 6, 7, 8, 9)

```{r}
# Current Burden:

munis_3property_types <- burden_shift %>%# mutate(
     #       burden_noexemps = ifelse(is.na(burden_noexemps), 0, burden_noexemps)) %>%
  #    mutate(burden_current = ifelse(burden_current>1, 1, burden_current)) %>%
  ungroup() %>% 
  group_by(agency_name, clean_name, PropType) %>%
  summarize(#final_tax_to_dist = sum(final_tax_to_dist, na.rm = TRUE),
            burden_current = sum(burden_current, na.rm = TRUE),
            burden_noexemps = sum(burden_noexemps, na.rm = TRUE),
            burden_change = sum(burden_change, na.rm = TRUE)) 

#write.csv(munis_3property_types, "1_usemetable.csv")

proptypes3_current <- munis_3property_types %>% 
    mutate(burden_current = ifelse(is.na(burden_current), 0, burden_current)) %>%

  pivot_wider( id_cols = clean_name , names_from = "PropType", values_from = "burden_current",names_prefix="Current - ", values_fill = 0 ) %>% 
  select(clean_name, `Current - Single-Family`, everything()) %>%
  arrange(-`Current - Single-Family`)

proptypes3_current[2:4] <- sapply(proptypes3_current[2:4], function(x) scales::percent(x, accuracy=.01) )
                                   
proptypes3_current
```

```{r}
# __Tax Burden if there were no exemptions:__

proptypes3_noexemps <- munis_3property_types %>% 
  mutate(burden_noexemps = ifelse(is.na(burden_noexemps), 0, burden_noexemps)) %>%
  pivot_wider( id_cols = clean_name , names_from = "PropType", values_from = "burden_noexemps", names_prefix = "W/O Exemptions - ", values_fill = 0)  
proptypes3_noexemps[2:4] <- sapply(proptypes3_noexemps[2:4], function(x) scales::percent(x, accuracy=.01))
proptypes3_noexemps
```

**Change in Share of Burden if there were no exemptions:**

```{r}
# burden_shift %>% ungroup() %>% 
#   group_by(agency_name, PropType) %>%
#   summarize(district_rev_collected = sum(district_rev_collected),
#             current_burden = sum(current_burden),
#             no_exemptions_burden = sum(no_exemptions_burden)) 

props_wide <- munis_3property_types %>%
  pivot_wider(id_cols = clean_name , 
               names_from = "PropType", 
               values_from = "burden_change", values_fill = 0) %>% select(clean_name, `Single-Family`, everything()) %>%
  arrange(desc(`Single-Family`) )

props_wide[2:4] <- sapply(props_wide[2:4], function(x) scales::percent(x, accuracy=.001))
props_wide


proptypes3_comparisontable<- left_join(proptypes3_current, proptypes3_noexemps, by = "clean_name")
proptypes3_comparisontable

```

```{r}
proptypes3_burdenchange <- munis_3property_types %>% 
  mutate(burden_noexemps = ifelse(is.na(burden_change), 0, burden_change)) %>%
  pivot_wider( id_cols = agency_name , names_from = "PropType", values_from = "burden_change", values_fill = 0) %>%
  arrange(desc(`Single-Family`))

proptypes3_burdenchange[2:4] <- sapply(proptypes3_burdenchange[2:4], function(x) scales::percent(x, accuracy=.01))
proptypes3_burdenchange

```

# Cook County "Cost" Values


__"Multiplies the EAV exempted for all Cook County municipalities by their consolidated tax rates in each municipality"__

> Do this by taxcode and actual tax code tax rate. Much more accurate.

```{r}
taxcodes_current %>% 
  summarize(forgone_rev = sum(tax_amt_exe, na.rm = TRUE),
            exempt_EAV = sum(tax_amt_exe/(tax_code_rate/100), na.rm = TRUE)
  )
```
- There is $15,770,910,176 of EAV that is exempt from property taxes.  

- \$1.5 Billion of potential revenue is transferred to other taxpayers due to current exemptions. 


__"Takes the median tax rate increase as a result of exemptions (1.4%) and multiplies that by the total residential EAV in Cook County"__

```{r}
taxcodes_current %>%
  filter(year == 2021) %>%
  group_by(major_class_type, major_class_code) %>%
  summarize(eav = sum(tax_amt_pre_exe/(tax_code_rate/100), na.rm=TRUE)) %>% arrange(desc(eav))

120944941944 * 0.01388 # 1693229187
```

- There is $120,944,941,944 of Residential EAV in Cook County.  

- $1,678,715,794 is Residential EAV * average increase in municipal taxrate. 
 
__"And then we should [show] how/why if levy is fixed, exemptions increase the tax rate and/or shift the tax burden."__

- .... Because of... math?   
- Once the amount of money that is needed is determined, then the tax rate is determined based off of that.   
  - Levy doesn't change, so if you are decreasing the amount of taxable EAV, then the tax rate must go up to collect the same amount of money.  
  - maybe draw a diagram for a municipality as an example on a slide   

__"We might also want to take a closer look at either our 6 case study municipalities or those municipalities most affected by exemptions (Park Forest, Phoenix, Calumet Park, Riverdale) to get some effects for the owner of the average or median value home."__

```{r}

```

Locations with the highest percent of their potentially taxable EAV (non-TIF increment EAV) that is tax-exempt: 

Phoenix	
Park Forest	
Markham	
Calumet Park	
Thornton	
Harvey	
Burnham	
Dolton

Almost exact same list of locations as largest tax rate change. 


# Exporting data to Excel file

```{r eval=FALSE}
library(openxlsx)

dataset_names <- list(
  'Land Use' = perc_residential,
  'Burden Table' = burden_table,
  # 'EAVoutsideTIFs' = EAV_outside_TIFS_byClass,
  
  'Composite Tax Rates' = Current_Taxrates,
  'MuniEAV' = muni_eav, #included as columns in Burden Table too
 #  'ResidentialEAV' = table_ResidentialEAV,  # doesn't exist?
  # 'Burden with Exemps' = burden_with_exemptions,
  # 'Burden without Exemps' = burden_noexemps,
  'Burden Shift-3PropTypes' = proptypes3_burdenchange,
  '3 Property Types'= munis_3property_types,
#  'TaxcodeData-NoExemptions'=taxcodes_noexemps,
  'TaxcodeData-Current' = taxcodes_current)

write.xlsx(dataset_names, file = 'data_for_slides_filteredMunis.xlsx')
```

