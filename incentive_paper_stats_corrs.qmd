---
title: "Incentive Classification Time-Series Dataset"
subtitle: "Assessing Data Collinearity and Relationships Over Time"
author: "Michael Van Hulle & Alea Wilbur-Mujtaba"
date: "July 5, 2024"
format: 
  html:
    embed-resources: true
    theme: lumen
    code-fold: true
    code-line-numbers: true
    code-overflow: wrap
    toc: true
    toc-location: left
    df-print: paged
knitr: 
  opts_chunk:
    warning: true
    message: false
---

```{r setup}
#| output: FALSE

# Load packages

library(tidyverse)
library(corrr)
library(glue)
library(DT)
library(flextable)
library(kableExtra)
library(crosstable)

# Set table formatting defaults

set_flextable_defaults(theme_fun = theme_vanilla, 
                       padding = 2,
                       #line_spacing = 1,
                       big.mark = ","
                       )

options(DT.options = list())

FitFlextableToPage <- function(ft, pgwidth = 6){
  ft_out <- ft %>% autofit()
  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

# Run helper file

source("./scripts/helper_pull_comm_ind_allyears.R")

# Remove distracting objects and values from R environment

helper_objects <- ls()

keep <- "comm_ind"

comm_ind <- comm_ind_pins_ever

rm(list = setdiff(helper_objects, keep))

rm(helper_objects, keep)

```

# Data "Quirks"

## Missing Values

We want to make sure that we aren't missing values for key variables and also want to know if the missing values change by year.
These factors are especially salient to determining our ability to assemble a panel data and used fixed effects as opposed to some other form of time-series analysis.

```{r}
#| label: tbl-missing_values_all_years
#| tbl-cap: "**Comparison of Select Missing Values Across Years**<br>ALL Commercial and Industrial PINs: 2006, 2012, 2022"
#| tbl-cap-location: top

missing_values_all_years <- comm_ind |>
  filter(year %in% c("2006", "2012", "2022")) |>
  rename(land_use = Alea_cat) |>
  group_by(year) |>
  summarize(
    "Observations (PIN-Year)" = n(),
    "Class Code" = sum(is.na(class)),
    "FMV" = sum(is.na(fmv)),
    "AV" = first(sum(is.na(av_clerk))), 
    "Land Use" = first(sum(is.na(land_use))), 
    "Incentive Dummy" = first(sum(is.na(incent_prop))), 
   # missing_rate = sum(is.na(tax_code_rate)),
    "Tax Code" = first(sum(is.na(tax_code_num)))
)

mvay_long <- missing_values_all_years |>
  pivot_longer(
    cols = -year,
    names_to = "variable",
    values_to = "count"
  )

mvay_wide = mvay_long |>
  pivot_wider(
    names_from = year,
    values_from = count
  )

kable(mvay_wide, format = "html", escape = FALSE) |>
  kable_styling(full_width = FALSE) |>
  column_spec(1, width = "3cm")

```
Zeroes were imputed for missing values at one point in our analysis, so we also check for excess zero values.

```{r}
#| label: tbl-zero_values_all_years
#| tbl-cap: "**Comparison of Zero Values Across Years**<br>ALL Industrial and Commercial PINs: 2006, 2012, 2022"
#| tbl-cap-location: top

all_year_zero_values <- comm_ind |>
  filter(year %in% c("2006", "2012", "2022")) |>
  group_by(year) |>
  mutate(year_obs = first(n())) |>
  ungroup() |>
  filter(class != 0) |>
  rename(land_use = Alea_cat) |>
  group_by(year) |>
summarize(
    "Observations (PIN-Year)" = first(year_obs),
    "Class Code" = sum(class == "0"),
    "FMV" = sum(fmv == "0"),
    "AV" = sum(av_clerk == "0"), 
    "Land Use" = sum(land_use == "0"), 
    "Incentive Dummy" = sum(incent_prop == "0"),
    "Tax Code" = sum(tax_code_num == "0")
)

ayz_long <- all_year_zero_values |>
  pivot_longer(
    cols = -year,
    names_to = "variable",
    values_to = "count"
  )

ayz_wide = mvay_long |>
  pivot_wider(
    names_from = year,
    values_from = count
  )

kable(ayz_wide, format = "html", escape = FALSE) |>
  kable_styling(full_width = FALSE) |>
  column_spec(1, width = "3cm")

```

## Serial autocorrelations

Depending on our statistical model, we may need to account for serial autocorrelation for some variables across time. This seems likely with AV given the triennial reassessment cycle and will help us determine the number of lags needed in our model.

# Correlations

## Correlations: 2006 - 2022 Time Period

Notes: 

These correlations are across the entire 2006-2022 time period and are not stratified by year.

```{r}
#| label: tbl-all_year_corrs
#| tbl-cap: "**Correlations of Main Variables**<br>ALL Industrial & Commercial PINs: 2006-2022"
#| tbl-cap-location: top

row_name_map <- c(
  av_clerk = "AV",
  fmv = "FMV",
  years_existed = "Incentive Age",
  base_year_fmv_2006 = "FMV (2006)",
  base_year_fmv_2011 = "FMV (2011)"
)

col_name_map <- c(
  term = "",
  av_clerk = "AV",
  fmv = "FMV",
  years_existed = "Incentive Age",
  base_year_fmv_2006 = "FMV (2006)",
  base_year_fmv_2011 = "FMV (2011)"
)

comm_ind$year <- as.factor(comm_ind$year)

corr_matrix <- comm_ind |>
  select(av_clerk, fmv, years_existed, base_year_fmv_2006, base_year_fmv_2011, incent_prop, year) |>
  correlate()

corr_df_temp_1 <- corr_matrix |>
  shave() |>
  fashion(decimals = 2) 

corr_df <- as.data.frame(corr_df_temp_1)

new_col_names <- c("Variable", col_name_map[colnames(corr_df)[-1]])

kable(corr_df, format = "html", escape = FALSE, col.names = new_col_names) |>
  kable_styling(full_width = FALSE) |>
  column_spec(1, width = "3cm")

```

```{r}
#| label: tbl-2006_2012_2022_corrs
#| tbl-cap: "**Correlations of Main Variables**<br>ALL Industrial & Commercial PINs: 2006, 2012, 2022"
#| tbl-cap-location: top



```
