---
title: "Data Request: Incentives & Vacant Property"
author: "MVH& AWM"
format: html
---
```{r}
library(tidyverse)
ptax_pins <- read_csv("./Output/comm_ind_PINs_2006to2022_timeseries.csv") %>% 
  #filter(year >= 2011) %>%
  mutate(class = as.numeric(class)) 

# pins that had incentive classes in 2022
incent_pins <- ptax_pins %>% 
  filter(class >= 600 & class <= 899 & year == 2022)

ptax_pins %>% 
  filter(pin %in% incent_pins$pin) %>% group_by(year, land_use) %>% summarize(pincount = n()) %>% filter(land_use == "Land") %>%
  arrange(year)

# use list of incent pins in 2022 to filter out the same pins in 2011 and group by land use or  major class
ptax_pins %>% filter(pin %in% incent_pins$pin & year == 2011) %>% group_by(major_class_code) %>%
  summarize(pincount = n())

ptax_pins %>% filter(pin %in% incent_pins$pin & year == 2011) %>% group_by(land_use) %>%
  summarize(pincount = n())

# how many were from amazon warehouse in Markham?
ptax_pins %>% filter(pin %in% incent_pins$pin & year == 2011 & clean_name %in% c("Markham", "Harvey")) %>% group_by(land_use) %>%
  summarize(pincount = n())
```


```{r}
table(ptax_pins$land_use)

ptax_pins <- ptax_pins %>%
  group_by(pin) %>%
  mutate(years_existed = n(),
         incentive_years = sum(incent_prop == "Incentive"), 
         
         landuse_change = ifelse(sum(land_use == "Commercial") == years_existed, "Always Commercial",
           ifelse(sum(land_use == "Industrial") == years_existed, "Always Industrial",
                  ifelse(sum(land_use == "Land") == years_existed, "Always Land",

                  "Changes Land Use"
                  ))) ) %>%
  ungroup() %>%
  mutate(incent_change = case_when(
    incentive_years == years_existed ~ "Always Incentive",
    incentive_years == 0 ~ "Never Incentive",
    TRUE ~ "Changes Sometime"))
  
ptax_pins %>% filter(year == 2022) %>%
  group_by(landuse_change, incent_change) %>%
  summarize(Pin_Count = n())
```

4,362 PINs began as land (without buildings).

2,721 PINs began as vacant and existed as Land in 2022.

```{r}
ptax_pins %>% filter()

began_vacant <- ptax_pins %>% 
  group_by(pin) %>%
  mutate(years_existed = n(),
         began_vacant = ifelse(land_use == "Land", 1, 0),
         always_vacant = ifelse(sum(land_use == "Land") == years_existed, 1, 0)) %>%
  filter(began_vacant == 1 & year == 2011)

vacant_ever <- ptax_pins %>% filter(land_use == "Land")

# number of years that a pin was vacant
# and then number of pins that were vacant a certain number of years
ptax_pins %>% 
  filter(pin %in% vacant_ever$pin) %>% 
  group_by(pin) %>%
  summarize(years_vacant = sum(ifelse(land_use == "Land",1,0) )) %>% 
  arrange(desc(years_vacant)) %>%
  ungroup() %>%
  group_by(years_vacant) %>%
  summarize(pincount = n())
```


```{r}
# pins that started as vacant and changed use
vacant_changed <- ptax_pins %>% 
  group_by(pin) %>%
  filter(pin %in% began_vacant$pin) %>% # keeps PINs that were Land in the first year of the data
  mutate(always_vacant = ifelse(sum(land_use == "Land") == years_existed, 1, 0)) %>%
  filter(always_vacant == 0 & year == 2022)


vacant_changed %>% 
  group_by(land_use, incent_prop) %>% 
  summarize(count =n())

vacant_changed %>% 
  group_by(major_class_code) %>% 
  summarize(count =n())

vacant_changed %>% 
  group_by(incent_prop) %>% 
  summarize(count =n())

```

```{r mvh_email_stats}
ptax_pins_mvh <- ptax_pins |>
 mutate(land_use = as.factor(land_use),
       incent_prop = as.factor(incent_prop)) |>
  mutate(year = as.factor(year)) |>
  arrange(year) |>
  group_by(pin) |>
  mutate(lag_land = ifelse(lag(land_use) == "Land", 1, 0),
         lag_incent = ifelse(lag(incent_prop) == "Incentive", 1, 0), # lagged incent_prop
         lag_lag_incent = lag(lag_incent) # two year lagged incent_prop
         ) |>
  ungroup() |>
  mutate(lag_land = as.factor(lag_land),
         lag_incent = as.factor(lag_incent),
         lag_lag_incent = as.factor(lag_lag_incent)) |>
  # This line checks for flips!
  mutate(build_land = ifelse(lag_land == "1" & land_use != "Land", 1, 0),
         gain_incent = ifelse(lag_incent == "0" & incent_prop == "Incentive", 1, 0),
         gain_incent_lag = ifelse(lag_lag_incent == "0" & lag_incent == "1", 1, 0) ## Changed this line
         ) |>
  # change to factors
  mutate(build_land = as.factor(build_land),
         gain_incent = as.factor(gain_incent),
         gain_incent_lag = as.factor(gain_incent_lag)) |>
  # Condense Variables
  mutate(build_incent = ifelse((gain_incent == "1" & build_land == "1"), 1, 0),
         build_incent_lag = ifelse(gain_incent_lag == "1" & build_land == "1", 1, 0)
         ) |>
  mutate(build_incent = as.factor(build_incent),
         build_incent_lag = as.factor(build_incent_lag)) |>
  filter(year > 2012)

table(ptax_pins_mvh$build_land)
table(ptax_pins_mvh$gain_incent_lag)
table(ptax_pins_mvh$build_incent)
table(ptax_pins_mvh$build_incent_lag)



ptax_pins_mvh_final <- ptax_pins_mvh |>
  select(year, build_land, gain_incent, gain_incent_lag, build_incent, build_incent_lag) |>
  group_by(year) |>
  summarize("New Construction w/ Incentive" = sum(build_incent == "1", na.rm = T), 
            "New Construction w/ Lagged Incentive" = sum(build_incent_lag == "1", na.rm = T),
            "New Construction" = sum(build_land == "1", na.rm = T), 
            "Gained Incentive" = sum(gain_incent == "1", na.rm = T), 
            "Lagged gained incentive" = sum(gain_incent_lag == "1", na.rm = T), 
            )

ptax_pins_mvh_final

```
